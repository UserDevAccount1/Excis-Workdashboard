<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ticket Distribution System - Enhanced Matching Matrix</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #7c3aed;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --light: #f8fafc;
            --dark: #1e293b;
            --gray: #64748b;
            --gray-light: #e2e8f0;
            --border-radius: 10px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --transition: all 0.3s ease;
            --band-blue: #102a43;
            --band-light-blue: #243b53;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e3e8f0 100%);
            color: var(--dark);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            background: white;
            border-radius: var(--border-radius);
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: var(--shadow);
            border-left: 5px solid var(--primary);
        }

        .header h1 {
            color: var(--dark);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header h1 i {
            color: var(--primary);
        }

        .subtitle {
            color: var(--gray);
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        /* Controls Panel */
        .controls-panel {
            background: white;
            border-radius: var(--border-radius);
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: var(--shadow);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .control-label {
            font-weight: 600;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-input {
            padding: 10px 15px;
            border: 2px solid var(--gray-light);
            border-radius: 6px;
            font-size: 0.95rem;
            transition: var(--transition);
        }

        .control-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        select.control-input {
            background: white;
            cursor: pointer;
        }

        /* Mode Toggle */
        .mode-toggle-container {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: var(--light);
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .toggle-label {
            font-weight: 500;
            color: var(--dark);
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--success);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(30px);
        }

        /* Matrix Container */
        .matrix-container {
            border: 1px solid var(--gray-light);
            border-radius: 8px;
            overflow: auto;
            max-height: 700px;
            background: white;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .matrix-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 2000px;
        }

        .matrix-table th {
            background: var(--dark);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            min-width: 180px;
            border-right: 1px solid var(--gray);
        }

        .matrix-table th:first-child {
            position: sticky;
            left: 0;
            background: var(--dark);
            z-index: 20;
            min-width: 250px;
        }

        .matrix-table td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--gray-light);
            border-right: 1px solid var(--gray-light);
            background: white;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            transition: var(--transition);
        }

        .matrix-table td:first-child {
            position: sticky;
            left: 0;
            background: var(--light);
            font-weight: 500;
            z-index: 5;
            min-width: 250px;
        }

        .matrix-table tr:hover td {
            background: #f8fafc;
        }

        .matrix-table tr:hover td:first-child {
            background: #e2e8f0;
        }

        /* Cell Styles - ALL EDITABLE */
        .cell-input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid var(--gray-light);
            border-radius: 4px;
            font-size: 0.9rem;
            transition: var(--transition);
            background: white;
        }

        .cell-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
            background: #f8fafc;
        }

        .cell-input.non-existent {
            background: #fef2f2;
            border-color: #fecaca;
            color: #dc2626;
            opacity: 0.7;
        }

        .cell-input.non-existent:focus {
            background: #fef2f2;
            border-color: #f87171;
        }

        .cell-check {
            color: var(--success);
            font-weight: bold;
            text-align: center;
        }

        .cell-cross {
            color: var(--danger);
            font-weight: bold;
            text-align: center;
        }

        .cell-data-input {
            width: 100%;
            border: 1px solid var(--gray-light);
            border-radius: 4px;
            background: white;
            color: var(--dark);
            font-size: 0.9rem;
            padding: 6px 8px;
            transition: var(--transition);
        }

        .cell-data-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
            background: #f8fafc;
        }

        .cell-data {
            color: var(--dark);
            font-size: 0.9rem;
        }

        /* Highlighting */
        .highlight-column {
            background: #d1fae5 !important;
        }

        .highlight-duplicate {
            background: #fef3c7 !important;
            border: 1px solid #f59e0b !important;
        }

        .highlight-match {
            background: #e0f2fe !important;
            border: 1px solid var(--info) !important;
        }

        .highlight-smart-add {
            animation: pulse 0.5s ease;
            background: #f0f9ff !important;
        }

        .highlight-required {
            background: linear-gradient(45deg, #fef3c7, #fde68a) !important;
            border-left: 3px solid var(--warning) !important;
        }

        .highlight-final-table {
            background: linear-gradient(45deg, #d1fae5, #a7f3d0) !important;
            border-left: 3px solid var(--success) !important;
        }

        .highlight-band-table {
            background: linear-gradient(45deg, #e0f2fe, #bae6fd) !important;
            border-left: 3px solid var(--primary) !important;
        }

        @keyframes pulse {
            0% { background: white; }
            50% { background: #dbeafe; }
            100% { background: #f0f9ff; }
        }

        /* RAG Status Colors */
        .rag-green {
            color: var(--success);
        }

        .rag-amber {
            color: var(--warning);
        }

        .rag-red {
            color: var(--danger);
        }

        /* Matrix Stats */
        .matrix-stats {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            padding: 15px;
            background: var(--light);
            border-radius: 8px;
            font-size: 0.9rem;
            flex-wrap: wrap;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 20px;
            background: white;
            border-radius: 6px;
            min-width: 100px;
            box-shadow: var(--shadow);
        }

        .stat-value {
            font-weight: 700;
            font-size: 1.2rem;
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--gray);
            text-align: center;
        }

        /* Matrix Legend */
        .matrix-legend {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border: 1px solid var(--gray-light);
            font-size: 0.85rem;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 3px;
        }

        .legend-check {
            background: var(--success);
        }

        .legend-cross {
            background: var(--danger);
        }

        .legend-highlight {
            background: #d1fae5;
        }

        .legend-duplicate {
            background: #fef3c7;
        }

        .legend-match {
            background: #e0f2fe;
        }

        .legend-smart-add {
            background: #f0f9ff;
        }

        .legend-required {
            background: linear-gradient(45deg, #fef3c7, #fde68a);
        }

        .legend-band {
            background: linear-gradient(45deg, #e0f2fe, #bae6fd);
        }

        /* Search Bar */
        .search-container {
            position: relative;
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 15px 20px 15px 50px;
            border: 2px solid var(--gray-light);
            border-radius: 8px;
            font-size: 1rem;
            transition: var(--transition);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
        }

        /* Smart Add Indicator */
        .smart-add-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--success);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: var(--shadow-lg);
            z-index: 100;
            display: none;
        }

        /* Final Table Preview */
        .final-table-preview {
            background: white;
            border-radius: var(--border-radius);
            padding: 25px;
            margin-top: 30px;
            box-shadow: var(--shadow);
        }

        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--gray-light);
        }

        .preview-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
        }

        .preview-item {
            background: var(--light);
            padding: 12px 15px;
            border-radius: 6px;
            border: 1px solid var(--gray-light);
        }

        .preview-field {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .preview-value {
            color: var(--gray);
            font-size: 0.85rem;
            word-break: break-word;
        }

        /* Export Buttons */
        .export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .export-btn {
            padding: 8px 16px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            transition: var(--transition);
        }

        .export-btn:hover {
            background: var(--primary-dark);
        }

        .export-btn.excel {
            background: var(--success);
        }

        .export-btn.pdf {
            background: var(--danger);
        }

        .export-btn.band {
            background: var(--secondary);
        }

        /* Validation Styles */
        .validation-error {
            border-color: var(--danger) !important;
            background: #fee2e2 !important;
        }

        .validation-success {
            border-color: var(--success) !important;
            background: #d1fae5 !important;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .controls-panel {
                grid-template-columns: 1fr;
            }
           
            .matrix-stats {
                justify-content: center;
            }
           
            .matrix-legend {
                justify-content: center;
            }
           
            .preview-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Advanced Filter Panel */
        .advanced-filters {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            display: none;
        }

        .advanced-filters.active {
            display: block;
        }

        .advanced-toggle {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        /* Bulk Input Modal */
        .bulk-input-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .bulk-input-modal.active {
            display: flex;
        }

        .bulk-input-content {
            background: white;
            padding: 30px;
            border-radius: var(--border-radius);
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .bulk-textarea {
            width: 100%;
            height: 300px;
            padding: 15px;
            border: 2px solid var(--gray-light);
            border-radius: 6px;
            font-family: monospace;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        /* Sample Data Input Section */
        .sample-data-panel {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-top: 20px;
            box-shadow: var(--shadow);
        }

        .sample-data-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--gray-light);
        }

        .sample-data-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .input-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .input-field {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--gray-light);
            border-radius: 4px;
        }

        .btn-add {
            background: var(--success);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .action-btn {
            padding: 8px 15px;
            background: var(--info);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.85rem;
        }

        /* Editable Cell Indicator */
        .editable-indicator {
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 0.7rem;
            color: var(--gray);
            opacity: 0.7;
        }

        /* Band Details Styles */
        .band-indicator {
            position: absolute;
            top: 5px;
            right: 5px;
            background: var(--secondary);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            cursor: pointer;
            z-index: 2;
        }

        .cell-with-band {
            position: relative;
        }

        .matrix-cell-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 5px;
        }

        .cell-value {
            flex: 1;
            min-width: 0;
        }

        .cell-band-btn {
            background: transparent;
            border: none;
            color: var(--secondary);
            cursor: pointer;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 0.8rem;
            flex-shrink: 0;
        }

        .cell-band-btn:hover {
            background: rgba(124, 58, 237, 0.1);
        }

        /* Band Details Modal */
        .band-details-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .band-details-modal.active {
            display: flex;
        }

        .band-details-content {
            background: white;
            padding: 30px;
            border-radius: var(--border-radius);
            max-width: 900px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .band-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--gray-light);
        }

        .band-header h3 {
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .band-table-container {
            overflow-x: auto;
            margin: 15px 0;
        }

        .band-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .band-table th {
            background: var(--band-blue);
            color: white;
            padding: 12px;
            text-align: center;
            font-weight: 600;
            border-right: 1px solid var(--gray);
        }

        .band-table tr.rc-band-group th {
            background: var(--band-blue);
            color: #fff;
            text-align: center;
        }

        .band-table tr.rc-band-sub th {
            background: var(--band-light-blue);
            color: #fff;
            text-align: center;
            font-weight: 600;
        }

        .band-table td {
            padding: 10px;
            border: 1px solid var(--gray-light);
            text-align: center;
        }

        .band-table tr:hover td {
            background: #f8fafc;
        }

        .band-groups {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .band-group-card {
            background: var(--light);
            border: 1px solid var(--gray-light);
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: var(--transition);
        }

        .band-group-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
            border-color: var(--primary);
        }

        .band-group-card.active {
            background: #e0f2fe;
            border-color: var(--primary);
        }

        .band-group-title {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .band-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .band-tag {
            background: white;
            border: 1px solid var(--gray-light);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .band-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--gray-light);
        }

        .band-details-section {
            background: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid var(--primary);
        }

        /* Quick View Band Popup */
        .band-quick-view {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            z-index: 1500;
            max-width: 400px;
            display: none;
            border-left: 4px solid var(--secondary);
        }

        .band-quick-view.active {
            display: block;
        }

        .band-quick-view-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .band-quick-view-close {
            background: none;
            border: none;
            color: var(--gray);
            cursor: pointer;
            font-size: 1.2rem;
        }

        /* Band Quick Actions Panel */
        .band-quick-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: var(--light);
            border-radius: 8px;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1><i class="fas fa-table"></i> Enhanced Matching Matrix - Ticket Distribution System</h1>
            <p class="subtitle">8-Table Real-Time Auto-Population with Band Details Feature</p>
            <p style="color: var(--gray); font-size: 0.95rem;">
                ALL cells are editable - Special Band Details for Dispatch, Dedicated & Project tables
            </p>
        </div>

        <!-- Search Bar -->
        <div class="search-container">
            <i class="fas fa-search search-icon"></i>
            <input type="text" class="search-input" id="searchInput"
                   placeholder="Search columns, tables, or values... (Press Enter to highlight matches)">
        </div>

        <!-- Advanced Filters Toggle -->
        <button class="advanced-toggle" onclick="toggleAdvancedFilters()">
            <i class="fas fa-sliders-h"></i> Advanced Filters & Settings
        </button>

        <!-- Advanced Filters Panel -->
        <div class="advanced-filters" id="advancedFilters">
            <div class="filter-row">
                <div class="control-group">
                    <label class="control-label"><i class="fas fa-palette"></i> Highlight Mode</label>
                    <select class="control-input" id="highlightMode" onchange="applyHighlighting()">
                        <option value="NONE">No Highlighting</option>
                        <option value="SOURCE_TABLE">Highlight by Source Table</option>
                        <option value="DATA_TYPE">Highlight by Data Type</option>
                        <option value="REQUIRED_STATUS">Required/Optional</option>
                        <option value="RAG_STATUS">RAG Status</option>
                        <option value="AUTO_POP">Auto-populated Fields</option>
                        <option value="VALIDATION">Validation Status</option>
                        <option value="EMPTY">Empty Fields</option>
                        <option value="NON_EXISTENT">Non-existent Fields</option>
                        <option value="BAND_TABLES">Tables with Band Details</option>
                    </select>
                </div>

                <div class="control-group">
                    <label class="control-label"><i class="fas fa-eye"></i> Display Options</label>
                    <select class="control-input" id="displayOptions" onchange="applyDisplayOptions()">
                        <option value="SHOW_DATA">Show Data Values</option>
                        <option value="SHOW_TYPE">Show Data Types</option>
                        <option value="SHOW_SOURCE">Show Source Table</option>
                        <option value="SHOW_TRANSFORMATION">Show Transformation Logic</option>
                        <option value="SHOW_VALIDATION">Show Validation Rules</option>
                    </select>
                </div>

                <div class="control-group">
                    <label class="control-label"><i class="fas fa-layer-group"></i> Display Mode</label>
                    <select class="control-input" id="displayMode" onchange="applyDisplayMode()">
                        <option value="FLAT">Flat List</option>
                        <option value="GROUPED">Grouped by Category</option>
                        <option value="TABLE_WISE">Grouped by Table</option>
                        <option value="COMPACT">Compact View</option>
                        <option value="EXPANDED">Expanded View</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- ENHANCED CONTROLS PANEL -->
        <div class="controls-panel">
            <div class="control-group">
                <label class="control-label"><i class="fas fa-table"></i> Table Filter</label>
                <select class="control-input" id="tableFilter" onchange="applyFilters()">
                    <option value="SHOW_ALL">Show All Tables</option>
                    <option value="TICKET_DATA">Ticket Data Only</option>
                    <option value="RATE_CARD">Service Rate Card Only</option>
                    <option value="DISPATCH">Dispatch Only</option>
                    <option value="STANDBY">Standby Only</option>
                    <option value="DEDICATED">Dedicated Only</option>
                    <option value="SV_VISIT">SV Visit Only</option>
                    <option value="PROJECT">Project Only</option>
                    <option value="FINAL_TABLE">Final Table Only</option>
                    <option value="CUSTOM_COMBO">Custom Combination</option>
                    <option value="BAND_TABLES">Tables with Band Details</option>
                </select>
            </div>

            <div class="control-group">
                <label class="control-label"><i class="fas fa-tags"></i> Field Group</label>
                <select class="control-input" id="fieldGroupFilter" onchange="applyFilters()">
                    <option value="ALL">All Groups</option>
                    <option value="BASIC_INFO">Basic Information</option>
                    <option value="GEOGRAPHIC">Geographic Details</option>
                    <option value="SERVICE">Service Details</option>
                    <option value="TECHNICIAN">Technician & Time</option>
                    <option value="FINANCIAL">Financial Summary</option>
                    <option value="QUALITY">Quality & SLA</option>
                    <option value="RATES">Rate Card Fields</option>
                    <option value="PROJECT">Project Specific</option>
                    <option value="STAND_BY">Stand-by Specific</option>
                    <option value="BAND_DETAILS">Band Details</option>
                </select>
            </div>

            <div class="control-group">
                <label class="control-label"><i class="fas fa-sort"></i> Sort Order</label>
                <select class="control-input" id="sortOrder" onchange="applyFilters()">
                    <option value="ALPHABETICAL_ASC">A → Z</option>
                    <option value="ALPHABETICAL_DESC">Z → A</option>
                    <option value="TABLE_ORDER">Original Table Order</option>
                    <option value="REQUIRED_FIRST">Required Fields First</option>
                    <option value="MANDATORY_FIRST">Mandatory for Final First</option>
                    <option value="FREQUENCY">Most Common First</option>
                    <option value="DATA_TYPE">Group by Data Type</option>
                    <option value="FIELD_GROUP">Group by Field Category</option>
                    <option value="LAST_MODIFIED">Recently Modified First</option>
                </select>
            </div>

            <div class="control-group">
                <label class="control-label"><i class="fas fa-mode"></i> Input Mode</label>
                <select class="control-input" id="inputMode" onchange="handleInputMode()">
                    <option value="NORMAL">Normal Mode</option>
                    <option value="FINAL_TABLE">Final Table Centric</option>
                    <option value="TABLE_SPECIFIC">Table-Specific</option>
                    <option value="SITE_CATEGORY">Site Category Based</option>
                    <option value="BULK">Smart Bulk Input</option>
                    <option value="VALIDATION_FIRST">Validation-First Input</option>
                    <option value="BAND_MODE">Band Details Mode</option>
                </select>
            </div>

            <div class="control-group">
                <label class="control-label"><i class="fas fa-flag"></i> RAG Status</label>
                <select class="control-input" id="ragFilter" onchange="applyFilters()">
                    <option value="ALL">All Fields</option>
                    <option value="REQUIRED">Mandatory Only</option>
                    <option value="OPTIONAL">Optional Only</option>
                    <option value="GREEN">Green (Standard)</option>
                    <option value="AMBER">Amber (Special)</option>
                    <option value="RED">Red (Critical)</option>
                </select>
            </div>

            <div class="control-group">
                <label class="control-label"><i class="fas fa-filter"></i> Data Type</label>
                <select class="control-input" id="dataTypeFilter" onchange="applyFilters()">
                    <option value="ALL">All Types</option>
                    <option value="TEXT">Text</option>
                    <option value="NUMBER">Number</option>
                    <option value="CURRENCY">Currency</option>
                    <option value="DATE">Date</option>
                    <option value="TIME">Time</option>
                    <option value="BOOLEAN">Yes/No</option>
                    <option value="DROPDOWN">Dropdown</option>
                    <option value="PERCENTAGE">Percentage</option>
                </select>
            </div>

            <div class="control-group">
                <label class="control-label"><i class="fas fa-eye"></i> Options</label>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <label><input type="checkbox" id="showRequiredOnly" onchange="applyFilters()"> Required Only</label>
                    <label><input type="checkbox" id="showEmptyOnly" onchange="applyFilters()"> Empty Fields</label>
                    <label><input type="checkbox" id="showTransformation" onchange="applyFilters()"> Show Transformation</label>
                    <label><input type="checkbox" id="showBandDetails" onchange="toggleBandDetails()"> Show Band Details</label>
                </div>
            </div>

            <div class="control-group">
                <button class="control-input" style="background:var(--primary);color:white;cursor:pointer;" onclick="resetFilters()">
                    <i class="fas fa-sync"></i> Reset All Filters
                </button>
                <button class="control-input" style="background:var(--secondary);color:white;cursor:pointer;margin-top:10px;" onclick="showBandDetailsModal()">
                    <i class="fas fa-layer-group"></i> View All Band Details
                </button>
                <button class="control-input" style="background:var(--success);color:white;cursor:pointer;margin-top:10px;" onclick="showBulkInputModal()">
                    <i class="fas fa-paste"></i> Bulk Input
                </button>
            </div>
        </div>

        <!-- Band Details Quick Actions -->
        <div class="band-quick-actions" id="bandQuickActions" style="display: none;">
            <button class="action-btn" onclick="showBandDetailsForTable('dispatch')">
                <i class="fas fa-truck-fast"></i> Dispatch Band Details
            </button>
            <button class="action-btn" onclick="showBandDetailsForTable('dedicated')">
                <i class="fas fa-user-tie"></i> Dedicated Band Details
            </button>
            <button class="action-btn" onclick="showBandDetailsForTable('project')">
                <i class="fas fa-project-diagram"></i> Project Band Details
            </button>
            <button class="action-btn" onclick="showBandDetailsForTable('all')">
                <i class="fas fa-layer-group"></i> All Band Structures
            </button>
            <button class="action-btn" onclick="generateBandData()">
                <i class="fas fa-magic"></i> Generate Band Data
            </button>
        </div>

        <!-- Site Category Filter (Hidden by default) -->
        <div class="control-group" id="siteCategoryGroup" style="display: none; margin-bottom: 20px;">
            <label class="control-label"><i class="fas fa-sitemap"></i> Site Category</label>
            <select class="control-input" id="siteCategory" onchange="filterBySiteCategory()">
                <option value="">All Categories</option>
                <option value="dispatch">Dispatch</option>
                <option value="dedicated">Dedicated</option>
                <option value="project">Project</option>
                <option value="sv">SV Visit</option>
                <option value="standby">Standby</option>
            </select>
        </div>

        <!-- Mode Toggle -->
        <div class="mode-toggle-container">
            <span class="toggle-label">Structural View (Column Existence)</span>
            <label class="toggle-switch">
                <input type="checkbox" id="matrixModeToggle" onchange="toggleMatrixMode()">
                <span class="toggle-slider"></span>
            </label>
            <span class="toggle-label">Data Preview Mode</span>
            <span style="margin-left: auto; font-size: 0.9rem; color: var(--gray);">
                <i class="fas fa-info-circle"></i> Smart Add Mode: <span id="smartAddStatus">ACTIVE</span>
                <span style="margin-left: 15px;">
                    <i class="fas fa-layer-group"></i> Band Details: 
                    <span id="bandStatus">READY</span>
                </span>
            </span>
        </div>

        <!-- Matrix Container -->
        <div class="matrix-container">
            <table class="matrix-table" id="matrixTable">
                <thead>
                    <tr id="matrixHeader">
                        <!-- Header will be populated by JavaScript -->
                    </tr>
                </thead>
                <tbody id="matrixBody">
                    <!-- Matrix rows will be populated by JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- Matrix Legend (Updated with Band Details) -->
        <div class="matrix-legend">
            <div class="legend-item">
                <div class="legend-color legend-check"></div>
                <span>Field exists in table</span>
            </div>
            <div class="legend-item">
                <div class="legend-color legend-cross"></div>
                <span>Field not in table (but editable)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color legend-highlight"></div>
                <span>Search match</span>
            </div>
            <div class="legend-item">
                <div class="legend-color legend-match"></div>
                <span>Matching field</span>
            </div>
            <div class="legend-item">
                <div class="legend-color legend-required"></div>
                <span>Required field</span>
            </div>
            <div class="legend-item">
                <div class="legend-color legend-smart-add"></div>
                <span>Smart Add triggered</span>
            </div>
            <div class="legend-item">
                <div class="legend-color legend-band"></div>
                <span>Tables with Band Details</span>
            </div>
            <div class="legend-item">
                <span class="rag-green">●</span>
                <span>Green (Standard)</span>
            </div>
            <div class="legend-item">
                <span class="rag-amber">●</span>
                <span>Amber (Special)</span>
            </div>
            <div class="legend-item">
                <span class="rag-red">●</span>
                <span>Red (Critical)</span>
            </div>
        </div>

        <!-- Matrix Statistics (Updated) -->
        <div class="matrix-stats">
            <div class="stat-item">
                <div class="stat-value" id="totalColumns">0</div>
                <div class="stat-label">Total Columns</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="commonColumns">0</div>
                <div class="stat-label">Common to All</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="uniqueColumns">0</div>
                <div class="stat-label">Unique Columns</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="requiredCount">0</div>
                <div class="stat-label">Required Fields</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="smartAddCount">0</div>
                <div class="stat-label">Smart Adds</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="autoPopulated">0</div>
                <div class="stat-label">Auto-Populated</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="bandTablesCount">3</div>
                <div class="stat-label">Band Tables</div>
            </div>
        </div>

        <!-- Smart Add Indicator -->
        <div class="smart-add-indicator" id="smartAddIndicator">
            <i class="fas fa-bolt"></i>
            <span id="smartAddText">Smart Add: Updating tables...</span>
        </div>

        <!-- Band Quick View -->
        <div class="band-quick-view" id="bandQuickView">
            <div class="band-quick-view-header">
                <h4 style="margin: 0; color: var(--primary);">
                    <i class="fas fa-layer-group"></i> <span id="quickViewTitle">Band Details</span>
                </h4>
                <button class="band-quick-view-close" onclick="closeQuickView()">&times;</button>
            </div>
            <div id="quickViewContent">
                <!-- Quick view content will be populated here -->
            </div>
        </div>

        <!-- Sample Data Input Section -->
        <div class="sample-data-panel">
            <div class="sample-data-header">
                <h3><i class="fas fa-database"></i> Sample Data Input & Testing</h3>
                <div class="quick-actions">
                    <button class="action-btn" onclick="loadSampleData('hcl')">
                        <i class="fas fa-building"></i> Load HCL Data
                    </button>
                    <button class="action-btn" onclick="loadSampleData('fresenius')">
                        <i class="fas fa-hospital"></i> Load Fresenius Data
                    </button>
                    <button class="action-btn" onclick="clearAllData()">
                        <i class="fas fa-trash"></i> Clear All Data
                    </button>
                    <button class="action-btn" onclick="generateRandomData()">
                        <i class="fas fa-random"></i> Generate Random Data
                    </button>
                    <button class="action-btn" onclick="generateBandData()">
                        <i class="fas fa-layer-group"></i> Generate Band Data
                    </button>
                </div>
            </div>
           
            <div class="sample-data-controls">
                <div class="control-group">
                    <label class="control-label"><i class="fas fa-users"></i> Customer</label>
                    <select class="control-input" id="customerSelect" onchange="updateMatrixData()">
                        <option value="hcl">HCL Technologies</option>
                        <option value="fresenius">Fresenius Medical</option>
                        <option value="acme">Acme Corporation</option>
                        <option value="custom">Custom Customer</option>
                    </select>
                </div>
               
                <div class="control-group">
                    <label class="control-label"><i class="fas fa-building"></i> Account</label>
                    <select class="control-input" id="accountSelect" onchange="updateMatrixData()">
                        <option value="rev">Revenue Account</option>
                        <option value="prod">Production Account</option>
                        <option value="test">Test Account</option>
                        <option value="custom">Custom Account</option>
                    </select>
                </div>
               
                <div class="control-group">
                    <label class="control-label"><i class="fas fa-bolt"></i> Smart Add Mode</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="smartAddToggle" checked onchange="toggleSmartAdd()">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="control-group">
                    <label class="control-label"><i class="fas fa-layer-group"></i> Band Preview</label>
                    <select class="control-input" id="bandPreviewSelect" onchange="showBandQuickPreview()">
                        <option value="">Select Band Type...</option>
                        <option value="dedicated">Dedicated Services</option>
                        <option value="dispatch">Dispatch Services</option>
                        <option value="project">Project Bands</option>
                        <option value="all">All Band Structures</option>
                    </select>
                </div>
            </div>
           
            <!-- Quick Data Input -->
            <div style="margin-top: 20px; padding: 15px; background: var(--light); border-radius: 8px;">
                <h4 style="margin-bottom: 10px; color: var(--dark);">
                    <i class="fas fa-edit"></i> Quick Data Input
                </h4>
                <div class="input-row">
                    <input type="text" id="quickField" class="input-field" placeholder="Field Name (e.g., Customer Name)">
                    <input type="text" id="quickValue" class="input-field" placeholder="Value (e.g., HCL Technologies)">
                    <select id="quickTable" class="input-field">
                        <option value="all">All Tables</option>
                        <option value="ticket">Ticket Data</option>
                        <option value="rate">Rate Card</option>
                        <option value="dispatch">Dispatch</option>
                        <option value="standby">Standby</option>
                        <option value="dedicated">Dedicated</option>
                        <option value="sv">SV Visit</option>
                        <option value="project">Project</option>
                    </select>
                    <button class="btn-add" onclick="addQuickData()">
                        <i class="fas fa-plus"></i> Add Data
                    </button>
                </div>
                <p style="font-size: 0.8rem; color: var(--gray); margin-top: 10px;">
                    <i class="fas fa-info-circle"></i> Enter field name and value to test auto-population across tables
                </p>
            </div>
        </div>

        <!-- Final Table Preview -->
        <div class="final-table-preview">
            <div class="preview-header">
                <div class="preview-title">
                    <i class="fas fa-ticket-alt"></i>
                    Final Ticket Data Table Preview
                    <span style="font-size: 0.8rem; color: var(--gray); margin-left: 10px;">
                        (Auto-generated from all tables)
                    </span>
                </div>
                <div class="export-buttons">
                    <button class="export-btn" onclick="validateAllFields()">
                        <i class="fas fa-check-circle"></i> Validate All Fields
                    </button>
                    <button class="export-btn excel" onclick="exportToExcel()">
                        <i class="fas fa-file-excel"></i> Export Excel
                    </button>
                    <button class="export-btn pdf" onclick="exportToPDF()">
                        <i class="fas fa-file-pdf"></i> Export PDF
                    </button>
                    <button class="export-btn" onclick="exportValidationReport()">
                        <i class="fas fa-clipboard-check"></i> Validation Report
                    </button>
                    <button class="export-btn band" onclick="exportBandReport()">
                        <i class="fas fa-layer-group"></i> Band Report
                    </button>
                </div>
            </div>
            <div class="preview-grid" id="finalTablePreview">
                <!-- Final table data will be populated here -->
            </div>
        </div>
    </div>

    <!-- Band Details Modal -->
    <div class="band-details-modal" id="bandDetailsModal">
        <div class="band-details-content">
            <div class="band-header">
                <h3><i class="fas fa-layer-group"></i> <span id="bandModalTitle">Band Details</span></h3>
                <button class="iconbtn" onclick="closeBandDetailsModal()">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
            <div id="bandModalContent">
                <!-- Band details content will be populated here -->
            </div>
            <div class="band-actions">
                <button class="btn" onclick="exportBandToCSV()">
                    <i class="fas fa-file-csv"></i> Export to CSV
                </button>
                <button class="btn primary" onclick="applyBandToMatrix()">
                    <i class="fas fa-table"></i> Apply to Matrix
                </button>
                <button class="btn" onclick="closeBandDetailsModal()">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
    </div>

    <!-- Bulk Input Modal -->
    <div class="bulk-input-modal" id="bulkInputModal">
        <div class="bulk-input-content">
            <h3><i class="fas fa-paste"></i> Bulk Input Mode</h3>
            <p style="color: var(--gray); margin-bottom: 15px;">
                Paste data from Excel (CSV format) or enter multiple values separated by commas or tabs.
            </p>
            <textarea class="bulk-textarea" id="bulkTextarea" placeholder="Paste your data here...
Format: Field Name, Value, Table
Example:
Customer Name, HCL Technologies, all
Country, India, all
PO Number, INDOPO-6502, ticket"></textarea>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="export-btn" onclick="processBulkInput()">
                    <i class="fas fa-play"></i> Process Bulk Input
                </button>
                <button class="export-btn" style="background: var(--gray);" onclick="closeBulkInputModal()">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button class="export-btn" onclick="downloadTemplate()">
                    <i class="fas fa-download"></i> Download Template
                </button>
            </div>
        </div>
    </div>

    <script>
        // Complete System Data for 8 Tables (including Final Table)
        const systemData = {
            tables: [
                {
                    id: 1,
                    name: "Ticket Data Built-up",
                    key: "ticket",
                    description: "Primary service ticket entry point with RAG status indicators",
                    color: "#2563eb",
                    icon: "fa-clipboard-list",
                    hasBandDetails: false,
                    columns: [
                        { name: "Site Category", type: "dropdown", required: true, group: "basic", rag: "green", requiredForFinal: true },
                        { name: "Customer Name", type: "text", required: true, group: "basic", rag: "green", requiredForFinal: true },
                        { name: "Partner Name", type: "text", required: true, group: "basic", rag: "green", requiredForFinal: false },
                        { name: "Customer Ticket Number", type: "text", required: true, group: "basic", rag: "green", requiredForFinal: true },
                        { name: "Customer Ticket Created Date", type: "date", required: true, group: "basic", rag: "green", requiredForFinal: false },
                        { name: "Partner Ticket Number", type: "text", required: true, group: "basic", rag: "green", requiredForFinal: false },
                        { name: "Source of Request", type: "text", required: true, group: "basic", rag: "green", requiredForFinal: false },
                        { name: "PO number", type: "text", required: false, group: "basic", rag: "amber", requiredForFinal: true },
                        { name: "Country", type: "text", required: true, group: "geographic", rag: "green", requiredForFinal: true },
                        { name: "State", type: "text", required: false, group: "geographic", rag: "amber", requiredForFinal: false },
                        { name: "City", type: "text", required: true, group: "geographic", rag: "green", requiredForFinal: true },
                        { name: "Site Address", type: "text", required: false, group: "geographic", rag: "amber", requiredForFinal: true },
                        { name: "Zip code", type: "text", required: false, group: "geographic", rag: "amber", requiredForFinal: false },
                        { name: "Activity Details", type: "text", required: true, group: "service", rag: "green", requiredForFinal: true },
                        { name: "Dispatch Category", type: "dropdown", required: false, group: "service", rag: "green", requiredForFinal: false },
                        { name: "Ticket Priority", type: "dropdown", required: true, group: "service", rag: "green", requiredForFinal: true },
                        { name: "ETA Date", type: "date", required: true, group: "service", rag: "green", requiredForFinal: true },
                        { name: "ETA Time", type: "time", required: true, group: "service", rag: "green", requiredForFinal: true },
                        { name: "Technician Name", type: "text", required: true, group: "technician", rag: "green", requiredForFinal: true },
                        { name: "Technician IN Date", type: "date", required: true, group: "technician", rag: "green", requiredForFinal: false },
                        { name: "Technician IN Time", type: "time", required: true, group: "technician", rag: "green", requiredForFinal: false },
                        { name: "Technician OUT Date", type: "date", required: true, group: "technician", rag: "green", requiredForFinal: false },
                        { name: "Technician OUT Time", type: "time", required: true, group: "technician", rag: "green", requiredForFinal: false },
                        { name: "Total Hours", type: "number", required: true, group: "technician", rag: "green", requiredForFinal: true },
                        { name: "Currency", type: "dropdown", required: true, group: "financial", rag: "green", requiredForFinal: true },
                        { name: "Regular Rate", type: "currency", required: false, group: "financial", rag: "amber", requiredForFinal: false },
                        { name: "Overtime Rate", type: "currency", required: false, group: "financial", rag: "amber", requiredForFinal: false },
                        { name: "Weekend Rate", type: "currency", required: false, group: "financial", rag: "amber", requiredForFinal: false },
                        { name: "Travel Rate", type: "currency", required: false, group: "financial", rag: "amber", requiredForFinal: false },
                        { name: "Total Cost", type: "currency", required: true, group: "financial", rag: "amber", requiredForFinal: true },
                        { name: "Remarks", type: "text", required: false, group: "quality", rag: "green", requiredForFinal: false }
                    ]
                },
                {
                    id: 2,
                    name: "Service Rate Card",
                    key: "rate",
                    description: "Master rate reference for all services",
                    color: "#7c3aed",
                    icon: "fa-credit-card",
                    hasBandDetails: false,
                    columns: [
                        { name: "Customer", type: "text", required: true, group: "basic", rag: "green", requiredForFinal: true },
                        { name: "Region", type: "text", required: true, group: "geographic", rag: "green", requiredForFinal: false },
                        { name: "Country", type: "text", required: true, group: "geographic", rag: "green", requiredForFinal: true },
                        { name: "Supplier", type: "text", required: true, group: "basic", rag: "green", requiredForFinal: false },
                        { name: "Currency", type: "dropdown", required: true, group: "financial", rag: "green", requiredForFinal: true },
                        { name: "Category", type: "dropdown", required: true, group: "basic", rag: "amber", requiredForFinal: true },
                        { name: "SR Region", type: "text", required: true, group: "geographic", rag: "green", requiredForFinal: false },
                        { name: "Rate Type", type: "dropdown", required: true, group: "financial", rag: "amber", requiredForFinal: true },
                        { name: "Rate Value", type: "currency", required: true, group: "financial", rag: "red", requiredForFinal: true },
                        { name: "After Hours", type: "currency", required: true, group: "financial", rag: "amber", requiredForFinal: false },
                        { name: "Weekend", type: "currency", required: true, group: "financial", rag: "amber", requiredForFinal: false },
                        { name: "Travel", type: "currency", required: true, group: "financial", rag: "amber", requiredForFinal: false },
                        { name: "Includes Travel", type: "boolean", required: true, group: "financial", rag: "green", requiredForFinal: false }
                    ]
                },
                {
                    id: 3,
                    name: "Dispatch Table",
                    key: "dispatch",
                    description: "For on-demand service dispatches",
                    color: "#10b981",
                    icon: "fa-truck-fast",
                    hasBandDetails: true,
                    bandType: "dispatch",
                    columns: [
                        { name: "Site Category", type: "dropdown", required: true, group: "basic", rag: "green", requiredForFinal: true },
                        { name: "Customer Name", type: "text", required: true, group: "basic", rag: "green", requiredForFinal: true },
                        { name: "Partner Name", type: "text", required: true, group: "basic", rag: "green", requiredForFinal: false },
                        { name: "Customer Ticket Number", type: "text", required: true, group: "basic", rag: "green", requiredForFinal: true },
                        { name: "Customer Ticket Created Date", type: "date", required: true, group: "basic", rag: "green", requiredForFinal: false },
                        { name: "Partner Ticket Number", type: "text", required: true, group: "basic", rag: "green", requiredForFinal: false },
                        { name: "Source of Request", type: "text", required: true, group: "basic", rag: "green", requiredForFinal: false },
                        { name: "PO number", type: "text", required: false, group: "basic", rag: "amber", requiredForFinal: true },
                        { name: "Country", type: "text", required: true, group: "geographic", rag: "green", requiredForFinal: true },
                        { name: "State", type: "text", required: false, group: "geographic", rag: "amber", requiredForFinal: false },
                        { name: "City", type: "text", required: true, group: "geographic", rag: "green", requiredForFinal: true },
                        { name: "Site Address", type: "text", required: false, group: "geographic", rag: "amber", requiredForFinal: true },
                        { name: "Zip code", type: "text", required: false, group: "geographic", rag: "amber", requiredForFinal: false },
                        { name: "Activity Details", type: "text", required: true, group: "service", rag: "green", requiredForFinal: true },
                        { name: "Dispatch Category", type: "dropdown", required: true, group: "service", rag: "green", requiredForFinal: false },
                        { name: "Ticket Priority", type: "dropdown", required: true, group: "service", rag: "green", requiredForFinal: true },
                        { name: "ETA Date", type: "date", required: true, group: "service", rag: "green", requiredForFinal: true },
                        { name: "ETA Time", type: "time", required: true, group: "service", rag: "green", requiredForFinal: true },
                        { name: "Technician Name", type: "text", required: true, group: "technician", rag: "green", requiredForFinal: true },
                        { name: "Technician IN Date", type: "date", required: true, group: "technician", rag: "green", requiredForFinal: false },
                        { name: "Technician IN Time", type: "time", required: true, group: "technician", rag: "green", requiredForFinal: false },
                        { name: "Technician OUT Date", type: "date", required: true, group: "technician", rag: "green", requiredForFinal: false },
                        { name: "Technician OUT Time", type: "time", required: true, group: "technician", rag: "green", requiredForFinal: false },
                        { name: "Total Hours", type: "number", required: true, group: "technician", rag: "green", requiredForFinal: true },
                        { name: "Currency", type: "dropdown", required: true, group: "financial", rag: "green", requiredForFinal: true },
                        { name: "Regular Rate", type: "currency", required: false, group: "financial", rag: "amber", requiredForFinal: false },
                        { name: "Total Cost", type: "currency", required: true, group: "financial", rag: "amber", requiredForFinal: true }
                    ]
                },
                {
                    id: 4,
                    name: "Dispatch Stand By Charges",
                    key: "standby",
                    description: "For standby time billing",
                    color: "#f59e0b",
                    icon: "fa-clock",
                    hasBandDetails: false,
                    columns: [
                        { name: "Site Category", type: "dropdown", required: true, group: "basic", rag: "green", requiredForFinal: true },
                        { name: "Customer Name", type: "text", required: true, group: "basic", rag: "green", requiredForFinal: true },
                        { name: "Partner Name", type: "text", required: true, group: "basic", rag: "green", requiredForFinal: false },
                        { name: "Country", type: "text", required: true, group: "geographic", rag: "green", requiredForFinal: true },
                        { name: "State", type: "text", required: false, group: "geographic", rag: "amber", requiredForFinal: false },
                        { name: "City", type: "text", required: true, group: "geographic", rag: "green", requiredForFinal: true },
                        { name: "Site Address", type: "text", required: false, group: "geographic", rag: "amber", requiredForFinal: true },
                        { name: "Standby Start Time", type: "datetime", required: true, group: "technician", rag: "amber", requiredForFinal: true },
                        { name: "Standby End Time", type: "datetime", required: true, group: "technician", rag: "amber", requiredForFinal: true },
                        { name: "Standby Hours", type: "number", required: true, group: "technician", rag: "amber", requiredForFinal: true },
                        { name: "Standby Rate", type: "currency", required: true, group: "financial", rag: "red", requiredForFinal: true },
                        { name: "Total Standby Cost", type: "currency", required: true, group: "financial", rag: "red", requiredForFinal: true },
                        { name: "Currency", type: "dropdown", required: true, group: "financial", rag: "green", requiredForFinal: true }
                    ]
                },
                {
                    id: 5,
                    name: "Dedicated Table",
                    key: "dedicated",
                    description: "For monthly dedicated resources",
                    color: "#ef4444",
                    icon: "fa-user-tie",
                    hasBandDetails: true,
                    bandType: "dedicated",
                    columns: [
                        { name: "Site Category", type: "dropdown", required: true, group: "basic", rag: "green", requiredForFinal: true },
                        { name: "Customer Name", type: "text", required: true, group: "basic", rag: "green", requiredForFinal: true },
                        { name: "Partner Name", type: "text", required: true, group: "basic", rag: "green", requiredForFinal: false },
                        { name: "Country", type: "text", required: true, group: "geographic", rag: "green", requiredForFinal: true },
                        { name: "State", type: "text", required: false, group: "geographic", rag: "amber", requiredForFinal: false },
                        { name: "City", type: "text", required: true, group: "geographic", rag: "green", requiredForFinal: true },
                        { name: "Site Address", type: "text", required: false, group: "geographic", rag: "amber", requiredForFinal: true },
                        { name: "Zip code", type: "text", required: false, group: "geographic", rag: "amber", requiredForFinal: false },
                        { name: "PO number", type: "text", required: false, group: "basic", rag: "amber", requiredForFinal: true },
                        { name: "Technician Name", type: "text", required: true, group: "technician", rag: "green", requiredForFinal: true },
                        { name: "Band", type: "dropdown", required: true, group: "band_details", rag: "amber", requiredForFinal: true },
                        { name: "Variant", type: "dropdown", required: true, group: "band_details", rag: "amber", requiredForFinal: true },
                        { name: "Monthly rate", type: "currency", required: true, group: "financial", rag: "red", requiredForFinal: true },
                        { name: "SLA %", type: "percentage", required: true, group: "quality", rag: "red", requiredForFinal: true },
                        { name: "Currency", type: "dropdown", required: true, group: "financial", rag: "green", requiredForFinal: true }
                    ]
                },
                {
                    id: 6,
                    name: "SV, Full & Half Day Visit",
                    key: "sv",
                    description: "For scheduled visits with flat rates",
                    color: "#3b82f6",
                    icon: "fa-calendar-check",
                    hasBandDetails: false,
                    columns: [
                        { name: "Site Category", type: "dropdown", required: true, group: "basic", rag: "green", requiredForFinal: true },
                        { name: "Customer Name", type: "text", required: true, group: "basic", rag: "green", requiredForFinal: true },
                        { name: "Partner Name", type: "text", required: true, group: "basic", rag: "green", requiredForFinal: false },
                        { name: "Customer Ticket Number", type: "text", required: true, group: "basic", rag: "green", requiredForFinal: true },
                        { name: "Customer Ticket Created Date", type: "date", required: true, group: "basic", rag: "green", requiredForFinal: false },
                        { name: "Partner Ticket Number", type: "text", required: true, group: "basic", rag: "green", requiredForFinal: false },
                        { name: "Source of Request", type: "text", required: true, group: "basic", rag: "green", requiredForFinal: false },
                        { name: "PO number", type: "text", required: false, group: "basic", rag: "amber", requiredForFinal: true },
                        { name: "Country", type: "text", required: true, group: "geographic", rag: "green", requiredForFinal: true },
                        { name: "State", type: "text", required: false, group: "geographic", rag: "amber", requiredForFinal: false },
                        { name: "City", type: "text", required: true, group: "geographic", rag: "green", requiredForFinal: true },
                        { name: "Site Address", type: "text", required: false, group: "geographic", rag: "amber", requiredForFinal: true },
                        { name: "Zip code", type: "text", required: false, group: "geographic", rag: "amber", requiredForFinal: false },
                        { name: "Activity Details", type: "text", required: true, group: "service", rag: "green", requiredForFinal: true },
                        { name: "Ticket Priority", type: "dropdown", required: true, group: "service", rag: "green", requiredForFinal: true },
                        { name: "ETA Date", type: "date", required: true, group: "service", rag: "green", requiredForFinal: true },
                        { name: "ETA Time", type: "time", required: true, group: "service", rag: "green", requiredForFinal: true },
                        { name: "Technician Name", type: "text", required: true, group: "technician", rag: "green", requiredForFinal: true },
                        { name: "Technician IN Date", type: "date", required: true, group: "technician", rag: "green", requiredForFinal: false },
                        { name: "Technician IN Time", type: "time", required: true, group: "technician", rag: "green", requiredForFinal: false },
                        { name: "Technician OUT Date", type: "date", required: true, group: "technician", rag: "green", requiredForFinal: false },
                        { name: "Technician OUT Time", type: "time", required: true, group: "technician", rag: "green", requiredForFinal: false },
                        { name: "Total Hours", type: "number", required: true, group: "technician", rag: "green", requiredForFinal: true },
                        { name: "Category", type: "dropdown", required: true, group: "service", rag: "green", requiredForFinal: false },
                        { name: "Half Day Rate", type: "currency", required: false, group: "financial", rag: "amber", requiredForFinal: false },
                        { name: "Full Day Rate", type: "currency", required: false, group: "financial", rag: "amber", requiredForFinal: false },
                        { name: "Per Hour Rate", type: "currency", required: false, group: "financial", rag: "amber", requiredForFinal: false },
                        { name: "Total Cost", type: "currency", required: true, group: "financial", rag: "amber", requiredForFinal: true },
                        { name: "Currency", type: "dropdown", required: true, group: "financial", rag: "green", requiredForFinal: true }
                    ]
                },
                {
                    id: 7,
                    name: "Project Work Table",
                    key: "project",
                    description: "For project-based engagements",
                    color: "#8b5cf6",
                    icon: "fa-project-diagram",
                    hasBandDetails: true,
                    bandType: "project",
                    columns: [
                        { name: "Site Category", type: "dropdown", required: true, group: "basic", rag: "green", requiredForFinal: true },
                        { name: "Customer Name", type: "text", required: true, group: "basic", rag: "green", requiredForFinal: true },
                        { name: "Partner Name", type: "text", required: true, group: "basic", rag: "green", requiredForFinal: false },
                        { name: "Country", type: "text", required: true, group: "geographic", rag: "green", requiredForFinal: true },
                        { name: "State", type: "text", required: false, group: "geographic", rag: "amber", requiredForFinal: false },
                        { name: "City", type: "text", required: true, group: "geographic", rag: "green", requiredForFinal: true },
                        { name: "Site Address", type: "text", required: false, group: "geographic", rag: "amber", requiredForFinal: true },
                        { name: "Zip code", type: "text", required: false, group: "geographic", rag: "amber", requiredForFinal: false },
                        { name: "PO number", type: "text", required: false, group: "basic", rag: "amber", requiredForFinal: true },
                        { name: "Project Start Date", type: "date", required: true, group: "service", rag: "amber", requiredForFinal: true },
                        { name: "Project End Date", type: "date", required: true, group: "service", rag: "amber", requiredForFinal: true },
                        { name: "Estimated Hours", type: "number", required: true, group: "technician", rag: "amber", requiredForFinal: true },
                        { name: "Actual Hours", type: "number", required: true, group: "technician", rag: "amber", requiredForFinal: true },
                        { name: "Project Rate", type: "currency", required: true, group: "financial", rag: "red", requiredForFinal: true },
                        { name: "Estimated Cost", type: "currency", required: true, group: "financial", rag: "red", requiredForFinal: true },
                        { name: "Actual Cost", type: "currency", required: true, group: "financial", rag: "red", requiredForFinal: true },
                        { name: "Currency", type: "dropdown", required: true, group: "financial", rag: "green", requiredForFinal: true }
                    ]
                },
                {
                    id: 8,
                    name: "Final Ticket Data Table",
                    key: "final",
                    description: "Consolidated output - Auto-generated from all tables",
                    color: "#1e293b",
                    icon: "fa-ticket-alt",
                    hasBandDetails: false,
                    columns: [
                        { name: "Request ID", type: "text", required: true, group: "system", rag: "green", requiredForFinal: true },
                        { name: "CUSTOMER REFERENCE", type: "text", required: true, group: "basic", rag: "green", requiredForFinal: true },
                        { name: "Requester", type: "text", required: true, group: "basic", rag: "green", requiredForFinal: true },
                        { name: "Subject", type: "text", required: true, group: "service", rag: "amber", requiredForFinal: true },
                        { name: "Site", type: "text", required: true, group: "geographic", rag: "green", requiredForFinal: true },
                        { name: "Priority", type: "dropdown", required: true, group: "service", rag: "amber", requiredForFinal: true },
                        { name: "Assigned Technician", type: "text", required: true, group: "technician", rag: "green", requiredForFinal: true },
                        { name: "Created Date", type: "date", required: true, group: "system", rag: "green", requiredForFinal: true },
                        { name: "Start Date/Time", type: "datetime", required: true, group: "system", rag: "green", requiredForFinal: true },
                        { name: "End Date/Time", type: "datetime", required: true, group: "system", rag: "green", requiredForFinal: true },
                        { name: "Account", type: "text", required: true, group: "basic", rag: "green", requiredForFinal: true },
                        { name: "Region", type: "text", required: true, group: "geographic", rag: "green", requiredForFinal: true },
                        { name: "Country", type: "text", required: true, group: "geographic", rag: "green", requiredForFinal: true },
                        { name: "City", type: "text", required: true, group: "geographic", rag: "green", requiredForFinal: true },
                        { name: "Engineer details", type: "text", required: false, group: "technician", rag: "green", requiredForFinal: false },
                        { name: "PO NUMBER", type: "text", required: true, group: "financial", rag: "amber", requiredForFinal: true },
                        { name: "Revenue", type: "currency", required: true, group: "financial", rag: "red", requiredForFinal: true },
                        { name: "Cost", type: "currency", required: true, group: "financial", rag: "red", requiredForFinal: true },
                        { name: "Profit", type: "currency", required: true, group: "financial", rag: "red", requiredForFinal: true },
                        { name: "Margin %", type: "percentage", required: true, group: "financial", rag: "red", requiredForFinal: true },
                        { name: "Vendor PO", type: "text", required: true, group: "financial", rag: "amber", requiredForFinal: true },
                        { name: "PRE Visit", type: "boolean", required: false, group: "service", rag: "green", requiredForFinal: false },
                        { name: "POST Visit", type: "boolean", required: false, group: "service", rag: "green", requiredForFinal: false }
                    ]
                }
            ],

            // Enhanced field mapping for auto-population
            fieldMapping: {
                "Site Category": { 
                    tables: ["ticket", "dispatch", "standby", "dedicated", "sv", "project"], 
                    transformation: "Direct mapping", 
                    autoPopulates: "Determines which tables get populated" 
                },
                "Customer Name": { 
                    tables: ["all"], 
                    transformation: "Direct mapping", 
                    autoPopulates: "ALL tables" 
                },
                "Customer": { 
                    tables: ["rate", "final"], 
                    transformation: "Same as Customer Name", 
                    dependencies: ["Customer Name"] 
                },
                "Account": { 
                    tables: ["final"], 
                    transformation: "Same as Customer Name", 
                    dependencies: ["Customer Name"] 
                },
                "Partner Name": { 
                    tables: ["ticket", "dispatch", "standby", "dedicated", "sv", "project"], 
                    transformation: "Direct mapping", 
                    autoPopulates: "ALL tables" 
                },
                "Supplier": { 
                    tables: ["rate"], 
                    transformation: "Same as Partner Name", 
                    dependencies: ["Partner Name"] 
                },
                "Country": { 
                    tables: ["all"], 
                    transformation: "Direct mapping", 
                    autoPopulates: "ALL tables" 
                },
                "City": { 
                    tables: ["all"], 
                    transformation: "Direct mapping", 
                    autoPopulates: "ALL tables" 
                },
                "Site Address": { 
                    tables: ["ticket", "dispatch", "standby", "dedicated", "sv", "project"], 
                    transformation: "Direct mapping", 
                    autoPopulates: "ALL tables" 
                },
                "Site": { 
                    tables: ["final"], 
                    transformation: "Same as Site Address", 
                    dependencies: ["Site Address"] 
                },
                "PO number": { 
                    tables: ["ticket", "dispatch", "dedicated", "sv", "project"], 
                    transformation: "Direct mapping", 
                    autoPopulates: "ALL tables" 
                },
                "PO NUMBER": { 
                    tables: ["final"], 
                    transformation: "Same as PO number", 
                    dependencies: ["PO number"] 
                },
                "Currency": { 
                    tables: ["all"], 
                    transformation: "From Rate Card or manual entry", 
                    autoPopulates: "ALL tables" 
                },
                "Technician Name": { 
                    tables: ["ticket", "dispatch", "dedicated", "sv"], 
                    transformation: "Direct mapping", 
                    autoPopulates: "ALL tables" 
                },
                "Assigned Technician": { 
                    tables: ["final"], 
                    transformation: "Same as Technician Name", 
                    dependencies: ["Technician Name"] 
                },
                "Ticket Priority": { 
                    tables: ["ticket", "dispatch", "sv"], 
                    transformation: "Direct mapping", 
                    autoPopulates: "Dispatch, SV tables" 
                },
                "Priority": { 
                    tables: ["final"], 
                    transformation: "Same as Ticket Priority", 
                    dependencies: ["Ticket Priority"] 
                },
                "Activity Details": { 
                    tables: ["ticket", "dispatch", "sv"], 
                    transformation: "Direct mapping", 
                    autoPopulates: "Dispatch, SV tables" 
                },
                "Customer Ticket Number": { 
                    tables: ["ticket", "dispatch", "sv"], 
                    transformation: "Direct mapping", 
                    autoPopulates: "Dispatch, SV tables" 
                },
                "CUSTOMER REFERENCE": { 
                    tables: ["final"], 
                    transformation: "Same as Customer Ticket Number", 
                    dependencies: ["Customer Ticket Number"] 
                },
                "Band": { 
                    tables: ["dedicated"], 
                    transformation: "From band structure table", 
                    autoPopulates: "Dedicated table only",
                    bandDetails: true
                },
                "Monthly rate": { 
                    tables: ["dedicated"], 
                    transformation: "From band pricing table", 
                    autoPopulates: "Dedicated table only",
                    bandDetails: true
                }
            },

            // Sample data for preview - UPDATED WITH BAND DATA
            sampleData: {
                hcl: {
                    rev: {
                        ticket: {
                            "Site Category": "Dispatch",
                            "Customer Name": "HCL Technologies",
                            "Partner Name": "Tech Services Ltd",
                            "Customer Ticket Number": "HCL-2024-00123",
                            "Customer Ticket Created Date": "2024-03-15",
                            "Partner Ticket Number": "TSL-2024-0456",
                            "Source of Request": "Email",
                            "PO number": "INDOPO-6502",
                            "Country": "India",
                            "State": "Karnataka",
                            "City": "Bangalore",
                            "Site Address": "Electronics City, Phase 1",
                            "Zip code": "560100",
                            "Activity Details": "Server Maintenance",
                            "Dispatch Category": "4H",
                            "Ticket Priority": "P1",
                            "ETA Date": "2024-03-16",
                            "ETA Time": "10:00",
                            "Technician Name": "Rajesh Kumar",
                            "Technician IN Date": "2024-03-16",
                            "Technician IN Time": "09:45",
                            "Technician OUT Date": "2024-03-16",
                            "Technician OUT Time": "17:45",
                            "Total Hours": "8",
                            "Currency": "INR",
                            "Regular Rate": "1200",
                            "Total Cost": "9600",
                            "Remarks": "Completed successfully"
                        },
                        rate: {
                            "Customer": "HCL Technologies",
                            "Region": "South Asia",
                            "Country": "India",
                            "Supplier": "Tech Services Ltd",
                            "Currency": "INR",
                            "Category": "Dispatch",
                            "SR Region": "Bangalore",
                            "Rate Type": "Hourly",
                            "Rate Value": "1200",
                            "After Hours": "1800",
                            "Weekend": "2400",
                            "Travel": "500",
                            "Includes Travel": "Yes"
                        },
                        dispatch: {
                            "Site Category": "Dispatch",
                            "Customer Name": "HCL Technologies",
                            "Partner Name": "Tech Services Ltd",
                            "Customer Ticket Number": "HCL-2024-00123",
                            "Customer Ticket Created Date": "2024-03-15",
                            "Partner Ticket Number": "TSL-2024-0456",
                            "Source of Request": "Email",
                            "PO number": "INDOPO-6502",
                            "Country": "India",
                            "State": "Karnataka",
                            "City": "Bangalore",
                            "Site Address": "Electronics City, Phase 1",
                            "Zip code": "560100",
                            "Activity Details": "Server Maintenance",
                            "Dispatch Category": "4H",
                            "Ticket Priority": "P1",
                            "ETA Date": "2024-03-16",
                            "ETA Time": "10:00",
                            "Technician Name": "Rajesh Kumar",
                            "Technician IN Date": "2024-03-16",
                            "Technician IN Time": "09:45",
                            "Technician OUT Date": "2024-03-16",
                            "Technician OUT Time": "17:45",
                            "Total Hours": "8",
                            "Currency": "INR",
                            "Regular Rate": "1200",
                            "Total Cost": "9600"
                        },
                        standby: {
                            "Site Category": "Standby",
                            "Customer Name": "HCL Technologies",
                            "Partner Name": "Tech Services Ltd",
                            "Country": "India",
                            "State": "Karnataka",
                            "City": "Bangalore",
                            "Site Address": "Electronics City",
                            "Standby Start Time": "2024-03-20 18:00",
                            "Standby End Time": "2024-03-21 06:00",
                            "Standby Hours": "12",
                            "Standby Rate": "2000",
                            "Total Standby Cost": "24000",
                            "Currency": "INR"
                        },
                        dedicated: {
                            "Site Category": "Dedicated",
                            "Customer Name": "HCL Technologies",
                            "Partner Name": "Tech Services Ltd",
                            "Country": "India",
                            "State": "Karnataka",
                            "City": "Bangalore",
                            "Site Address": "Electronics City, Phase 1",
                            "Zip code": "560100",
                            "PO number": "INDOPO-6502",
                            "Technician Name": "Amit Sharma",
                            "Band": "Band 2",
                            "Variant": "With Benefits",
                            "Monthly rate": "30000",
                            "SLA %": "95",
                            "Currency": "INR"
                        },
                        sv: {
                            "Site Category": "SV Visit",
                            "Customer Name": "HCL Technologies",
                            "Partner Name": "Tech Services Ltd",
                            "Customer Ticket Number": "HCL-2024-00234",
                            "Customer Ticket Created Date": "2024-03-10",
                            "Partner Ticket Number": "TSL-2024-0457",
                            "Source of Request": "Portal",
                            "PO number": "INDOPO-6503",
                            "Country": "India",
                            "State": "Karnataka",
                            "City": "Bangalore",
                            "Site Address": "Whitefield",
                            "Zip code": "560066",
                            "Activity Details": "Quarterly Maintenance",
                            "Ticket Priority": "P2",
                            "ETA Date": "2024-03-12",
                            "ETA Time": "09:00",
                            "Technician Name": "Priya Singh",
                            "Technician IN Date": "2024-03-12",
                            "Technician IN Time": "08:45",
                            "Technician OUT Date": "2024-03-12",
                            "Technician OUT Time": "17:15",
                            "Total Hours": "8.5",
                            "Category": "Full Day",
                            "Half Day Rate": "6000",
                            "Full Day Rate": "10000",
                            "Per Hour Rate": "1500",
                            "Total Cost": "10000",
                            "Currency": "INR"
                        },
                        project: {
                            "Site Category": "Project",
                            "Customer Name": "HCL Technologies",
                            "Partner Name": "Tech Services Ltd",
                            "Country": "India",
                            "State": "Karnataka",
                            "City": "Bangalore",
                            "Site Address": "Multiple locations",
                            "Zip code": "560100",
                            "PO number": "INDOPO-7001",
                            "Project Start Date": "2024-01-15",
                            "Project End Date": "2024-06-30",
                            "Estimated Hours": "1000",
                            "Actual Hours": "850",
                            "Project Rate": "1500",
                            "Estimated Cost": "1500000",
                            "Actual Cost": "1275000",
                            "Currency": "INR"
                        },
                        final: {
                            "Request ID": "REQ-1001",
                            "CUSTOMER REFERENCE": "HCL-2024-00123",
                            "Requester": "System Admin",
                            "Subject": "Server Maintenance | Bangalore | India | HCL Technologies",
                            "Site": "Electronics City, Phase 1",
                            "Priority": "P1",
                            "Assigned Technician": "Rajesh Kumar",
                            "Created Date": "2024-03-15",
                            "Start Date/Time": "2024-03-16 09:45",
                            "End Date/Time": "2024-03-16 17:45",
                            "Account": "HCL Technologies",
                            "Region": "South Asia",
                            "Country": "India",
                            "City": "Bangalore",
                            "Engineer details": "Rajesh Kumar - Tech Services Ltd",
                            "PO NUMBER": "INDOPO-6502",
                            "Revenue": "12000",
                            "Cost": "9600",
                            "Profit": "2400",
                            "Margin %": "20",
                            "Vendor PO": "INDO-PO-6502",
                            "PRE Visit": "Yes",
                            "POST Visit": "Yes"
                        }
                    }
                }
            },

            // Final Table Transformation Logic
            finalTable: [
                { field: "Request ID", source: "System", transformation: "Auto-generated sequential number", required: true },
                { field: "CUSTOMER REFERENCE", source: "Ticket Data", transformation: "Customer Ticket Number", required: true },
                { field: "Requester", source: "System", transformation: "Auto-set to 'System Admin' or manual", required: true },
                { field: "Subject", source: "Multiple", transformation: "Activity Details | City | Country | Customer Name", required: true },
                { field: "Site", source: "Ticket Data", transformation: "Site Address", required: true },
                { field: "Priority", source: "Ticket Data", transformation: "Ticket Priority", required: true },
                { field: "Assigned Technician", source: "Ticket Data", transformation: "Technician Name", required: true },
                { field: "Created Date", source: "Ticket Data", transformation: "Customer Ticket Created Date", required: true },
                { field: "Start Date/Time", source: "Ticket Data", transformation: "Technician IN Date + Technician IN Time", required: true },
                { field: "End Date/Time", source: "Ticket Data", transformation: "Technician OUT Date + Technician OUT Time", required: true },
                { field: "Account", source: "Ticket Data", transformation: "Customer Name", required: true },
                { field: "Region", source: "Rate Card", transformation: "Region", required: true },
                { field: "Country", source: "Ticket Data", transformation: "Country", required: true },
                { field: "City", source: "Ticket Data", transformation: "City", required: true },
                { field: "Engineer details", source: "Multiple", transformation: "Technician Name + Partner Name", required: false },
                { field: "PO NUMBER", source: "Ticket Data", transformation: "PO number", required: true },
                { field: "Revenue", source: "Calculated", transformation: "SUM of all service costs", required: true },
                { field: "Cost", source: "Calculated", transformation: "SUM of all service costs", required: true },
                { field: "Profit", source: "Calculated", transformation: "Revenue - Cost", required: true },
                { field: "Margin %", source: "Calculated", transformation: "(Profit / Revenue) * 100", required: true },
                { field: "Vendor PO", source: "Ticket Data", transformation: "[Country Code]-PO-[PO Number]", required: true },
                { field: "PRE Visit", source: "System", transformation: "Auto-set based on ETA date", required: false },
                { field: "POST Visit", source: "System", transformation: "Auto-set based on completion", required: false }
            ]
        };

        // Add Band Details Data Structure based on the second code
        const bandDetailsData = {
            // Dedicated Services Bands
            dedicated: {
                title: "Dedicated Services Band Structure",
                description: "Monthly dedicated resources with band-based pricing",
                bands: ['Band 0', 'Band 1', 'Band 2', 'Band 3', 'Band 4'],
                columns: ['With Benefits', 'Without Benefits'],
                sampleData: {
                    'HCL Technologies': {
                        'Band 0': ['$26,000', '$23,000'],
                        'Band 1': ['$28,000', '$25,000'],
                        'Band 2': ['$30,000', '$27,000'],
                        'Band 3': ['$32,000', '$29,000'],
                        'Band 4': ['$34,000', '$31,000']
                    },
                    'Fresenius Medical': {
                        'Band 0': ['$28,000', '$25,000'],
                        'Band 1': ['$30,000', '$27,000'],
                        'Band 2': ['$32,000', '$29,000'],
                        'Band 3': ['$34,000', '$31,000'],
                        'Band 4': ['$36,000', '$33,000']
                    }
                },
                groups: [
                    {
                        title: "Dedicated Services",
                        bands: ['Band 0', 'Band 1', 'Band 2', 'Band 3', 'Band 4']
                    }
                ]
            },

            // Dispatch Services Bands
            dispatch: {
                title: "Dispatch Services Band Structure",
                description: "On-demand service dispatches with category-based pricing",
                groups: [
                    {
                        title: "Dispatch Ticket (Incident)",
                        bands: ['4 hour', 'SBD', 'NBD', '2 BD', '3 BD', 'Additional Hour']
                    },
                    {
                        title: "Dispatch Ticket (IMAC)",
                        bands: ['2 BD', '3 BD', '4 BD']
                    }
                ],
                sampleData: {
                    'HCL Technologies': {
                        'Dispatch Ticket (Incident)': {
                            '4 hour': '$350',
                            'SBD': '$450',
                            'NBD': '$550',
                            '2 BD': '$650',
                            '3 BD': '$750',
                            'Additional Hour': '$120'
                        },
                        'Dispatch Ticket (IMAC)': {
                            '2 BD': '$800',
                            '3 BD': '$950',
                            '4 BD': '$1,100'
                        }
                    }
                }
            },

            // Project Work Bands
            project: {
                title: "Project Work Band Structure",
                description: "Project-based engagements with duration-based pricing",
                groups: [
                    {
                        title: "Short Term (Up to 3 months)",
                        bands: ['Band 0', 'Band 1', 'Band 2', 'Band 3', 'Band 4']
                    },
                    {
                        title: "Long Term (more than 3 months)",
                        bands: ['Band 0', 'Band 1', 'Band 2', 'Band 3', 'Band 4']
                    }
                ],
                sampleData: {
                    'HCL Technologies': {
                        'Short Term (Up to 3 months)': {
                            'Band 0': '$5,000',
                            'Band 1': '$5,500',
                            'Band 2': '$6,000',
                            'Band 3': '$6,500',
                            'Band 4': '$7,000'
                        },
                        'Long Term (more than 3 months)': {
                            'Band 0': '$4,500',
                            'Band 1': '$5,000',
                            'Band 2': '$5,500',
                            'Band 3': '$6,000',
                            'Band 4': '$6,500'
                        }
                    }
                }
            },

            // Scheduled Services Bands (for reference)
            scheduled: {
                title: "Scheduled Services Band Structure",
                description: "Scheduled visits with flat rates",
                groups: [
                    {
                        title: "Full Day Visit (8hrs)",
                        bands: ['Band 0', 'Band 1', 'Band 2']
                    },
                    {
                        title: "1/2 Day Visit (4hrs)",
                        bands: ['Band 0', 'Band 1', 'Band 2']
                    }
                ]
            }
        };

        // Application State
        let currentState = {
            smartAddActive: true,
            isDataView: false,
            currentCustomer: "hcl",
            currentAccount: "rev",
            currentSiteCategory: "",
            lastModifiedField: null,
            lastModifiedValue: null,
            smartAddCount: 0,
            autoPopulatedCount: 0,
            validationErrors: [],
            modifiedFields: new Set(),
            currentRequestId: 1001,
            showBandDetails: false,
            bandData: {},
            // Store all data including non-existent field data
            allData: {}
        };

        // Enhanced Filter State
        let filterState = {
            tableFilter: "SHOW_ALL",
            fieldGroup: "ALL",
            sortBy: "ALPHABETICAL_ASC",
            inputMode: "NORMAL",
            ragStatus: "ALL",
            dataType: "ALL",
            showRequiredOnly: false,
            showEmptyOnly: false,
            showTransformation: false,
            highlightMode: "NONE",
            displayOptions: "SHOW_DATA",
            displayMode: "FLAT"
        };

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeMatrix();
            setupEventListeners();
            updateFinalTablePreview();
            loadSampleData('hcl'); // Load default sample data
            generateBandData(); // Generate initial band data
        });

        // Setup event listeners
        function setupEventListeners() {
            // Search input
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchMatrix(this.value);
                }
            });

            // Smart add toggle
            document.getElementById('smartAddToggle').addEventListener('change', function() {
                currentState.smartAddActive = this.checked;
                document.getElementById('smartAddStatus').textContent = this.checked ? 'ACTIVE' : 'INACTIVE';
                if (this.checked) {
                    showNotification('Smart Add Mode activated - Changes will auto-populate across tables', 'success');
                } else {
                    showNotification('Smart Add Mode deactivated', 'warning');
                }
            });

            // Debounce for smart add
            let debounceTimer;
            window.addEventListener('input', function(e) {
                if (e.target.classList.contains('cell-input')) {
                    const fieldName = e.target.getAttribute('data-field');
                    const tableId = e.target.getAttribute('data-table');
                    if (fieldName && tableId) {
                        currentState.modifiedFields.add(fieldName);
                        clearTimeout(debounceTimer);
                        debounceTimer = setTimeout(() => {
                            handleCellInput(e.target);
                        }, 300);
                    }
                }
            });
        }

        // Initialize the matrix
        function initializeMatrix() {
            renderMatrixHeader();
            applyFilters();
            renderMatrixBody();
            updateMatrixStats();
        }

        // Render matrix header
        function renderMatrixHeader() {
            const header = document.getElementById('matrixHeader');
            header.innerHTML = `
                <th style="min-width: 250px;">
                    <i class="fas fa-columns"></i> Field Name
                    <br><span style="font-size: 0.7rem; font-weight: normal;">(ALL cells are editable - even non-existent fields)</span>
                </th>
            `;
           
            systemData.tables.forEach(table => {
                const bandIcon = table.hasBandDetails ? '<i class="fas fa-layer-group" style="margin-left: 5px; color: var(--secondary);"></i>' : '';
                header.innerHTML += `
                    <th style="background: ${table.color};">
                        <i class="fas ${table.icon}"></i> ${table.name}
                        ${bandIcon}
                        <br><span style="font-size: 0.7rem; font-weight: normal;">${table.columns.length} fields</span>
                    </th>
                `;
            });
        }

        // Enhanced renderMatrixBody function with ALL cells editable
        function renderMatrixBody() {
            const body = document.getElementById('matrixBody');
            body.innerHTML = '';

            // Collect all fields from all tables
            let allFields = new Set();
            systemData.tables.forEach(table => {
                table.columns.forEach(col => {
                    allFields.add(col.name);
                });
            });

            // Also include fields from sample data that might not be in table definitions
            Object.values(systemData.sampleData).forEach(customerData => {
                Object.values(customerData).forEach(accountData => {
                    Object.values(accountData).forEach(tableData => {
                        Object.keys(tableData).forEach(fieldName => {
                            allFields.add(fieldName);
                        });
                    });
                });
            });

            let fieldList = Array.from(allFields).map(fieldName => {
                const fieldData = {
                    name: fieldName,
                    tables: [],
                    type: 'text',
                    required: false,
                    group: 'basic',
                    rag: 'green',
                    requiredForFinal: false,
                    hasBandDetails: false
                };

                // Get field properties from tables that have it
                systemData.tables.forEach(table => {
                    const col = table.columns.find(c => c.name === fieldName);
                    if (col) {
                        fieldData.type = col.type;
                        fieldData.required = col.required;
                        fieldData.group = col.group;
                        fieldData.rag = col.rag;
                        fieldData.requiredForFinal = col.requiredForFinal || false;
                        fieldData.tables.push(table.id);
                        
                        // Check if this field is in a table with band details
                        if (table.hasBandDetails) {
                            fieldData.hasBandDetails = true;
                        }
                    }
                });

                return fieldData;
            });

            // Apply filters
            let filteredFields = fieldList.filter(field => {
                // Table filter
                if (filterState.tableFilter !== "SHOW_ALL" && filterState.tableFilter !== "FINAL_TABLE") {
                    const tableMap = {
                        TICKET_DATA: 1,
                        RATE_CARD: 2,
                        DISPATCH: 3,
                        STANDBY: 4,
                        DEDICATED: 5,
                        SV_VISIT: 6,
                        PROJECT: 7,
                        FINAL_TABLE: 8,
                        BAND_TABLES: "BAND_TABLES"
                    };
                    
                    if (filterState.tableFilter === "BAND_TABLES") {
                        // Show only fields from tables with band details
                        const bandTables = systemData.tables.filter(t => t.hasBandDetails).map(t => t.id);
                        if (!field.tables.some(tableId => bandTables.includes(tableId))) {
                            return false;
                        }
                    } else {
                        const targetId = tableMap[filterState.tableFilter];
                        if (!field.tables.includes(targetId)) return false;
                    }
                }

                // Field group filter
                if (filterState.fieldGroup !== "ALL") {
                    const groupMap = {
                        BASIC_INFO: "basic",
                        GEOGRAPHIC: "geographic",
                        SERVICE: "service",
                        TECHNICIAN: "technician",
                        FINANCIAL: "financial",
                        QUALITY: "quality",
                        RATES: "rates",
                        PROJECT: "project",
                        STAND_BY: "stand_by",
                        SYSTEM: "system",
                        BAND_DETAILS: "band_details"
                    };
                    const targetGroup = groupMap[filterState.fieldGroup] || filterState.fieldGroup.toLowerCase();
                    if (field.group !== targetGroup) return false;
                }

                // RAG filter
                if (filterState.ragStatus === "REQUIRED" && !field.required) return false;
                if (filterState.ragStatus === "OPTIONAL" && field.required) return false;
                if (filterState.ragStatus === "GREEN" && field.rag !== "green") return false;
                if (filterState.ragStatus === "AMBER" && field.rag !== "amber") return false;
                if (filterState.ragStatus === "RED" && field.rag !== "red") return false;

                // Data type filter
                if (filterState.dataType !== "ALL" && field.type.toUpperCase() !== filterState.dataType) return false;

                // Required only filter
                if (filterState.showRequiredOnly && !field.required) return false;

                // Empty fields filter
                if (filterState.showEmptyOnly) {
                    const hasData = field.tables.some(tableId => {
                        const data = getFieldData(field.name, tableId);
                        return data && data !== "—" && data !== "";
                    });
                    if (hasData) return false;
                }

                return true;
            });

            // Enhanced sorting
            filteredFields.sort((a, b) => {
                switch (filterState.sortBy) {
                    case "ALPHABETICAL_ASC": return a.name.localeCompare(b.name);
                    case "ALPHABETICAL_DESC": return b.name.localeCompare(a.name);
                    case "REQUIRED_FIRST":
                        return (b.required - a.required) || (b.requiredForFinal - a.requiredForFinal) || a.name.localeCompare(b.name);
                    case "MANDATORY_FIRST":
                        return (b.requiredForFinal - a.requiredForFinal) || (b.required - a.required) || a.name.localeCompare(b.name);
                    case "FREQUENCY": return b.tables.length - a.tables.length || a.name.localeCompare(b.name);
                    case "DATA_TYPE": return a.type.localeCompare(b.type) || a.name.localeCompare(b.name);
                    case "FIELD_GROUP": return a.group.localeCompare(b.group) || a.name.localeCompare(b.name);
                    case "LAST_MODIFIED":
                        return (b.lastModified || 0) - (a.lastModified || 0) || a.name.localeCompare(b.name);
                    default: return 0;
                }
            });

            // Render rows based on display mode
            if (filterState.displayMode === "GROUPED") {
                renderGroupedView(filteredFields);
            } else if (filterState.displayMode === "TABLE_WISE") {
                renderTableWiseView(filteredFields);
            } else {
                renderFlatView(filteredFields);
            }

            applyHighlighting();
            updateMatrixStats();
           
            // Add event listeners for editable cells
            addCellEditListeners();
        }

        // Flat view rendering with ALL cells editable
        function renderFlatView(filteredFields) {
            const body = document.getElementById('matrixBody');
           
            filteredFields.forEach(field => {
                const row = document.createElement('tr');
                row.setAttribute('data-field', field.name);
                row.setAttribute('data-group', field.group);
                row.setAttribute('data-type', field.type);
                row.setAttribute('data-rag', field.rag);
                row.setAttribute('data-required', field.required);
                row.setAttribute('data-has-band', field.hasBandDetails);

                // Field name cell with enhanced info
                const nameCell = document.createElement('td');
                let ragClass = `rag-${field.rag}`;
                nameCell.innerHTML = `
                    <div style="display:flex; align-items:center; gap:10px;">
                        <strong>${field.name}</strong>
                        <span style="font-size:0.7rem; color:var(--${field.rag === 'red' ? 'danger' : field.rag === 'amber' ? 'warning' : 'success'});">
                            ● ${field.rag.toUpperCase()}
                        </span>
                        <span style="font-size:0.7rem; color:var(--gray);">${field.group}</span>
                        ${field.required ? '<span style="font-size:0.7rem; color:var(--danger);">REQUIRED</span>' : ''}
                        ${field.requiredForFinal ? '<span style="font-size:0.7rem; color:var(--primary);">FINAL</span>' : ''}
                        ${field.hasBandDetails ? '<span style="font-size:0.7rem; color:var(--secondary);"><i class="fas fa-layer-group"></i> BAND</span>' : ''}
                    </div>
                    ${filterState.showTransformation ? `<div style="font-size:0.7rem; color:var(--gray); margin-top:5px;">
                        <i class="fas fa-exchange-alt"></i> ${getTransformationLogic(field.name)}
                    </div>` : ''}
                `;
               
                // Add highlighting based on input mode
                if (filterState.inputMode === "FINAL_TABLE" && field.requiredForFinal) {
                    nameCell.classList.add('highlight-final-table');
                } else if (field.required) {
                    nameCell.classList.add('highlight-required');
                } else if (field.hasBandDetails && currentState.showBandDetails) {
                    nameCell.classList.add('highlight-band-table');
                }
               
                row.appendChild(nameCell);

                // Table cells - ALL EDITABLE
                systemData.tables.forEach(table => {
                    const cell = document.createElement('td');
                    const hasField = field.tables.includes(table.id);
                    
                    // Get current data
                    const data = getFieldData(field.name, table.id);
                    
                    // Create input for ALL cells
                    if (currentState.isDataView) {
                        if (filterState.displayOptions === "SHOW_TYPE") {
                            cell.innerHTML = `<div class="cell-data"><small>${field.type}</small></div>`;
                        } else if (filterState.displayOptions === "SHOW_SOURCE") {
                            cell.innerHTML = `<div class="cell-data"><small>Source: ${table.name}</small></div>`;
                        } else if (filterState.displayOptions === "SHOW_TRANSFORMATION") {
                            cell.innerHTML = `<div class="cell-data"><small>${getTransformationLogic(field.name)}</small></div>`;
                        } else {
                            // Make ALL cells editable
                            const inputClass = hasField ? 'cell-input' : 'cell-input non-existent';
                            cell.innerHTML = `
                                <div class="matrix-cell-content">
                                    <div class="cell-value">
                                        <input type="text"
                                               class="${inputClass}"
                                               value="${data || ''}"
                                               data-field="${field.name}"
                                               data-table="${table.id}"
                                               placeholder="${hasField ? 'Enter value...' : 'Field not in table (but editable)'}">
                                    </div>
                                    ${table.hasBandDetails && currentState.showBandDetails ? 
                                        `<button class="cell-band-btn" onclick="showCellBandDetails('${field.name}', ${table.id}, '${table.key}')" title="View Band Details">
                                            <i class="fas fa-layer-group"></i>
                                        </button>` : ''}
                                </div>
                                ${!hasField ? '<div class="editable-indicator"><i class="fas fa-edit"></i></div>' : ''}
                            `;
                            cell.style.cursor = 'pointer';
                            cell.style.position = 'relative';
                            
                            // Add band indicator if table has band details
                            if (table.hasBandDetails && currentState.showBandDetails) {
                                cell.classList.add('cell-with-band');
                            }
                        }
                    } else {
                        // Structural view - still show if field exists or not
                        if (hasField) {
                            cell.innerHTML = '<div class="cell-check">✔</div>';
                            cell.className = 'cell-check';
                        } else {
                            cell.innerHTML = '<div class="cell-cross">✖</div>';
                            cell.className = 'cell-cross';
                        }
                    }
                   
                    // Add data attributes for highlighting
                    cell.setAttribute('data-table', table.id);
                    cell.setAttribute('data-has-field', hasField);
                   
                    row.appendChild(cell);
                });

                body.appendChild(row);
            });
        }

        // Add cell edit listeners
        function addCellEditListeners() {
            const cells = document.querySelectorAll('.cell-input');
            cells.forEach(cell => {
                cell.addEventListener('dblclick', function(e) {
                    e.target.select();
                });
               
                cell.addEventListener('focus', function(e) {
                    e.target.style.background = '#f8fafc';
                });
               
                cell.addEventListener('blur', function(e) {
                    const hasField = e.target.classList.contains('non-existent') ? false : true;
                    if (!hasField) {
                        e.target.style.background = '#fef2f2';
                    }
                });
            });
        }

        // Handle cell input
        function handleCellInput(inputElement) {
            const fieldName = inputElement.getAttribute('data-field');
            const tableId = parseInt(inputElement.getAttribute('data-table'));
            const value = inputElement.value;
           
            // Update data
            updateFieldData(fieldName, tableId, value);
           
            // Handle smart add if active
            if (currentState.smartAddActive) {
                handleSmartAdd(fieldName, value, tableId);
            }
           
            // Update final table preview
            updateFinalTablePreview();
           
            // Update stats
            currentState.autoPopulatedCount++;
            updateMatrixStats();
        }

        // Get field data
        function getFieldData(fieldName, tableId) {
            // First check sample data
            const customer = currentState.currentCustomer;
            const account = currentState.currentAccount;
           
            // Map table ID to data key
            const tableMap = {
                1: 'ticket',
                2: 'rate',
                3: 'dispatch',
                4: 'standby',
                5: 'dedicated',
                6: 'sv',
                7: 'project',
                8: 'final'
            };
           
            const dataKey = tableMap[tableId];
            const data = systemData.sampleData[customer]?.[account]?.[dataKey];
           
            if (data && data[fieldName] !== undefined) {
                return data[fieldName];
            }
           
            // Check if we have stored data for non-existent fields
            const storageKey = `${dataKey}_${fieldName}`;
            if (currentState.allData[storageKey]) {
                return currentState.allData[storageKey];
            }
           
            // Check if field exists in table
            const table = systemData.tables.find(t => t.id === tableId);
            if (table) {
                const hasField = table.columns.some(col => col.name === fieldName);
                if (!hasField) {
                    return ""; // Return empty for non-existent fields
                }
            }
           
            // Generate sample data if not available
            return generateSampleData(fieldName, tableId);
        }

        // Update field data
        function updateFieldData(fieldName, tableId, value) {
            const customer = currentState.currentCustomer;
            const account = currentState.currentAccount;
           
            // Map table ID to data key
            const tableMap = {
                1: 'ticket',
                2: 'rate',
                3: 'dispatch',
                4: 'standby',
                5: 'dedicated',
                6: 'sv',
                7: 'project',
                8: 'final'
            };
           
            const dataKey = tableMap[tableId];
            if (!systemData.sampleData[customer]) {
                systemData.sampleData[customer] = {};
            }
            if (!systemData.sampleData[customer][account]) {
                systemData.sampleData[customer][account] = {};
            }
            if (!systemData.sampleData[customer][account][dataKey]) {
                systemData.sampleData[customer][account][dataKey] = {};
            }
           
            systemData.sampleData[customer][account][dataKey][fieldName] = value;
           
            // Also store in allData for non-existent fields
            const storageKey = `${dataKey}_${fieldName}`;
            currentState.allData[storageKey] = value;
           
            // Show notification
            const table = systemData.tables.find(t => t.id === tableId);
            const hasField = table.columns.some(col => col.name === fieldName);
            if (!hasField) {
                showNotification(`Added "${fieldName}" to ${table.name} (custom field)`, 'info');
            } else {
                showNotification(`Updated ${fieldName} in ${table.name}`, 'success');
            }
        }

        // Generate sample data
        function generateSampleData(fieldName, tableId) {
            const customer = currentState.currentCustomer;
            const account = currentState.currentAccount;
           
            // Check if we have existing data
            const tableMap = {
                1: 'ticket',
                2: 'rate',
                3: 'dispatch',
                4: 'standby',
                5: 'dedicated',
                6: 'sv',
                7: 'project',
                8: 'final'
            };
           
            const dataKey = tableMap[tableId];
            const existingData = systemData.sampleData[customer]?.[account]?.[dataKey];
           
            if (existingData && existingData[fieldName]) {
                return existingData[fieldName];
            }
           
            // Generate based on field type
            const table = systemData.tables.find(t => t.id === tableId);
            let fieldType = 'text';
            if (table) {
                const col = table.columns.find(c => c.name === fieldName);
                if (col) {
                    fieldType = col.type;
                }
            }
           
            const samples = {
                "Customer Name": ["HCL Technologies", "Fresenius Medical", "Acme Corp", "Global Enterprises"],
                "Customer": ["HCL Technologies", "Fresenius Medical", "Acme Corp", "Global Enterprises"],
                "Partner Name": ["Tech Services Ltd", "MediCare Solutions", "Global Partners", "Support Solutions Inc"],
                "Supplier": ["Tech Services Ltd", "MediCare Solutions", "Global Partners", "Support Solutions Inc"],
                "Country": ["India", "Germany", "USA", "UK", "Singapore", "Australia"],
                "City": ["Bangalore", "Berlin", "New York", "London", "Singapore", "Sydney"],
                "PO number": ["INDOPO-6502", "GERPO-4501", "USAPO-7890", "UKPO-1234", "SGPO-5678"],
                "Currency": ["INR", "EUR", "USD", "GBP", "SGD", "AUD"],
                "Technician Name": ["Rajesh Kumar", "Hans Müller", "John Smith", "Sarah Chen", "David Wilson", "Maria Garcia"],
                "Total Hours": ["8", "12", "6", "10", "24", "4", "16"],
                "Rate Value": ["1200", "1500", "2000", "850", "3000"],
                "Monthly rate": ["80000", "6500", "5000", "12000", "100000"],
                "Site Category": ["Dispatch", "Dedicated", "Project", "SV Visit", "Standby"],
                "Ticket Priority": ["P1", "P2", "P3", "P4"],
                "Dispatch Category": ["4H", "SBD", "NBD", "2BD"],
                "Activity Details": ["Server Maintenance", "Equipment Calibration", "System Implementation", "Network Setup", "Software Update"],
                "Site Address": ["Electronics City, Phase 1", "Alexanderplatz 1", "Market Street 123", "Oxford Street 456", "Raffles Place 789"],
                "ETA Time": ["10:00", "14:00", "09:00", "13:30", "15:45"],
                "Remarks": ["Completed successfully", "In progress", "Pending review", "Escalated to Level 2", "Resolved"],
                "Band": ["Band 0", "Band 1", "Band 2", "Band 3", "Band 4"],
                "Variant": ["With Benefits", "Without Benefits"]
            };
           
            for (const [key, values] of Object.entries(samples)) {
                if (fieldName.includes(key) || key.includes(fieldName)) {
                    return values[Math.floor(Math.random() * values.length)];
                }
            }
           
            // Default values based on type
            switch(fieldType) {
                case 'text': return "Sample Data";
                case 'number': return Math.floor(Math.random() * 100).toString();
                case 'currency': return (Math.random() * 1000).toFixed(2);
                case 'date': return new Date().toISOString().split('T')[0];
                case 'time': return "09:00";
                case 'datetime': return new Date().toISOString().replace('T', ' ');
                case 'boolean': return "Yes";
                case 'percentage': return "15";
                case 'dropdown': return "Option 1";
                default: return "Sample Value";
            }
        }

        // Handle smart add functionality
        function handleSmartAdd(fieldName, value, sourceTableId) {
            if (!currentState.smartAddActive) return;
           
            // Store last modified field
            currentState.lastModifiedField = fieldName;
            currentState.lastModifiedValue = value;
           
            // Find which tables should have this field
            const mapping = systemData.fieldMapping[fieldName];
            if (!mapping) return;
           
            let tablesToUpdate = [];
            if (mapping.tables[0] === 'all') {
                tablesToUpdate = systemData.tables.filter(t => t.id !== sourceTableId);
            } else {
                // Map table names to IDs
                const tableMap = {
                    'ticket': 1,
                    'rate': 2,
                    'dispatch': 3,
                    'standby': 4,
                    'dedicated': 5,
                    'sv': 6,
                    'project': 7,
                    'final': 8
                };
               
                tablesToUpdate = mapping.tables
                    .map(name => systemData.tables.find(t => t.id === tableMap[name]))
                    .filter(Boolean)
                    .filter(t => t.id !== sourceTableId);
            }
           
            // Update data in all relevant tables
            tablesToUpdate.forEach(table => {
                const hasField = table.columns.some(col => col.name === fieldName);
                if (hasField || mapping.tables[0] === 'all') {
                    updateFieldData(fieldName, table.id, value);
                }
            });
           
            // Update UI with smart add animation
            const rows = document.querySelectorAll(`tr[data-field="${fieldName}"]`);
            rows.forEach(row => {
                const cells = row.querySelectorAll('td:not(:first-child)');
                cells.forEach(cell => {
                    if (parseInt(cell.getAttribute('data-table')) !== sourceTableId) {
                        cell.classList.add('highlight-smart-add');
                        setTimeout(() => {
                            cell.classList.remove('highlight-smart-add');
                        }, 1000);
                    }
                });
            });
           
            // Show indicator
            showSmartAddIndicator(tablesToUpdate.length);
           
            // Update stats
            currentState.smartAddCount++;
            updateMatrixStats();
        }

        // Show smart add indicator
        function showSmartAddIndicator(tableCount) {
            const indicator = document.getElementById('smartAddIndicator');
            const text = document.getElementById('smartAddText');
           
            text.textContent = `Smart Add: Updated ${tableCount} tables with "${currentState.lastModifiedField}"`;
            indicator.style.display = 'flex';
           
            setTimeout(() => {
                indicator.style.display = 'none';
            }, 3000);
        }

        // Toggle matrix mode
        function toggleMatrixMode() {
            currentState.isDataView = document.getElementById('matrixModeToggle').checked;
            renderMatrixBody();
            updateMatrixStats();
           
            if (currentState.isDataView) {
                showNotification('Data Preview Mode: Showing actual data from selected customer/account', 'info');
            } else {
                showNotification('Structural View Mode: Showing column existence across tables', 'info');
            }
        }

        // Update matrix data based on selections
        function updateMatrixData() {
            currentState.currentCustomer = document.getElementById('customerSelect').value;
            currentState.currentAccount = document.getElementById('accountSelect').value;
           
            if (currentState.isDataView && currentState.currentCustomer && currentState.currentAccount) {
                renderMatrixBody();
                updateMatrixStats();
                updateFinalTablePreview();
                showNotification(`Showing data for ${currentState.currentCustomer.toUpperCase()} - ${currentState.currentAccount.toUpperCase()}`, 'success');
            }
        }

        // Search matrix
        function searchMatrix(searchTerm) {
            if (!searchTerm) {
                // Clear highlights
                document.querySelectorAll('.highlight-column').forEach(el => {
                    el.classList.remove('highlight-column');
                });
                return;
            }
           
            searchTerm = searchTerm.toLowerCase();
            const rows = document.querySelectorAll('#matrixBody tr[data-field]');
            let matchCount = 0;
           
            rows.forEach(row => {
                const fieldName = row.getAttribute('data-field').toLowerCase();
                const cells = row.querySelectorAll('td');
                let rowMatches = false;
               
                // Check field name
                if (fieldName.includes(searchTerm)) {
                    rowMatches = true;
                }
               
                // Check cell contents in data view
                if (currentState.isDataView) {
                    cells.forEach(cell => {
                        const input = cell.querySelector('input');
                        if (input) {
                            const cellText = input.value.toLowerCase();
                            if (cellText.includes(searchTerm) && cellText !== '') {
                                rowMatches = true;
                            }
                        }
                    });
                }
               
                // Highlight row if matches
                if (rowMatches) {
                    cells.forEach(cell => {
                        cell.classList.add('highlight-column');
                    });
                    matchCount++;
                    row.style.display = '';
                } else {
                    cells.forEach(cell => {
                        cell.classList.remove('highlight-column');
                    });
                    if (currentState.currentSiteCategory) {
                        row.style.display = 'none';
                    }
                }
            });
           
            showNotification(`Found ${matchCount} matches for "${searchTerm}"`, 'info');
        }

        // Update matrix statistics
        function updateMatrixStats() {
            const allFields = new Set();
            const requiredFields = new Set();
            const bandTables = systemData.tables.filter(t => t.hasBandDetails);
           
            systemData.tables.forEach(table => {
                table.columns.forEach(col => {
                    allFields.add(col.name);
                    if (col.required) {
                        requiredFields.add(col.name);
                    }
                });
            });
           
            // Also count custom fields from data
            Object.values(systemData.sampleData).forEach(customerData => {
                Object.values(customerData).forEach(accountData => {
                    Object.values(accountData).forEach(tableData => {
                        Object.keys(tableData).forEach(fieldName => {
                            allFields.add(fieldName);
                        });
                    });
                });
            });
           
            const totalFields = Array.from(allFields).length;
            const commonFields = Array.from(allFields).filter(field =>
                systemData.tables.every(table =>
                    table.columns.some(col => col.name === field)
                )
            ).length;
           
            const uniqueFields = Array.from(allFields).filter(field =>
                systemData.tables.filter(table =>
                    table.columns.some(col => col.name === field)
                ).length === 1
            ).length;
           
            document.getElementById('totalColumns').textContent = totalFields;
            document.getElementById('commonColumns').textContent = commonFields;
            document.getElementById('uniqueColumns').textContent = uniqueFields;
            document.getElementById('requiredCount').textContent = requiredFields.size;
            document.getElementById('smartAddCount').textContent = currentState.smartAddCount;
            document.getElementById('autoPopulated').textContent = currentState.autoPopulatedCount;
            document.getElementById('bandTablesCount').textContent = bandTables.length;
        }

        // Update final table preview
        function updateFinalTablePreview() {
            const preview = document.getElementById('finalTablePreview');
            preview.innerHTML = '';
           
            systemData.finalTable.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.className = 'preview-item';
               
                // Generate value based on transformation
                let value = generateFinalTableValue(item);
               
                itemElement.innerHTML = `
                    <div class="preview-field">${item.field}</div>
                    <div class="preview-value">${value}</div>
                    <div style="font-size: 0.7rem; color: var(--gray); margin-top: 5px;">
                        <i class="fas fa-database"></i> Source: ${item.source}
                        ${item.required ? '<span style="color: var(--danger); margin-left: 10px;">REQUIRED</span>' : ''}
                    </div>
                `;
                preview.appendChild(itemElement);
            });
        }

        // Generate final table value
        function generateFinalTableValue(item) {
            const customer = currentState.currentCustomer;
            const account = currentState.currentAccount;
            const ticketData = systemData.sampleData[customer]?.[account]?.ticket || {};
            const rateData = systemData.sampleData[customer]?.[account]?.rate || {};
            const finalData = systemData.sampleData[customer]?.[account]?.final || {};
           
            // Check if we have a direct value in final table data
            if (finalData[item.field]) {
                return finalData[item.field];
            }
           
            switch(item.field) {
                case "Request ID":
                    currentState.currentRequestId++;
                    return `REQ-${currentState.currentRequestId}`;
                case "Subject":
                    return `${ticketData["Activity Details"] || "Service"} | ${ticketData.City || "City"} | ${ticketData.Country || "Country"} | ${ticketData["Customer Name"] || "Customer"}`;
                case "CUSTOMER REFERENCE":
                    return ticketData["Customer Ticket Number"] || "—";
                case "Site":
                    return ticketData["Site Address"] || "—";
                case "Account":
                    return ticketData["Customer Name"] || "—";
                case "Country":
                    return ticketData["Country"] || "—";
                case "City":
                    return ticketData["City"] || "—";
                case "Assigned Technician":
                    return ticketData["Technician Name"] || "—";
                case "PO NUMBER":
                    return ticketData["PO number"] || "—";
                case "Vendor PO":
                    if (ticketData["PO number"] && ticketData["Country"]) {
                        const countryCode = getCountryCode(ticketData["Country"]);
                        return `${countryCode}-PO-${ticketData["PO number"].split('-').pop()}`;
                    }
                    return "—";
                case "Region":
                    return rateData["Region"] || "—";
                case "Priority":
                    return ticketData["Ticket Priority"] || "—";
                case "Requester":
                    return "System Admin";
                case "Created Date":
                    return ticketData["Customer Ticket Created Date"] || "—";
                case "Start Date/Time":
                    return `${ticketData["Technician IN Date"] || ""} ${ticketData["Technician IN Time"] || ""}`.trim() || "—";
                case "End Date/Time":
                    return `${ticketData["Technician OUT Date"] || ""} ${ticketData["Technician OUT Time"] || ""}`.trim() || "—";
                case "Engineer details":
                    if (ticketData["Technician Name"] && ticketData["Partner Name"]) {
                        return `${ticketData["Technician Name"]} - ${ticketData["Partner Name"]}`;
                    }
                    return "—";
                case "PRE Visit":
                    return "Yes";
                case "POST Visit":
                    return "Yes";
                case "Revenue":
                    return calculateRevenue();
                case "Cost":
                    return calculateCost();
                case "Profit":
                    return calculateProfit();
                case "Margin %":
                    return calculateMargin();
                default:
                    return "Auto-generated";
            }
        }

        // Helper functions
        function getCountryCode(country) {
            const codes = {
                "India": "INDO",
                "Germany": "GER",
                "USA": "USA",
                "UK": "UK",
                "Singapore": "SG",
                "Australia": "AUS"
            };
            return codes[country] || country.substring(0, 4).toUpperCase();
        }

        function calculateRevenue() {
            // Simplified calculation
            const customer = currentState.currentCustomer;
            const account = currentState.currentAccount;
            const ticketData = systemData.sampleData[customer]?.[account]?.ticket || {};
            const totalCost = parseFloat(ticketData["Total Cost"]) || 0;
            return (totalCost * 1.2).toFixed(2); // Add 20% margin
        }

        function calculateCost() {
            const customer = currentState.currentCustomer;
            const account = currentState.currentAccount;
            const ticketData = systemData.sampleData[customer]?.[account]?.ticket || {};
            return parseFloat(ticketData["Total Cost"]) || "0.00";
        }

        function calculateProfit() {
            const revenue = parseFloat(calculateRevenue()) || 0;
            const cost = parseFloat(calculateCost()) || 0;
            return (revenue - cost).toFixed(2);
        }

        function calculateMargin() {
            const revenue = parseFloat(calculateRevenue()) || 0;
            const profit = parseFloat(calculateProfit()) || 0;
            if (revenue === 0) return "0.00";
            return ((profit / revenue) * 100).toFixed(2);
        }

        function getTransformationLogic(fieldName) {
            const mapping = systemData.fieldMapping[fieldName];
            if (mapping && mapping.transformation) {
                return mapping.transformation;
            }
           
            const finalField = systemData.finalTable.find(f => f.transformation.includes(fieldName) || f.field === fieldName);
            if (finalField) {
                return finalField.transformation;
            }
           
            return "Direct mapping";
        }

        // Load sample data
        function loadSampleData(customer) {
            currentState.currentCustomer = customer;
            currentState.currentAccount = customer === 'hcl' ? 'rev' : 'prod';
           
            // Update dropdowns
            document.getElementById('customerSelect').value = customer;
            document.getElementById('accountSelect').value = currentState.currentAccount;
           
            // Render matrix with new data
            if (currentState.isDataView) {
                renderMatrixBody();
                updateFinalTablePreview();
                showNotification(`Loaded ${customer.toUpperCase()} sample data`, 'success');
            }
        }

        // Clear all data
        function clearAllData() {
            const customer = currentState.currentCustomer;
            const account = currentState.currentAccount;
           
            // Clear all data for current customer/account
            ['ticket', 'rate', 'dispatch', 'standby', 'dedicated', 'sv', 'project', 'final'].forEach(tableKey => {
                if (systemData.sampleData[customer] && systemData.sampleData[customer][account]) {
                    systemData.sampleData[customer][account][tableKey] = {};
                }
            });
           
            // Reset counters
            currentState.smartAddCount = 0;
            currentState.autoPopulatedCount = 0;
            currentState.allData = {};
           
            // Update display
            renderMatrixBody();
            updateMatrixStats();
            updateFinalTablePreview();
           
            showNotification('All data cleared for current customer/account', 'warning');
        }

        // Generate random data
        function generateRandomData() {
            const customer = currentState.currentCustomer;
            const account = currentState.currentAccount;
           
            // Generate data for all tables
            systemData.tables.forEach(table => {
                if (!systemData.sampleData[customer]) {
                    systemData.sampleData[customer] = {};
                }
                if (!systemData.sampleData[customer][account]) {
                    systemData.sampleData[customer][account] = {};
                }
               
                const tableKey = table.key;
                if (!systemData.sampleData[customer][account][tableKey]) {
                    systemData.sampleData[customer][account][tableKey] = {};
                }
               
                // Generate random data for each column
                table.columns.forEach(col => {
                    const value = generateSampleData(col.name, table.id);
                    systemData.sampleData[customer][account][tableKey][col.name] = value;
                });
            });
           
            // Update display
            renderMatrixBody();
            updateMatrixStats();
            updateFinalTablePreview();
           
            showNotification('Random data generated for all tables', 'success');
        }

        // Add quick data input
        function addQuickData() {
            const fieldName = document.getElementById('quickField').value.trim();
            const value = document.getElementById('quickValue').value.trim();
            const table = document.getElementById('quickTable').value;
           
            if (!fieldName || !value) {
                showNotification('Please enter both field name and value', 'warning');
                return;
            }
           
            // Map table names to IDs
            const tableMap = {
                'all': 'all',
                'ticket': 1,
                'rate': 2,
                'dispatch': 3,
                'standby': 4,
                'dedicated': 5,
                'sv': 6,
                'project': 7,
                'final': 8
            };
           
            if (table === 'all') {
                // Update all tables
                systemData.tables.forEach(t => {
                    updateFieldData(fieldName, t.id, value);
                });
            } else {
                updateFieldData(fieldName, tableMap[table], value);
            }
           
            // Clear inputs
            document.getElementById('quickField').value = '';
            document.getElementById('quickValue').value = '';
           
            // Update display
            renderMatrixBody();
            updateFinalTablePreview();
           
            showNotification(`Added ${fieldName} = ${value} to ${table}`, 'success');
        }

        // Toggle smart add
        function toggleSmartAdd() {
            currentState.smartAddActive = document.getElementById('smartAddToggle').checked;
            document.getElementById('smartAddStatus').textContent = currentState.smartAddActive ? 'ACTIVE' : 'INACTIVE';
        }

        // Apply filters
        function applyFilters() {
            // Update filter state from UI
            filterState.tableFilter = document.getElementById('tableFilter').value;
            filterState.fieldGroup = document.getElementById('fieldGroupFilter').value;
            filterState.sortBy = document.getElementById('sortOrder').value;
            filterState.inputMode = document.getElementById('inputMode').value;
            filterState.ragStatus = document.getElementById('ragFilter').value;
            filterState.dataType = document.getElementById('dataTypeFilter').value;
            filterState.showRequiredOnly = document.getElementById('showRequiredOnly').checked;
            filterState.showEmptyOnly = document.getElementById('showEmptyOnly').checked;
            filterState.showTransformation = document.getElementById('showTransformation').checked;

            renderMatrixBody();
            updateFinalTablePreview();
        }

        // Reset filters
        function resetFilters() {
            document.getElementById('tableFilter').value = "SHOW_ALL";
            document.getElementById('fieldGroupFilter').value = "ALL";
            document.getElementById('sortOrder').value = "ALPHABETICAL_ASC";
            document.getElementById('inputMode').value = "NORMAL";
            document.getElementById('ragFilter').value = "ALL";
            document.getElementById('dataTypeFilter').value = "ALL";
            document.getElementById('showRequiredOnly').checked = false;
            document.getElementById('showEmptyOnly').checked = false;
            document.getElementById('showTransformation').checked = false;
            document.getElementById('highlightMode').value = "NONE";
            document.getElementById('displayOptions').value = "SHOW_DATA";
            document.getElementById('displayMode').value = "FLAT";

            Object.assign(filterState, {
                tableFilter: "SHOW_ALL",
                fieldGroup: "ALL",
                sortBy: "ALPHABETICAL_ASC",
                inputMode: "NORMAL",
                ragStatus: "ALL",
                dataType: "ALL",
                showRequiredOnly: false,
                showEmptyOnly: false,
                showTransformation: false,
                highlightMode: "NONE",
                displayOptions: "SHOW_DATA",
                displayMode: "FLAT"
            });

            renderMatrixBody();
            showNotification("All filters reset", "success");
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : type === 'warning' ? '#f59e0b' : '#3b82f6'};
                color: white;
                border-radius: var(--border-radius);
                box-shadow: var(--shadow-lg);
                z-index: 2000;
                display: flex;
                align-items: center;
                gap: 10px;
                animation: slideIn 0.3s ease;
                max-width: 400px;
            `;
           
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                ${message}
            `;
           
            document.body.appendChild(notification);
           
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
           
            // Add animation styles if not present
            if (!document.querySelector('#notification-animations')) {
                const style = document.createElement('style');
                style.id = 'notification-animations';
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes slideOut {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100%); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
        }

        // The following functions are from the previous enhanced version
        // They are kept as placeholders since they were in the previous code

        function applyHighlighting() {
            filterState.highlightMode = document.getElementById('highlightMode').value;
            const rows = document.querySelectorAll('#matrixBody tr');
           
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const fieldName = row.getAttribute('data-field');
               
                cells.forEach(cell => {
                    // Remove all highlighting classes
                    cell.classList.remove('highlight-column', 'highlight-duplicate', 'highlight-match', 
                                         'highlight-smart-add', 'highlight-required', 'highlight-final-table',
                                         'validation-error', 'validation-success', 'highlight-band-table');
                   
                    const hasField = cell.getAttribute('data-has-field') === 'true';
                    const tableId = cell.getAttribute('data-table');
                   
                    switch(filterState.highlightMode) {
                        case 'BAND_TABLES':
                            const table = systemData.tables.find(t => t.id == tableId);
                            if (table && table.hasBandDetails) {
                                cell.classList.add('highlight-band-table');
                            }
                            break;
                        case 'SOURCE_TABLE':
                            if (tableId === '1') cell.classList.add('highlight-column');
                            break;
                        case 'REQUIRED_STATUS':
                            if (row.getAttribute('data-required') === 'true') {
                                cell.classList.add('highlight-required');
                            }
                            break;
                        case 'RAG_STATUS':
                            const rag = row.getAttribute('data-rag');
                            if (rag === 'red') cell.style.borderLeft = '3px solid var(--danger)';
                            else if (rag === 'amber') cell.style.borderLeft = '3px solid var(--warning)';
                            else if (rag === 'green') cell.style.borderLeft = '3px solid var(--success)';
                            break;
                        case 'NON_EXISTENT':
                            if (!hasField) {
                                cell.classList.add('validation-error');
                            }
                            break;
                        case 'EMPTY':
                            const input = cell.querySelector('input');
                            if (input && (!input.value || input.value.trim() === '')) {
                                cell.classList.add('validation-error');
                            }
                            break;
                    }
                });
            });
        }

        function applyDisplayOptions() {
            filterState.displayOptions = document.getElementById('displayOptions').value;
            applyFilters();
        }

        function applyDisplayMode() {
            filterState.displayMode = document.getElementById('displayMode').value;
            applyFilters();
        }

        function handleInputMode() {
            const inputMode = document.getElementById('inputMode').value;
            filterState.inputMode = inputMode;
           
            // Show/hide site category filter
            const siteCategoryGroup = document.getElementById('siteCategoryGroup');
            if (inputMode === "SITE_CATEGORY") {
                siteCategoryGroup.style.display = 'block';
            } else {
                siteCategoryGroup.style.display = 'none';
            }
           
            // Show/hide band quick actions
            const bandQuickActions = document.getElementById('bandQuickActions');
            if (inputMode === "BAND_MODE") {
                bandQuickActions.style.display = 'flex';
                document.getElementById('showBandDetails').checked = true;
                toggleBandDetails();
            } else {
                bandQuickActions.style.display = 'none';
                document.getElementById('showBandDetails').checked = false;
                toggleBandDetails();
            }
           
            applyFilters();
           
            const modeNames = {
                'NORMAL': 'Normal Mode',
                'FINAL_TABLE': 'Final Table Centric Mode',
                'TABLE_SPECIFIC': 'Table-Specific Mode',
                'SITE_CATEGORY': 'Site Category Based Mode',
                'BULK': 'Smart Bulk Input Mode',
                'VALIDATION_FIRST': 'Validation-First Mode',
                'BAND_MODE': 'Band Details Mode'
            };
           
            showNotification(`${modeNames[inputMode]} activated`, 'info');
        }

        function filterBySiteCategory() {
            currentState.currentSiteCategory = document.getElementById('siteCategory').value;
            applyFilters();
            showNotification(`Filtering by Site Category: ${currentState.currentSiteCategory}`, 'info');
        }

        function showBulkInputModal() {
            document.getElementById('bulkInputModal').classList.add('active');
        }

        function closeBulkInputModal() {
            document.getElementById('bulkInputModal').classList.remove('active');
        }

        function processBulkInput() {
            const textarea = document.getElementById('bulkTextarea');
            const lines = textarea.value.split('\n').filter(line => line.trim());
           
            let processedCount = 0;
            lines.forEach(line => {
                const parts = line.split(',').map(part => part.trim());
                if (parts.length >= 2) {
                    const fieldName = parts[0];
                    const value = parts[1];
                    const tables = parts[2] || 'all';
                   
                    updateFieldWithBulkInput(fieldName, value, tables);
                    processedCount++;
                }
            });
           
            showNotification(`Processed ${processedCount} records from bulk input`, 'success');
            closeBulkInputModal();
            renderMatrixBody();
            updateFinalTablePreview();
        }

        function updateFieldWithBulkInput(fieldName, value, tables) {
            let tableList = [];
            if (tables === 'all') {
                tableList = systemData.tables.map(t => t.id);
            } else {
                const tableMap = {
                    'ticket': 1, 'rate': 2, 'dispatch': 3,
                    'standby': 4, 'dedicated': 5, 'sv': 6, 
                    'project': 7, 'final': 8
                };
                tableList = tables.split(';').map(name => tableMap[name.trim()]).filter(Boolean);
            }
           
            tableList.forEach(tableId => {
                updateFieldData(fieldName, tableId, value);
            });
        }

        function exportToExcel() {
            const data = collectExportData();
            const csv = convertToCSV(data);
            downloadCSV(csv, 'ticket_system_export.csv');
            showNotification('Excel export generated successfully', 'success');
        }

        function exportToPDF() {
            showNotification('PDF export feature would be implemented with jsPDF library', 'info');
        }

        function exportValidationReport() {
            const report = generateValidationReport();
            const csv = convertToCSV(report);
            downloadCSV(csv, 'validation_report.csv');
            showNotification('Validation report exported', 'success');
        }

        function collectExportData() {
            const data = [];
            const rows = document.querySelectorAll('#matrixBody tr[data-field]');
           
            rows.forEach(row => {
                const fieldName = row.getAttribute('data-field');
                const rowData = { 'Field Name': fieldName };
               
                systemData.tables.forEach((table, index) => {
                    const cell = row.querySelector(`td:nth-child(${index + 2})`);
                    const input = cell?.querySelector('input');
                    if (input) {
                        rowData[table.name] = input.value || '';
                    } else {
                        rowData[table.name] = cell?.textContent.trim() || '';
                    }
                });
               
                data.push(rowData);
            });
           
            return data;
        }

        function convertToCSV(data) {
            if (data.length === 0) return '';
           
            const headers = Object.keys(data[0]);
            const csvRows = [headers.join(',')];
           
            data.forEach(row => {
                const values = headers.map(header => {
                    const value = row[header];
                    return `"${value ? value.toString().replace(/"/g, '""') : ''}"`;
                });
                csvRows.push(values.join(','));
            });
           
            return csvRows.join('\n');
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function validateAllFields() {
            currentState.validationErrors = [];
            const requiredFields = [];
           
            systemData.tables.forEach(table => {
                table.columns.forEach(col => {
                    if (col.required) {
                        requiredFields.push({
                            name: col.name,
                            table: table.name,
                            tableId: table.id
                        });
                    }
                });
            });
           
            requiredFields.forEach(field => {
                const data = getFieldData(field.name, field.tableId);
                if (!data || data === "" || data === "—") {
                    currentState.validationErrors.push({
                        field: field.name,
                        table: field.table,
                        message: `Required field "${field.name}" is empty in ${field.table}`
                    });
                }
            });
           
            updateValidationDisplay();
           
            if (currentState.validationErrors.length === 0) {
                showNotification('All required fields are valid!', 'success');
            } else {
                showNotification(`Found ${currentState.validationErrors.length} validation errors`, 'danger');
            }
        }

        function updateValidationDisplay() {
            const rows = document.querySelectorAll('#matrixBody tr[data-field]');
           
            rows.forEach(row => {
                const fieldName = row.getAttribute('data-field');
                const isError = currentState.validationErrors.some(error => error.field === fieldName);
               
                if (isError) {
                    row.classList.add('validation-error');
                    row.classList.remove('validation-success');
                } else {
                    row.classList.add('validation-success');
                    row.classList.remove('validation-error');
                }
            });
        }

        function generateValidationReport() {
            return currentState.validationErrors.map(error => ({
                'Field Name': error.field,
                'Table': error.table,
                'Status': 'ERROR',
                'Message': error.message,
                'Timestamp': new Date().toISOString()
            }));
        }

        function toggleAdvancedFilters() {
            const panel = document.getElementById('advancedFilters');
            panel.classList.toggle('active');
        }

        function downloadTemplate() {
            const template = `Field Name,Value,Tables
Site Category,Dispatch,ticket;dispatch;sv
Customer Name,HCL Technologies,all
Country,India,all
PO number,INDOPO-6502,ticket;dispatch;dedicated;sv
Technician Name,Rajesh Kumar,ticket;dispatch;sv;dedicated
Currency,INR,all
Ticket Priority,P1,ticket;dispatch;sv`;

            const blob = new Blob([template], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'bulk_input_template.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
           
            showNotification('Template downloaded successfully', 'success');
        }

        function renderGroupedView(filteredFields) {
            const body = document.getElementById('matrixBody');
            const groups = {};
           
            filteredFields.forEach(field => {
                if (!groups[field.group]) {
                    groups[field.group] = [];
                }
                groups[field.group].push(field);
            });
           
            Object.keys(groups).forEach(groupName => {
                const headerRow = document.createElement('tr');
                headerRow.className = 'group-header';
                const headerCell = document.createElement('td');
                headerCell.colSpan = systemData.tables.length + 1;
                headerCell.innerHTML = `
                    <div style="background: var(--light); padding: 10px; border-radius: 6px; font-weight: 600;">
                        <i class="fas fa-folder"></i> ${groupName.toUpperCase()}
                        <span style="font-size: 0.8rem; color: var(--gray); margin-left: 10px;">
                            ${groups[groupName].length} fields
                        </span>
                    </div>
                `;
                headerRow.appendChild(headerCell);
                body.appendChild(headerRow);
               
                groups[groupName].forEach(field => {
                    const row = document.createElement('tr');
                    row.setAttribute('data-field', field.name);
                   
                    const nameCell = document.createElement('td');
                    nameCell.innerHTML = `<strong>${field.name}</strong>`;
                    row.appendChild(nameCell);
                   
                    systemData.tables.forEach(table => {
                        const cell = document.createElement('td');
                        const hasField = field.tables.includes(table.id);
                        const data = getFieldData(field.name, table.id);
                        
                        if (currentState.isDataView) {
                            const inputClass = hasField ? 'cell-input' : 'cell-input non-existent';
                            cell.innerHTML = `
                                <div class="matrix-cell-content">
                                    <div class="cell-value">
                                        <input type="text"
                                               class="${inputClass}"
                                               value="${data || ''}"
                                               data-field="${field.name}"
                                               data-table="${table.id}"
                                               placeholder="${hasField ? 'Enter value...' : 'Field not in table'}">
                                    </div>
                                    ${table.hasBandDetails && currentState.showBandDetails ? 
                                        `<button class="cell-band-btn" onclick="showCellBandDetails('${field.name}', ${table.id}, '${table.key}')" title="View Band Details">
                                            <i class="fas fa-layer-group"></i>
                                        </button>` : ''}
                                </div>
                                ${!hasField ? '<div class="editable-indicator"><i class="fas fa-edit"></i></div>' : ''}
                            `;
                            cell.style.position = 'relative';
                            
                            if (table.hasBandDetails && currentState.showBandDetails) {
                                cell.classList.add('cell-with-band');
                            }
                        } else {
                            cell.innerHTML = hasField ? '<div class="cell-check">✔</div>' : '<div class="cell-cross">✖</div>';
                            cell.className = hasField ? 'cell-check' : 'cell-cross';
                        }
                       
                        cell.setAttribute('data-table', table.id);
                        cell.setAttribute('data-has-field', hasField);
                        row.appendChild(cell);
                    });
                   
                    body.appendChild(row);
                });
            });
        }

        function renderTableWiseView(filteredFields) {
            // Similar to grouped view but by table
            renderFlatView(filteredFields);
        }

        // BAND DETAILS FUNCTIONS

        // Function to toggle band details display
        function toggleBandDetails() {
            currentState.showBandDetails = document.getElementById('showBandDetails').checked;
            const quickActions = document.getElementById('bandQuickActions');
            
            if (currentState.showBandDetails) {
                quickActions.style.display = 'flex';
                document.getElementById('bandStatus').textContent = 'ACTIVE';
            } else {
                quickActions.style.display = 'none';
                document.getElementById('bandStatus').textContent = 'READY';
            }
            
            renderMatrixBody();
        }

        // Function to generate band data
        function generateBandData() {
            const customer = currentState.currentCustomer;
            
            // Generate dedicated band data
            if (bandDetailsData.dedicated.sampleData[customer]) {
                currentState.bandData.dedicated = bandDetailsData.dedicated.sampleData[customer];
            }
            
            // Generate dispatch band data
            if (bandDetailsData.dispatch.sampleData[customer]) {
                currentState.bandData.dispatch = bandDetailsData.dispatch.sampleData[customer];
            }
            
            // Generate project band data
            if (bandDetailsData.project.sampleData[customer]) {
                currentState.bandData.project = bandDetailsData.project.sampleData[customer];
            }
            
            // Update matrix to show band indicators
            renderMatrixBody();
            showNotification('Band data generated successfully', 'success');
        }

        // Function to show band details modal
        function showBandDetailsModal(tableType = 'all') {
            const modal = document.getElementById('bandDetailsModal');
            const title = document.getElementById('bandModalTitle');
            const content = document.getElementById('bandModalContent');
            
            let html = '';
            
            if (tableType === 'all' || tableType === 'dedicated') {
                html += renderDedicatedBandDetails();
            }
            
            if (tableType === 'all' || tableType === 'dispatch') {
                html += renderDispatchBandDetails();
            }
            
            if (tableType === 'all' || tableType === 'project') {
                html += renderProjectBandDetails();
            }
            
            title.textContent = tableType === 'all' ? 'All Band Structures' : `${bandDetailsData[tableType].title}`;
            content.innerHTML = html;
            modal.classList.add('active');
        }

        // Function to render dedicated band details
        function renderDedicatedBandDetails() {
            const data = bandDetailsData.dedicated;
            const customer = currentState.currentCustomer;
            const customerData = currentState.bandData.dedicated || data.sampleData[customer] || data.sampleData['HCL Technologies'];
            
            let html = `
                <div class="band-details-section">
                    <h4><i class="fas fa-user-tie"></i> ${data.title}</h4>
                    <p style="color: var(--gray); margin-bottom: 15px;">${data.description}</p>
                    
                    <div class="band-table-container">
                        <table class="band-table">
                            <thead>
                                <tr class="rc-band-group">
                                    <th colspan="${data.columns.length + 1}">${data.groups[0].title}</th>
                                </tr>
                                <tr class="rc-band-sub">
                                    <th>Band</th>
                                    ${data.columns.map(col => `<th>${col}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody>`;
            
            data.bands.forEach(band => {
                html += `
                    <tr>
                        <td><strong>${band}</strong></td>
                        ${data.columns.map((col, idx) => `
                            <td>${customerData?.[band]?.[idx] || '—'}</td>
                        `).join('')}
                    </tr>`;
            });
            
            html += `
                            </tbody>
                        </table>
                    </div>
                    
                    <div style="margin-top: 15px; font-size: 0.9rem; color: var(--gray);">
                        <i class="fas fa-info-circle"></i> 
                        With Benefits = Includes all benefits | Without Benefits = Base rate only
                    </div>
                </div>`;
            
            return html;
        }

        // Function to render dispatch band details
        function renderDispatchBandDetails() {
            const data = bandDetailsData.dispatch;
            const customer = currentState.currentCustomer;
            
            let html = `
                <div class="band-details-section">
                    <h4><i class="fas fa-truck-fast"></i> ${data.title}</h4>
                    <p style="color: var(--gray); margin-bottom: 15px;">${data.description}</p>`;
            
            data.groups.forEach(group => {
                const groupData = bandDetailsData.dispatch.sampleData[customer]?.[group.title] || 
                                bandDetailsData.dispatch.sampleData['HCL Technologies']?.[group.title];
                
                html += `
                    <div style="margin-bottom: 20px;">
                        <h5 style="color: var(--dark); margin-bottom: 10px;">${group.title}</h5>
                        <div class="band-table-container">
                            <table class="band-table" style="width: 100%;">
                                <thead>
                                    <tr class="rc-band-sub">
                                        <th>Service Type</th>
                                        <th>Rate</th>
                                        <th>Description</th>
                                    </tr>
                                </thead>
                                <tbody>`;
                
                group.bands.forEach(band => {
                    html += `
                        <tr>
                            <td><strong>${band}</strong></td>
                            <td>${groupData?.[band] || '—'}</td>
                            <td>${getDispatchBandDescription(band)}</td>
                        </tr>`;
                });
                
                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>`;
            });
            
            html += `</div>`;
            return html;
        }

        // Helper function for dispatch band descriptions
        function getDispatchBandDescription(band) {
            const descriptions = {
                '4 hour': '4-hour response time guarantee',
                'SBD': 'Same Business Day response',
                'NBD': 'Next Business Day response',
                '2 BD': '2 Business Days response',
                '3 BD': '3 Business Days response',
                '4 BD': '4 Business Days response',
                'Additional Hour': 'Additional hour rate beyond base period'
            };
            return descriptions[band] || 'Standard dispatch service';
        }

        // Function to render project band details
        function renderProjectBandDetails() {
            const data = bandDetailsData.project;
            const customer = currentState.currentCustomer;
            
            let html = `
                <div class="band-details-section">
                    <h4><i class="fas fa-project-diagram"></i> ${data.title}</h4>
                    <p style="color: var(--gray); margin-bottom: 15px;">${data.description}</p>`;
            
            data.groups.forEach(group => {
                const groupData = bandDetailsData.project.sampleData[customer]?.[group.title] || 
                                bandDetailsData.project.sampleData['HCL Technologies']?.[group.title];
                
                html += `
                    <div style="margin-bottom: 20px;">
                        <h5 style="color: var(--dark); margin-bottom: 10px;">${group.title}</h5>
                        <div class="band-table-container">
                            <table class="band-table">
                                <thead>
                                    <tr class="rc-band-sub">
                                        <th>Band</th>
                                        <th>Monthly Rate</th>
                                        <th>Description</th>
                                    </tr>
                                </thead>
                                <tbody>`;
                
                group.bands.forEach(band => {
                    html += `
                        <tr>
                            <td><strong>${band}</strong></td>
                            <td>${groupData?.[band] || '—'}</td>
                            <td>${getProjectBandDescription(band, group.title)}</td>
                        </tr>`;
                });
                
                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>`;
            });
            
            html += `</div>`;
            return html;
        }

        // Helper function for project band descriptions
        function getProjectBandDescription(band, groupTitle) {
            const level = band.replace('Band ', '');
            const isShortTerm = groupTitle.includes('Short Term');
            const rateType = isShortTerm ? 'premium' : 'standard';
            return `Level ${level} engineer - ${rateType} project rate`;
        }

        // Function to close band details modal
        function closeBandDetailsModal() {
            document.getElementById('bandDetailsModal').classList.remove('active');
        }

        // Function to show band details for specific table
        function showBandDetailsForTable(tableType) {
            showBandDetailsModal(tableType);
        }

        // Function to show band details for specific cell
        function showCellBandDetails(fieldName, tableId, tableKey) {
            const table = systemData.tables.find(t => t.id === tableId);
            if (!table) return;
            
            // Get band type from table key
            let bandType = tableKey;
            if (bandType === 'dedicated') {
                showBandDetailsModal('dedicated');
            } else if (bandType === 'dispatch') {
                showBandDetailsModal('dispatch');
            } else if (bandType === 'project') {
                showBandDetailsModal('project');
            }
        }

        // Function to show band quick preview
        function showBandQuickPreview() {
            const select = document.getElementById('bandPreviewSelect');
            const tableType = select.value;
            
            if (!tableType) return;
            
            const quickView = document.getElementById('bandQuickView');
            const title = document.getElementById('quickViewTitle');
            const content = document.getElementById('quickViewContent');
            
            let html = '';
            
            if (tableType === 'dedicated') {
                html = renderQuickDedicatedView();
                title.textContent = 'Dedicated Band Preview';
            } else if (tableType === 'dispatch') {
                html = renderQuickDispatchView();
                title.textContent = 'Dispatch Band Preview';
            } else if (tableType === 'project') {
                html = renderQuickProjectView();
                title.textContent = 'Project Band Preview';
            } else if (tableType === 'all') {
                html = renderAllBandsQuickView();
                title.textContent = 'All Band Structures';
            }
            
            content.innerHTML = html;
            quickView.classList.add('active');
            
            // Auto-close after 10 seconds
            setTimeout(() => {
                quickView.classList.remove('active');
            }, 10000);
        }

        // Function to close quick view
        function closeQuickView() {
            document.getElementById('bandQuickView').classList.remove('active');
        }

        // Quick view renderers
        function renderQuickDedicatedView() {
            const data = bandDetailsData.dedicated;
            const customer = currentState.currentCustomer;
            const customerData = currentState.bandData.dedicated || data.sampleData[customer] || data.sampleData['HCL Technologies'];
            
            let html = '<div style="max-height: 300px; overflow-y: auto;">';
            html += '<table style="width: 100%; font-size: 0.8rem;">';
            html += '<tr><th>Band</th><th>With Benefits</th><th>Without Benefits</th></tr>';
            
            data.bands.forEach(band => {
                html += `<tr>
                    <td><strong>${band}</strong></td>
                    <td>${customerData?.[band]?.[0] || '—'}</td>
                    <td>${customerData?.[band]?.[1] || '—'}</td>
                </tr>`;
            });
            
            html += '</table></div>';
            return html;
        }

        function renderQuickDispatchView() {
            const data = bandDetailsData.dispatch;
            let html = '<div style="max-height: 300px; overflow-y: auto;">';
            
            data.groups.forEach(group => {
                html += `<h5 style="margin: 10px 0 5px 0; font-size: 0.9rem;">${group.title}</h5>`;
                html += '<div style="display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px;">';
                
                group.bands.forEach(band => {
                    html += `<span style="background: var(--light); padding: 3px 8px; border-radius: 4px; font-size: 0.8rem;">${band}</span>`;
                });
                
                html += '</div>';
            });
            
            html += '</div>';
            return html;
        }

        function renderQuickProjectView() {
            const data = bandDetailsData.project;
            let html = '<div style="max-height: 300px; overflow-y: auto;">';
            
            data.groups.forEach(group => {
                html += `<h5 style="margin: 10px 0 5px 0; font-size: 0.9rem;">${group.title}</h5>`;
                html += '<div style="display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px;">';
                
                group.bands.forEach(band => {
                    html += `<span style="background: var(--light); padding: 3px 8px; border-radius: 4px; font-size: 0.8rem;">${band}</span>`;
                });
                
                html += '</div>';
            });
            
            html += '</div>';
            return html;
        }

        function renderAllBandsQuickView() {
            let html = '<div style="max-height: 300px; overflow-y: auto;">';
            
            // Dedicated
            html += '<h5 style="margin: 10px 0 5px 0; font-size: 0.9rem;"><i class="fas fa-user-tie"></i> Dedicated</h5>';
            html += '<div style="display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px;">';
            bandDetailsData.dedicated.bands.forEach(band => {
                html += `<span style="background: #e0f2fe; padding: 3px 8px; border-radius: 4px; font-size: 0.8rem;">${band}</span>`;
            });
            html += '</div>';
            
            // Dispatch
            html += '<h5 style="margin: 10px 0 5px 0; font-size: 0.9rem;"><i class="fas fa-truck-fast"></i> Dispatch</h5>';
            html += '<div style="display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px;">';
            bandDetailsData.dispatch.groups.forEach(group => {
                group.bands.forEach(band => {
                    html += `<span style="background: #fef3c7; padding: 3px 8px; border-radius: 4px; font-size: 0.8rem;">${band}</span>`;
                });
            });
            html += '</div>';
            
            // Projects
            html += '<h5 style="margin: 10px 0 5px 0; font-size: 0.9rem;"><i class="fas fa-project-diagram"></i> Projects</h5>';
            html += '<div style="display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px;">';
            bandDetailsData.project.groups.forEach(group => {
                group.bands.forEach(band => {
                    html += `<span style="background: #d1fae5; padding: 3px 8px; border-radius: 4px; font-size: 0.8rem;">${band}</span>`;
                });
            });
            html += '</div>';
            
            html += '</div>';
            return html;
        }

        // Function to export band data to CSV
        function exportBandToCSV() {
            const data = [];
            const customer = currentState.currentCustomer;
            
            // Collect dedicated band data
            if (currentState.bandData.dedicated) {
                Object.entries(currentState.bandData.dedicated).forEach(([band, rates]) => {
                    data.push({
                        'Table': 'Dedicated',
                        'Band': band,
                        'With Benefits': rates[0],
                        'Without Benefits': rates[1],
                        'Customer': customer
                    });
                });
            }
            
            // Collect dispatch band data
            if (currentState.bandData.dispatch) {
                Object.entries(currentState.bandData.dispatch).forEach(([category, bands]) => {
                    Object.entries(bands).forEach(([band, rate]) => {
                        data.push({
                            'Table': 'Dispatch',
                            'Category': category,
                            'Service Type': band,
                            'Rate': rate,
                            'Customer': customer
                        });
                    });
                });
            }
            
            // Collect project band data
            if (currentState.bandData.project) {
                Object.entries(currentState.bandData.project).forEach(([duration, bands]) => {
                    Object.entries(bands).forEach(([band, rate]) => {
                        data.push({
                            'Table': 'Project',
                            'Duration': duration,
                            'Band': band,
                            'Monthly Rate': rate,
                            'Customer': customer
                        });
                    });
                });
            }
            
            if (data.length === 0) {
                showNotification('No band data to export', 'warning');
                return;
            }
            
            const csv = convertToCSV(data);
            downloadCSV(csv, `band_details_${customer}.csv`);
            showNotification('Band details exported to CSV', 'success');
        }

        // Function to apply band data to matrix
        function applyBandToMatrix() {
            const customer = currentState.currentCustomer;
            
            // Apply dedicated band data
            if (currentState.bandData.dedicated) {
                // Update sample data with band rates
                Object.entries(currentState.bandData.dedicated).forEach(([band, rates]) => {
                    // Update dedicated table data
                    if (systemData.sampleData[customer] && systemData.sampleData[customer][currentState.currentAccount]) {
                        systemData.sampleData[customer][currentState.currentAccount].dedicated = 
                            systemData.sampleData[customer][currentState.currentAccount].dedicated || {};
                        
                        // Update band-related fields
                        systemData.sampleData[customer][currentState.currentAccount].dedicated["Band"] = band;
                        systemData.sampleData[customer][currentState.currentAccount].dedicated["Monthly rate"] = 
                            rates[0].replace('$', '').replace(',', ''); // Remove $ and commas
                    }
                });
            }
            
            showNotification('Band data applied to matrix', 'success');
            closeBandDetailsModal();
            renderMatrixBody();
            updateFinalTablePreview();
        }

        // Function to export band report
        function exportBandReport() {
            const report = generateBandReport();
            const csv = convertToCSV(report);
            downloadCSV(csv, 'band_structure_report.csv');
            showNotification('Band structure report exported', 'success');
        }

        // Function to generate band report
        function generateBandReport() {
            const report = [];
            const customer = currentState.currentCustomer;
            
            // Add dedicated bands
            bandDetailsData.dedicated.bands.forEach(band => {
                report.push({
                    'Structure Type': 'Dedicated Services',
                    'Band Level': band,
                    'Description': `Level ${band.replace('Band ', '')} dedicated resource`,
                    'Customer': customer,
                    'With Benefits': bandDetailsData.dedicated.sampleData[customer]?.[band]?.[0] || '—',
                    'Without Benefits': bandDetailsData.dedicated.sampleData[customer]?.[band]?.[1] || '—'
                });
            });
            
            // Add dispatch bands
            bandDetailsData.dispatch.groups.forEach(group => {
                group.bands.forEach(band => {
                    report.push({
                        'Structure Type': 'Dispatch Services',
                        'Band Level': band,
                        'Category': group.title,
                        'Description': getDispatchBandDescription(band),
                        'Customer': customer,
                        'Rate': bandDetailsData.dispatch.sampleData[customer]?.[group.title]?.[band] || '—'
                    });
                });
            });
            
            // Add project bands
            bandDetailsData.project.groups.forEach(group => {
                group.bands.forEach(band => {
                    report.push({
                        'Structure Type': 'Project Work',
                        'Band Level': band,
                        'Duration': group.title,
                        'Description': getProjectBandDescription(band, group.title),
                        'Customer': customer,
                        'Monthly Rate': bandDetailsData.project.sampleData[customer]?.[group.title]?.[band] || '—'
                    });
                });
            });
            
            return report;
        }

        // Initialize with sample data
        setTimeout(() => {
            updateMatrixData();
            generateBandData(); // Generate initial band data
            showNotification('Enhanced Matching Matrix with Band Details loaded successfully!', 'success');
        }, 500);
    </script>
</body>
</html>