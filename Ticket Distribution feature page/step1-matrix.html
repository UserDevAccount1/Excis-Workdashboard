

<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@400&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#ffffff;
    --panel:#ffffff;
    --panel-2:#f9f9f9;
    --muted:#555;
    --text:#111;
    --line:#ddd;
    --brand:#5335ff;
    --brand-2:#c3b8fe;
    --radius:10px;
    --shadow:0 2px 6px rgba(0,0,0,.08);
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
    color:var(--text);
    background:var(--bg);
  }

  .topbar{
    display:flex; align-items:center; gap:14px;
    padding:16px 20px;
    border-bottom:1px solid var(--line);
    background:#fff;
    position:sticky; top:0; z-index:100;
  }
  .topbar .back{
    display:inline-flex; align-items:center; justify-content:center;
    width:36px; height:36px; border-radius:6px; border:1px solid var(--line);
    background:#fff; cursor:pointer;
  }
  .title{font-weight:700; font-size:20px}
  .subtitle{color:var(--muted); font-size:13px}
  .spacer{flex:1}
  .btn{
    display:inline-flex; align-items:center; gap:8px; height:36px; padding:0 14px;
    border:1px solid var(--line); border-radius:6px; background:#fff; color:var(--text);
    cursor:pointer; transition:.2s;
  }
  .btn.primary{background:var(--brand); border:none; color:#fff}
  .btn:hover{box-shadow:var(--shadow)}

  .wrap{padding:20px}
  .card{
    background:var(--panel); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow);
  }

  .stepper{
    display:flex; gap:10px; flex-wrap:wrap;
    padding:10px; margin-bottom:14px; background:var(--panel-2);
    border:1px solid var(--line); border-radius:var(--radius);
  }
  .step{
    display:flex; align-items:center; gap:8px; padding:8px 12px;
    border:1px solid var(--line); border-radius:8px; background:#fff; cursor:pointer;
  }
  .step.active{border-color:var(--brand); background:#f0f0ff}
  .badge{
    width:24px; height:24px; border-radius:6px; display:grid; place-items:center;
    background:#f5f5f5; color:var(--text); font-weight:600; font-size:13px;
  }
  .step.active .badge{background:var(--brand); color:#fff}
  .label{font-weight:600; font-size:13px}

  .grid{display:grid; grid-template-columns:1.5fr .8fr; gap:16px}
  @media (max-width:900px){.grid{grid-template-columns:1fr}}

  .panel{padding:18px}
  .panel h3{margin:0 0 6px; font-size:18px}
  .panel .hint{color:var(--muted); font-size:13px; margin-bottom:16px}

  .field{margin-bottom:14px}
  .label{font-size:13px; color:var(--muted); margin-bottom:6px}
  select,.input{
    width:100%; height:38px; padding:0 10px; color:var(--text);
    background:#fff; border:1px solid var(--line); border-radius:6px;
  }

  .list{border:1px solid var(--line); border-radius:6px; overflow:hidden}
  .row{
    display:grid; grid-template-columns:auto 1fr auto auto; gap:10px; align-items:center;
    padding:10px 12px; border-top:1px solid var(--line); background:#fff;
  }
  .row:first-child{border-top:none}
  .radio{accent-color:var(--brand)}
  .acct-title{font-weight:600}
  .acct-sub{color:var(--muted); font-size:12px}
  .pill{
    font-size:12px; padding:4px 8px; border-radius:20px; background:#f5f5f5; border:1px solid var(--line);
  }
  .currency{font-size:12px; color:var(--muted)}

  .summary{padding:18px}
  .summary h4{margin:0 0 12px}
  .kv{display:grid; grid-template-columns:120px 1fr; gap:8px; padding:8px 0; border-bottom:1px dashed #ddd; font-size:14px}
  .kv:last-child{border-bottom:none}
  .muted{color:var(--muted)}
  .placeholder{
    display:grid; place-items:center; min-height:100px; border:1px dashed #ccc; border-radius:6px; color:var(--muted); font-size:13px; background:#fafafa;
  }

  .footer{display:flex; gap:10px; justify-content:flex-end; margin-top:16px}
  .hide{display:none !important}
</style>


<div class="topbar">
  
  <div>
    <div class="title">Create Billing Run</div>
    <div class="subtitle">Step-by-step wizard to generate billing files from ticket data</div>
  </div>
  <div class="spacer"></div>
  <button class="btn">Save Draft</button>
  <button class="btn primary">Continue</button>
</div>

<div class="wrap">
  <div class="stepper" id="stepper">
    <div class="step active" data-step="1"><div class="badge">1</div><div class="label">Ticket Data Distribution</div></div>
    <div class="step" data-step="2"><div class="badge">2</div><div class="label">Rate Card Assignment</div></div>
    <div class="step" data-step="3"><div class="badge">3</div><div class="label">Manual Computation and Verification</div></div>
    <div class="step" data-step="4"><div class="badge">4</div><div class="label">Consolidation</div></div>
    <div class="step" data-step="5"><div class="badge">5</div><div class="label">Review and Monitoring</div></div>
    <div class="step" data-step="5"><div class="badge">6</div><div class="label">Query resolution & resubmission</div></div>
    <div class="step" data-step="5"><div class="badge">7</div><div class="label">Final approval & Invoice Preparation</div></div>
  </div>

  <div id="steps">
   
 <!-- STEP 1 - Ticket Upload & Validation Dashboard -->
<section class="ticket-upload-validation" data-step="1">
    <div class="section-header">
        <div class="header-main">
            <h2><i class="fas fa-file-upload"></i> Ticket Upload & Validation</h2>
            <div class="header-subtitle">
                <span class="badge step-badge">Step 1 of 4</span>
                <p>SDM uploads regional ticket files for system validation and distribution</p>
            </div>
        </div>
        <div class="header-actions">
            <button class="btn-icon-outline" title="Help">
                <i class="fas fa-question-circle"></i>
            </button>
            <button class="btn-icon-outline" title="Refresh">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
    </div>
    
    <!-- Data Sources Info -->
    <div class="data-sources-card">
        <h3><i class="fas fa-database"></i> Data Sources for Validation</h3>
        <div class="sources-grid">
            <div class="source-item">
                <div class="source-icon">
                    <i class="fas fa-file-excel"></i>
                </div>
                <div class="source-content">
                    <h4>Regional Ticket Files</h4>
                    <p><strong>Source:</strong> SDM Teams</p>
                    <p><strong>Format:</strong> Excel (.xlsx, .xls)</p>
                    <p><strong>Purpose:</strong> Ticket-level service data</p>
                </div>
            </div>
            <div class="source-item">
                <div class="source-icon">
                    <i class="fas fa-file-pdf"></i>
                </div>
                <div class="source-content">
                    <h4>Ticket Evidence</h4>
                    <p><strong>Source:</strong> SDM / SharePoint</p>
                    <p><strong>Format:</strong> PDF / ZIP</p>
                    <p><strong>Purpose:</strong> Proof/documentation</p>
                </div>
            </div>
            <div class="source-item">
                <div class="source-icon">
                    <i class="fas fa-file-alt"></i>
                </div>
                <div class="source-content">
                    <h4>Validation Rules</h4>
                    <p><strong>Source:</strong> Internal</p>
                    <p><strong>Format:</strong> Excel Template</p>
                    <p><strong>Purpose:</strong> Check ticket formatting</p>
                </div>
            </div>
            <div class="source-item">
                <div class="source-icon">
                    <i class="fas fa-history"></i>
                </div>
                <div class="source-content">
                    <h4>Prior Cycle Data</h4>
                    <p><strong>Source:</strong> Dashboard</p>
                    <p><strong>Format:</strong> Stored / CSV</p>
                    <p><strong>Purpose:</strong> Reconciliation</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Dashboard -->
    <div class="dashboard-grid">
        <!-- Left Panel: Upload & Controls -->
        <div class="left-panel">
            <div class="upload-card">
                <div class="upload-header">
                    <h3><i class="fas fa-cloud-upload-alt"></i> Upload Ticket Files</h3>
                    <span class="upload-info">Max file size: 50MB</span>
                </div>
                
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">
                        <i class="fas fa-file-excel"></i>
                    </div>
                    <h4>Drop Excel/CSV files here</h4>
                    <p>or click to browse</p>
                    <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" multiple style="display: none;">
                    <button class="btn-primary" id="browseBtn">
                        <i class="fas fa-folder-open"></i> Select Files
                    </button>
                    <div class="file-types">
                        <span>.xlsx</span>
                        <span>.xls</span>
                        <span>.csv</span>
                    </div>
                </div>
                
                <div class="upload-progress" id="uploadProgress" style="display: none;">
                    <div class="progress-header">
                        <span>Uploading files...</span>
                        <span class="progress-percent">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="uploaded-files" id="uploadedFiles">
                    <!-- Files will be listed here -->
                </div>
            </div>
            
            <div class="validation-card">
                <h3><i class="fas fa-check-circle"></i> Validation Controls</h3>
                <div class="validation-options">
                    <div class="option-item">
                        <input type="checkbox" id="checkFormat" checked>
                        <label for="checkFormat">Validate file format</label>
                    </div>
                    <div class="option-item">
                        <input type="checkbox" id="checkRequired" checked>
                        <label for="checkRequired">Check required fields</label>
                    </div>
                    <div class="option-item">
                        <input type="checkbox" id="checkDuplicates" checked>
                        <label for="checkDuplicates">Detect duplicates</label>
                    </div>
                    <div class="option-item">
                        <input type="checkbox" id="checkReferences" checked>
                        <label for="checkReferences">Validate references</label>
                    </div>
                </div>
                
                <div class="validation-actions">
                    <button class="btn-secondary full-width" id="validateFilesBtn" disabled>
                        <i class="fas fa-play-circle"></i> Run Validation
                    </button>
                    <button class="btn-tertiary full-width" id="loadSampleDataBtn">
                        <i class="fas fa-database"></i> Load Sample Data
                    </button>
                </div>
                
                <div class="validation-stats" id="validationStats">
                    <div class="stat-row">
                        <span>Files to validate:</span>
                        <span class="stat-value" id="fileCount">0</span>
                    </div>
                    <div class="stat-row">
                        <span>Estimated time:</span>
                        <span class="stat-value" id="estTime">0s</span>
                    </div>
                </div>
            </div>
            
            <div class="distribution-card">
                <h3><i class="fas fa-paper-plane"></i> Distribution Setup</h3>
                <div class="distribution-options">
                    <div class="dist-option">
                        <label>Distribution Method</label>
                        <select id="distMethod">
                            <option value="auto">Automatic (System)</option>
                            <option value="manual">Manual Review</option>
                            <option value="scheduled">Scheduled</option>
                        </select>
                    </div>
                    <div class="dist-option">
                        <label>Priority Level</label>
                        <select id="priorityLevel">
                            <option value="normal">Normal</option>
                            <option value="high">High Priority</option>
                            <option value="urgent">Urgent</option>
                        </select>
                    </div>
                </div>
                
                <button class="btn-success full-width" id="startDistributionBtn" disabled>
                    <i class="fas fa-rocket"></i> Start Distribution
                </button>
            </div>
        </div>
        
        <!-- Right Panel: Results & Analytics -->
        <div class="right-panel">
            <!-- Tabs Navigation -->
            <div class="results-tabs">
                <button class="tab-btn active" data-tab="validation">Validation Results</button>
                <button class="tab-btn" data-tab="analytics">Analytics</button>
                <button class="tab-btn" data-tab="distribution">Ticket Matching Matrix</button>
            </div>
            
            <!-- Validation Results Tab -->
            <div class="tab-content active" id="validationTab">
                <div class="results-header">
                   <!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ticket Validation </title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root {
    --primary: #3498db;
    --success: #2ecc71;
    --warning: #f39c12;
    --danger: #e74c3c;
    --light: #ecf0f1;
    --dark: #2c3e50;
    --gray: #7f8c8d;
}

* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #f5f7fa;
    color: #333;
    line-height: 1.6;
    padding: 20px;
}

.container {
    max-width: 1600px;
    margin: 0 auto;
    background: white;
    border-radius: 10px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    overflow: hidden;
    position: relative;
}

.header {
    background: linear-gradient(135deg, #3498db, #2c3e50);
    color: white;
    padding: 20px 30px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 15px;
}

.header h1 {
    font-size: 24px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.controls {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.btn {
    padding: 8px 16px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s;
}

.btn-primary {
    background-color: var(--primary);
    color: white;
}

.btn-success {
    background-color: var(--success);
    color: white;
}

.btn-warning {
    background-color: var(--warning);
    color: white;
}

.btn-outline {
    background-color: transparent;
    border: 1px solid white;
    color: white;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.summary-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    padding: 20px;
    background: var(--light);
}

.card {
    background: white;
    border-radius: 8px;
    padding: 20px;
    text-align: center;
    box-shadow: 0 3px 10px rgba(0,0,0,0.08);
    transition: transform 0.3s;
}

.card:hover {
    transform: translateY(-5px);
}

.card.success { border-top: 4px solid var(--success); }
.card.warning { border-top: 4px solid var(--warning); }
.card.danger { border-top: 4px solid var(--danger); }
.card.info { border-top: 4px solid var(--primary); }

.card-value {
    font-size: 32px;
    font-weight: bold;
    margin: 10px 0;
}

.card-label {
    color: var(--gray);
    font-size: 14px;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.table-container {
    padding: 20px;
    overflow-x: auto;
}

.table-tools {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 15px;
}

.search-box {
    flex: 1;
    max-width: 400px;
    position: relative;
}

.search-box input {
    width: 100%;
    padding: 10px 15px 10px 40px;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 14px;
}

.search-box i {
    position: absolute;
    left: 15px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--gray);
}

.tool-buttons {
    display: flex;
    gap: 10px;
    align-items: center;
}

.view-toggle {
    display: flex;
    background: #f1f1f1;
    border-radius: 5px;
    overflow: hidden;
    margin-right: 10px;
}

.view-toggle-btn {
    padding: 8px 16px;
    border: none;
    background: transparent;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    font-weight: 500;
    transition: all 0.3s;
}

.view-toggle-btn.active {
    background: var(--primary);
    color: white;
}

.config-window,
.view-window {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    border-radius: 10px;
    box-shadow: 0 15px 50px rgba(0,0,0,0.3);
    z-index: 1000;
    width: 80%;
    max-width: 900px;
    max-height: 80vh;
    overflow-y: auto;
    display: none;
}

.view-window {
    max-width: 700px;
}

.config-overlay,
.view-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 999;
    display: none;
}

.config-header,
.view-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding: 20px 20px 0 20px;
}

.config-header h3,
.view-header h3 {
    color: var(--dark);
}

.column-groups {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    padding: 20px;
}

.column-group h4 {
    color: var(--primary);
    margin-bottom: 10px;
    padding-bottom: 5px;
    border-bottom: 2px solid var(--light);
}

.checkbox-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 8px;
}

.checkbox-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 5px 0;
}

.checkbox-item input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.sort-icon {
    margin-left: 8px;
    cursor: pointer;
    opacity: 0.5;
    transition: all 0.3s;
    font-size: 12px;
}

.sort-icon:hover {
    opacity: 1;
    color: var(--primary);
}

.sort-icon.active {
    opacity: 1;
    color: var(--primary);
}

.sort-icons-container {
    display: inline-flex;
    flex-direction: column;
    margin-left: 8px;
    gap: 2px;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
    background: white;
    box-shadow: 0 3px 10px rgba(0,0,0,0.05);
}

.data-table th {
    background-color: var(--dark);
    color: white;
    font-weight: 600;
    text-align: left;
    padding: 15px;
    position: sticky;
    top: 0;
    z-index: 10;
    cursor: pointer;
    user-select: none;
}

.data-table th:hover {
    background-color: #34495e;
}

.data-table td {
    padding: 12px 15px;
    border-bottom: 1px solid #eee;
}

.data-table tr:hover {
    background-color: #f8f9fa;
}

.data-table tr:nth-child(even) {
    background-color: #f9f9f9;
}

.data-table tr:nth-child(even):hover {
    background-color: #f1f3f4;
}

.action-icons {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.action-icon {
    background: none;
    border: none;
    color: var(--gray);
    cursor: pointer;
    padding: 5px;
    border-radius: 4px;
    transition: all 0.2s;
    font-size: 16px;
}

.action-icon:hover {
    background: #f1f1f1;
    transform: scale(1.1);
}

.action-icon.edit:hover {
    color: #3498db;
}

.action-icon.assign:hover {
    color: #2ecc71;
}

.action-icon.view:hover {
    color: #9b59b6;
}

.form-view-container {
    display: none;
    padding: 20px;
}

.ticket-cards {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 20px;
}

.ticket-card {
    background: white;
    border-radius: 10px;
    box-shadow: 0 3px 15px rgba(0,0,0,0.1);
    overflow: hidden;
    transition: all 0.3s;
    border: 1px solid #eee;
}

.ticket-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 20px rgba(0,0,0,0.15);
}

.ticket-card-header {
    background: linear-gradient(135deg, #3498db, #2c3e50);
    color: white;
    padding: 15px;
}

.ticket-card-header h4 {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 16px;
}

.priority-badge {
    padding: 3px 10px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: bold;
}

.priority-P3 { background: #f39c12; }
.priority-P4 { background: #3498db; }
.priority-NBD { background: #2ecc71; }

.ticket-card-body {
    padding: 15px;
}

.ticket-field {
    margin-bottom: 12px;
    display: flex;
    flex-direction: column;
}

.ticket-field-label {
    font-weight: 600;
    color: var(--dark);
    font-size: 12px;
    margin-bottom: 3px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.ticket-field-value {
    color: #555;
    font-size: 14px;
    word-break: break-word;
}

.ticket-card-footer {
    padding: 15px;
    background: #f9f9f9;
    border-top: 1px solid #eee;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}

.view-details-container {
    padding: 20px;
}

.detail-row {
    display: grid;
    grid-template-columns: 200px 1fr;
    gap: 15px;
    padding: 12px 0;
    border-bottom: 1px solid #eee;
    align-items: start;
}

.detail-label {
    font-weight: 600;
    color: var(--dark);
    text-transform: uppercase;
    font-size: 12px;
    letter-spacing: 0.5px;
}

.detail-value {
    color: #555;
    word-break: break-word;
}

.pagination {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 20px;
    padding: 15px;
    background: var(--light);
    border-radius: 5px;
}

.pagination-info {
    color: var(--dark);
}

.pagination-controls {
    display: flex;
    gap: 5px;
}

.pagination-btn {
    padding: 8px 12px;
    background: white;
    border: 1px solid #ddd;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
}

.pagination-btn:hover:not(:disabled) {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

.pagination-btn.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

.pagination-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.filter-tag {
    display: inline-flex;
    align-items: center;
    background: #e3f2fd;
    padding: 4px 10px;
    border-radius: 4px;
    margin-right: 5px;
    font-size: 12px;
    color: var(--dark);
}

.filter-tag i {
    margin-left: 5px;
    cursor: pointer;
    font-size: 10px;
}

.filter-tag i:hover {
    color: var(--danger);
}

@media (max-width: 768px) {
    .header {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .controls {
        width: 100%;
        justify-content: center;
    }
    
    .table-tools {
        flex-direction: column;
        align-items: stretch;
    }
    
    .search-box {
        max-width: 100%;
    }
    
    .column-groups {
        grid-template-columns: 1fr;
    }
    
    .config-window,
    .view-window {
        width: 95%;
        max-height: 90vh;
    }
    
    .detail-row {
        grid-template-columns: 1fr;
        gap: 5px;
    }
    
    .ticket-cards {
        grid-template-columns: 1fr;
    }
}
</style>
</head>
<body>

<div class="container">
    <!-- Header -->
    <div class="header">
        <h1><i class="fas fa-clipboard-check"></i> Ticket Validation </h1>
        <div class="controls">
            <button class="btn btn-primary" id="toggleConfig">
                <i class="fas fa-cog"></i> Configure Columns
            </button>
            <button class="btn btn-success" id="exportBtn">
                <i class="fas fa-download"></i> Export Results
            </button>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="summary-cards">
        <div class="card success">
            <i class="fas fa-check-circle fa-2x"></i>
            <div class="card-value" id="validCount">0</div>
            <div class="card-label">Valid Tickets</div>
        </div>
        <div class="card warning">
            <i class="fas fa-exclamation-triangle fa-2x"></i>
            <div class="card-value" id="warningCount">0</div>
            <div class="card-label">Warnings</div>
        </div>
        <div class="card danger">
            <i class="fas fa-times-circle fa-2x"></i>
            <div class="card-value" id="errorCount">0</div>
            <div class="card-label">Errors</div>
        </div>
        <div class="card info">
            <i class="fas fa-clipboard-list fa-2x"></i>
            <div class="card-value" id="totalCount">0</div>
            <div class="card-label">Total Tickets</div>
        </div>
    </div>

    <!-- Floating Configuration Window -->
    <div class="config-overlay" id="configOverlay"></div>
    <div class="config-window" id="configWindow">
        <div class="config-header">
            <h3><i class="fas fa-sliders-h"></i> Column Configuration</h3>
            <button class="btn btn-outline" id="closeConfigWindow">
                <i class="fas fa-times"></i> Close
            </button>
        </div>
        <div class="column-groups" id="columnGroups">
            <!-- Groups will be populated by JavaScript -->
        </div>
        <div style="text-align: center; margin-top: 20px; padding: 20px; border-top: 1px solid #eee;">
            <button class="btn btn-primary" id="applyConfig">
                <i class="fas fa-check"></i> Apply Configuration
            </button>
            <button class="btn btn-outline" id="selectAllCols" style="color: var(--dark); margin-left: 10px;">
                <i class="fas fa-check-square"></i> Select All
            </button>
            <button class="btn btn-outline" id="deselectAllCols" style="color: var(--dark); margin-left: 10px;">
                <i class="fas fa-square"></i> Deselect All
            </button>
        </div>
    </div>

    <!-- View Details Window -->
    <div class="view-overlay" id="viewOverlay"></div>
    <div class="view-window" id="viewWindow">
        <div class="view-header">
            <h3><i class="fas fa-eye"></i> Ticket Details</h3>
            <button class="btn btn-outline" id="closeViewWindow">
                <i class="fas fa-times"></i> Close
            </button>
        </div>
        <div class="view-details-container" id="viewDetailsContainer">
            <!-- Details will be populated by JavaScript -->
        </div>
    </div>

    <!-- Main Content -->
    <div class="table-container" id="tableView">
        <div class="table-tools">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="Search across all columns...">
            </div>
            <div class="tool-buttons">
                <div class="view-toggle">
                    <button class="view-toggle-btn active" id="tableViewBtn">
                        <i class="fas fa-table"></i> Table View
                    </button>
                    <button class="view-toggle-btn" id="formViewBtn">
                        <i class="fas fa-th-large"></i> Form View
                    </button>
                </div>
                <div id="activeFilters"></div>
                <button class="btn btn-outline" id="filterBtn" style="color: var(--dark);">
                    <i class="fas fa-filter"></i> Filter by Priority
                </button>
                <div style="display: flex; align-items: center;">
                    <label for="rowsPerPage" style="margin-right: 10px;">Show:</label>
                    <select id="rowsPerPage" style="padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
                        <option value="10">10</option>
                        <option value="25" selected>25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                        <option value="all">All</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Table View -->
        <div id="tableDisplay">
            <table class="data-table" id="ticketTable">
                <thead id="tableHeader"></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>

        <!-- Form View -->
        <div class="form-view-container" id="formViewContainer">
            <div class="ticket-cards" id="ticketCards">
                <!-- Cards will be populated by JavaScript -->
            </div>
        </div>

        <!-- Pagination -->
        <div class="pagination">
            <div class="pagination-info" id="paginationInfo"></div>
            <div class="pagination-controls" id="paginationControls"></div>
        </div>
    </div>
</div>

<script>
// Enhanced sample data with new columns
const sampleData = [
    {
        "Request ID": 557829,
        "CUSTOMER REFERENCE": "SCTASK1388670/WO0041397",
        "Requester": "Mattel_support",
        "Subject": "Yogyakarta || Indonesia || HCL_Mattel || ETA: 25/07/2025 14:30 || P3 || Dispatch engineer for ASOL for Failover Testing and IDF cleanup",
        "Site": "Common Site",
        "Priority": "P3",
        "Assigned Technician": "Priyanka Achari",
        "Request Status": "Resolved",
        "Worklog Type": "Resolution",
        "Created Time (UK time)": "2025-07-18 06:14:00",
        "Country": "Indonesia",
        "CITY OR TOWN": "Yogyakarta",
        "FIELD ENGINEERS RESOLVER": "Isnaini Sholikin",
        "Total Revenue": 77.07,
        "currency": "USD",
        "Total labor Cost": 33,
        "Profit": 44.07,
        "Margin in %": 57,
        "PO Number": "PO001",
        "Customer": "Mattel",
        "Account": "ACC-MAT-001"
    },
    {
        "Request ID": 558285,
        "CUSTOMER REFERENCE": "INC0544159",
        "Requester": "Vemula Alekhya",
        "Subject": "Tocancip?­ || Colombia || HCL_Dormakaba || ETA: 22/07/2025 || NBD || Adobe Reader does not work",
        "Site": "Colombia",
        "Priority": "NBD",
        "Assigned Technician": "Frederick Baclay",
        "Request Status": "Resolved",
        "Worklog Type": "Resolution",
        "Created Time (UK time)": "2025-07-21 21:53:00",
        "Country": "Colombia",
        "CITY OR TOWN": "Tocancip?­",
        "FIELD ENGINEERS RESOLVER": "Jurgen Steven Ruiz",
        "Total Revenue": 341.74,
        "currency": "USD",
        "Total labor Cost": 286,
        "Profit": 55.74,
        "Margin in %": 16,
        "PO Number": "PO002",
        "Customer": "Dormakaba",
        "Account": "ACC-DOR-002"
    },
    {
        "Request ID": 558060,
        "CUSTOMER REFERENCE": "SCTASK0348361",
        "Requester": "Tushar Kapse",
        "Subject": "Jurong Island || SINGAPORE || HCL_Huntsman || ETA: [22/07/2025] [23/07/2025] 09:00 || NBD || Computer Refresh task",
        "Site": "Common Site",
        "Priority": "NBD",
        "Assigned Technician": "Priyanka Achari",
        "Request Status": "Resolved",
        "Worklog Type": "Resolution",
        "Created Time (UK time)": "2025-07-21 05:03:00",
        "Country": "SINGAPORE",
        "CITY OR TOWN": "Jurong Island",
        "FIELD ENGINEERS RESOLVER": "Ram, Sainy Naveen Kumar",
        "Total Revenue": 536,
        "currency": "USD",
        "Total labor Cost": 356,
        "Profit": 180,
        "Margin in %": 34,
        "PO Number": "PO003",
        "Customer": "Huntsman",
        "Account": "ACC-HUN-003"
    },
    {
        "Request ID": 557830,
        "CUSTOMER REFERENCE": "SCTASK1388662/WO0041396",
        "Requester": "Mattel_support",
        "Subject": "Yogyakarta || Indonesia || HCL_Mattel || ETA: 25/07/2025 9:00 || P3 || Dispatch Engineer for AYOG site on Friday- 25th July for Network Failover Testing and IDF cleanup",
        "Site": "Common Site",
        "Priority": "P4",
        "Assigned Technician": "Priyanka Achari",
        "Request Status": "Resolved",
        "Worklog Type": "Resolution",
        "Created Time (UK time)": "2025-07-18 06:19:00",
        "Country": "Indonesia",
        "CITY OR TOWN": "Yogyakarta",
        "FIELD ENGINEERS RESOLVER": "Isnaini Sholikin",
        "Total Revenue": 102.76,
        "currency": "USD",
        "Total labor Cost": 35,
        "Profit": 67.76,
        "Margin in %": 66,
        "PO Number": "PO004",
        "Customer": "Mattel",
        "Account": "ACC-MAT-004"
    },
    {
        "Request ID": 557971,
        "CUSTOMER REFERENCE": "INC00575907",
        "Requester": "Sakshi Dube",
        "Subject": "Budapest || HUNGARY || HCL_Signify || ETA: 22/07/2025 09:00 || P3 || UUTW: Unable to login laptop - NA",
        "Site": "Budapest",
        "Priority": "P3",
        "Assigned Technician": "Cedric Rahasinaivo",
        "Request Status": "Resolved",
        "Worklog Type": "Resolution",
        "Created Time (UK time)": "2025-07-18 17:23:00",
        "Country": "HUNGARY",
        "CITY OR TOWN": "Budapest",
        "FIELD ENGINEERS RESOLVER": "Gabor GARAI",
        "Total Revenue": 126.8,
        "currency": "EUR",
        "Total labor Cost": 80,
        "Profit": 46.8,
        "Margin in %": 37,
        "PO Number": "PO005",
        "Customer": "Signify",
        "Account": "ACC-SIG-005"
    }
];

// Updated column groups with new columns
const columnGroups = {
    "Basic Information": [
        "Request ID",
        "CUSTOMER REFERENCE", 
        "Requester",
        "Subject",
        "Site",
        "Priority",
        "Assigned Technician",
        "Request Status",
        "PO Number",
        "Customer",
        "Account"
    ],
    "Time Details": [
        "Created Time (UK time)",
        "Time Spent Starttime (UK time)",
        "Time Spent Endtime (UK time)",
        "Time Spent",
        "Completed Time (UK time)",
        "Resolved Time (UK time)"
    ],
    "Location Details": [
        "REGION OF THE COUNTRY",
        "Country",
        "CITY OR TOWN",
        "States"
    ],
    "Engineer Details": [
        "FIELD ENGINEERS RESOLVER",
        "Engineer details",
        "Worklog Type"
    ],
    "Financial Information": [
        "Total Revenue",
        "currency",
        "Total labor Cost",
        "Profit",
        "Margin in %",
        "1st Hour Revenue Rate",
        "Revenue rate"
    ],
    "Additional Information": [
        "External PO NUMBER",
        "Vendor PO",
        "PRE Visit",
        "POST Visit",
        "Comments"
    ]
};

// App state
let visibleColumns = [...columnGroups["Basic Information"]];
let allColumns = [];
let currentSort = { column: null, direction: null };
let activeFilters = {};
let filteredData = [...sampleData];
let currentPage = 1;
let rowsPerPage = 25;
let currentView = 'table'; // 'table' or 'form'

// Initialize all columns
Object.values(columnGroups).forEach(group => {
    group.forEach(col => {
        if (!allColumns.includes(col)) allColumns.push(col);
    });
});
allColumns.push("Action");
visibleColumns.push("Action");

// Update summary counts
function updateSummary() {
    document.getElementById('validCount').textContent = sampleData.length;
    document.getElementById('warningCount').textContent = Math.floor(sampleData.length * 0.1);
    document.getElementById('errorCount').textContent = Math.floor(sampleData.length * 0.05);
    document.getElementById('totalCount').textContent = sampleData.length;
}

// Render column configuration window
function renderColumnConfig() {
    const container = document.getElementById('columnGroups');
    container.innerHTML = '';
    
    for (const [groupName, columns] of Object.entries(columnGroups)) {
        const groupDiv = document.createElement('div');
        groupDiv.className = 'column-group';
        
        const groupHeader = document.createElement('h4');
        groupHeader.textContent = `${groupName} (${columns.length})`;
        groupDiv.appendChild(groupHeader);
        
        const checkboxGrid = document.createElement('div');
        checkboxGrid.className = 'checkbox-grid';
        
        columns.forEach(column => {
            const checkboxItem = document.createElement('div');
            checkboxItem.className = 'checkbox-item';
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = `col-${column.replace(/\s+/g, '-')}`;
            checkbox.checked = visibleColumns.includes(column);
            checkbox.addEventListener('change', () => {
                if (checkbox.checked && !visibleColumns.includes(column)) {
                    visibleColumns.push(column);
                } else if (!checkbox.checked) {
                    visibleColumns = visibleColumns.filter(col => col !== column);
                }
            });
            
            const label = document.createElement('label');
            label.htmlFor = checkbox.id;
            label.textContent = column;
            
            checkboxItem.appendChild(checkbox);
            checkboxItem.appendChild(label);
            checkboxGrid.appendChild(checkboxItem);
        });
        
        groupDiv.appendChild(checkboxGrid);
        container.appendChild(groupDiv);
    }
}

// Render active filters
function renderActiveFilters() {
    const container = document.getElementById('activeFilters');
    container.innerHTML = '';
    
    Object.entries(activeFilters).forEach(([key, value]) => {
        if (value) {
            const tag = document.createElement('span');
            tag.className = 'filter-tag';
            tag.innerHTML = `${key}: ${value} <i class="fas fa-times" onclick="removeFilter('${key}')"></i>`;
            container.appendChild(tag);
        }
    });
}

// Remove filter
function removeFilter(key) {
    delete activeFilters[key];
    applyFilters();
}

// Apply all filters
function applyFilters() {
    filteredData = sampleData.filter(row => {
        return Object.entries(activeFilters).every(([key, value]) => {
            if (!value) return true;
            return String(row[key]).toLowerCase().includes(value.toLowerCase());
        });
    });
    
    renderActiveFilters();
    currentPage = 1;
    if (currentView === 'table') {
        renderTableView();
    } else {
        renderFormView();
    }
}

// Sort data
function sortData(column) {
    if (currentSort.column === column) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
    } else {
        currentSort.column = column;
        currentSort.direction = 'asc';
    }
    
    filteredData.sort((a, b) => {
        let aVal = a[column];
        let bVal = b[column];
        
        if (aVal === undefined || bVal === undefined) return 0;
        
        if (typeof aVal === 'number' && typeof bVal === 'number') {
            return currentSort.direction === 'asc' ? aVal - bVal : bVal - aVal;
        }
        
        aVal = String(aVal);
        bVal = String(bVal);
        
        const comparison = aVal.localeCompare(bVal, undefined, { numeric: true, sensitivity: 'base' });
        return currentSort.direction === 'asc' ? comparison : -comparison;
    });
    
    if (currentView === 'table') {
        renderTableView();
    } else {
        renderFormView();
    }
}

// Show ticket details in floating window
function showTicketDetails(requestId) {
    const ticket = sampleData.find(t => t['Request ID'] === requestId);
    if (!ticket) return;
    
    const container = document.getElementById('viewDetailsContainer');
    container.innerHTML = '';
    
    // Create details view
    Object.entries(ticket).forEach(([key, value]) => {
        const row = document.createElement('div');
        row.className = 'detail-row';
        
        const label = document.createElement('div');
        label.className = 'detail-label';
        label.textContent = key;
        
        const val = document.createElement('div');
        val.className = 'detail-value';
        
        // Format special columns
        if (['Profit', 'Total Revenue', 'Total labor Cost'].includes(key)) {
            value = typeof value === 'number' ? value.toFixed(2) : value;
        }
        if (key === 'Margin in %') {
            value = typeof value === 'number' ? `${value}%` : value;
        }
        
        val.textContent = value || 'N/A';
        
        row.appendChild(label);
        row.appendChild(val);
        container.appendChild(row);
    });
    
    // Show the window
    document.getElementById('viewOverlay').style.display = 'block';
    document.getElementById('viewWindow').style.display = 'block';
}

// Render table view
function renderTableView() {
    const header = document.getElementById('tableHeader');
    const body = document.getElementById('tableBody');
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    
    // Apply search filter
    let displayData = filteredData.filter(row => {
        return visibleColumns.some(column => {
            if (column === 'Action') return false;
            const value = row[column];
            return value && String(value).toLowerCase().includes(searchTerm);
        });
    });
    
    // Pagination
    const totalPages = Math.ceil(displayData.length / rowsPerPage);
    const startIndex = (currentPage - 1) * rowsPerPage;
    const endIndex = Math.min(startIndex + rowsPerPage, displayData.length);
    const pageData = displayData.slice(startIndex, endIndex);
    
    // Render header with sort icons
    header.innerHTML = '';
    const headerRow = document.createElement('tr');
    
    visibleColumns.forEach(column => {
        const th = document.createElement('th');
        
        if (column === 'Action') {
            th.textContent = column;
            th.style.width = '120px';
            th.style.cursor = 'default';
        } else {
            th.textContent = column;
            
            // Add sort icons container
            const sortContainer = document.createElement('span');
            sortContainer.className = 'sort-icons-container';
            
            // Ascending icon
            const ascIcon = document.createElement('i');
            ascIcon.className = `fas fa-caret-up sort-icon ${currentSort.column === column && currentSort.direction === 'asc' ? 'active' : ''}`;
            ascIcon.title = 'Sort ascending';
            ascIcon.onclick = (e) => {
                e.stopPropagation();
                sortData(column);
            };
            
            // Descending icon
            const descIcon = document.createElement('i');
            descIcon.className = `fas fa-caret-down sort-icon ${currentSort.column === column && currentSort.direction === 'desc' ? 'active' : ''}`;
            descIcon.title = 'Sort descending';
            descIcon.onclick = (e) => {
                e.stopPropagation();
                currentSort.column = column;
                currentSort.direction = 'desc';
                sortData(column);
            };
            
            sortContainer.appendChild(ascIcon);
            sortContainer.appendChild(descIcon);
            th.appendChild(sortContainer);
            
            // Click on header also sorts
            th.onclick = (e) => {
                if (!e.target.classList.contains('sort-icon')) {
                    sortData(column);
                }
            };
        }
        
        headerRow.appendChild(th);
    });
    
    header.appendChild(headerRow);
    
    // Render body
    body.innerHTML = '';
    pageData.forEach((row) => {
        const tr = document.createElement('tr');
        
        visibleColumns.forEach(column => {
            const td = document.createElement('td');
            
            if (column === 'Action') {
                td.className = 'action-icons';
                td.innerHTML = `
                    <button class="action-icon edit" title="Edit" onclick="editTicket(${row['Request ID']})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="action-icon assign" title="Assign Rate Card" onclick="assignRateCard(${row['Request ID']})">
                        <i class="fas fa-tag"></i>
                    </button>
                    <button class="action-icon view" title="View Details" onclick="showTicketDetails(${row['Request ID']})">
                        <i class="fas fa-eye"></i>
                    </button>
                `;
            } else {
                let value = row[column] || '';
                
                // Format special columns
                if (['Profit', 'Total Revenue', 'Total labor Cost'].includes(column)) {
                    value = typeof value === 'number' ? value.toFixed(2) : value;
                }
                if (column === 'Margin in %') {
                    value = typeof value === 'number' ? `${value}%` : value;
                }
                
                td.textContent = value;
                
                // Add tooltip for long text
                if (String(value).length > 50) {
                    td.title = value;
                    td.style.maxWidth = '300px';
                    td.style.overflow = 'hidden';
                    td.style.textOverflow = 'ellipsis';
                    td.style.whiteSpace = 'nowrap';
                }
            }
            
            tr.appendChild(td);
        });
        
        body.appendChild(tr);
    });
    
    // Update pagination info
    document.getElementById('paginationInfo').textContent = 
        `Showing ${startIndex + 1} to ${endIndex} of ${displayData.length} entries`;
    
    renderPaginationControls(totalPages);
}

// Render form view
function renderFormView() {
    const container = document.getElementById('ticketCards');
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    
    // Apply search filter
    let displayData = filteredData.filter(row => {
        return visibleColumns.some(column => {
            if (column === 'Action') return false;
            const value = row[column];
            return value && String(value).toLowerCase().includes(searchTerm);
        });
    });
    
    // Pagination
    const totalPages = Math.ceil(displayData.length / rowsPerPage);
    const startIndex = (currentPage - 1) * rowsPerPage;
    const endIndex = Math.min(startIndex + rowsPerPage, displayData.length);
    const pageData = displayData.slice(startIndex, endIndex);
    
    container.innerHTML = '';
    
    pageData.forEach((ticket) => {
        const card = document.createElement('div');
        card.className = 'ticket-card';
        
        // Header with Priority badge
        const header = document.createElement('div');
        header.className = 'ticket-card-header';
        header.innerHTML = `
            <h4>
                <span>Ticket #${ticket['Request ID']}</span>
                <span class="priority-badge priority-${ticket['Priority']}">${ticket['Priority']}</span>
            </h4>
        `;
        
        // Body with selected columns
        const body = document.createElement('div');
        body.className = 'ticket-card-body';
        
        visibleColumns.forEach(column => {
            if (column === 'Action') return;
            
            const value = ticket[column];
            if (value === undefined) return;
            
            const field = document.createElement('div');
            field.className = 'ticket-field';
            
            const label = document.createElement('div');
            label.className = 'ticket-field-label';
            label.textContent = column;
            
            const val = document.createElement('div');
            val.className = 'ticket-field-value';
            
            // Format special columns
            let displayValue = value;
            if (['Profit', 'Total Revenue', 'Total labor Cost'].includes(column)) {
                displayValue = typeof value === 'number' ? value.toFixed(2) : value;
            }
            if (column === 'Margin in %') {
                displayValue = typeof value === 'number' ? `${value}%` : value;
            }
            
            val.textContent = displayValue;
            
            field.appendChild(label);
            field.appendChild(val);
            body.appendChild(field);
        });
        
        // Footer with action buttons
        const footer = document.createElement('div');
        footer.className = 'ticket-card-footer';
        footer.innerHTML = `
            <button class="action-icon edit" title="Edit" onclick="editTicket(${ticket['Request ID']})">
                <i class="fas fa-edit"></i>
            </button>
            <button class="action-icon assign" title="Assign Rate Card" onclick="assignRateCard(${ticket['Request ID']})">
                <i class="fas fa-tag"></i>
            </button>
            <button class="action-icon view" title="View Details" onclick="showTicketDetails(${ticket['Request ID']})">
                <i class="fas fa-eye"></i>
            </button>
        `;
        
        card.appendChild(header);
        card.appendChild(body);
        card.appendChild(footer);
        container.appendChild(card);
    });
    
    // Update pagination info
    document.getElementById('paginationInfo').textContent = 
        `Showing ${startIndex + 1} to ${endIndex} of ${displayData.length} entries`;
    
    renderPaginationControls(totalPages);
}

// Render pagination controls
function renderPaginationControls(totalPages) {
    const controls = document.getElementById('paginationControls');
    controls.innerHTML = '';
    
    const prevBtn = document.createElement('button');
    prevBtn.className = 'pagination-btn';
    prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
    prevBtn.disabled = currentPage === 1;
    prevBtn.addEventListener('click', () => {
        if (currentPage > 1) {
            currentPage--;
            if (currentView === 'table') {
                renderTableView();
            } else {
                renderFormView();
            }
        }
    });
    controls.appendChild(prevBtn);
    
    const maxPagesToShow = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow / 2));
    let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);
    
    if (endPage - startPage + 1 < maxPagesToShow) {
        startPage = Math.max(1, endPage - maxPagesToShow + 1);
    }
    
    for (let i = startPage; i <= endPage; i++) {
        const pageBtn = document.createElement('button');
        pageBtn.className = `pagination-btn ${i === currentPage ? 'active' : ''}`;
        pageBtn.textContent = i;
        pageBtn.addEventListener('click', () => {
            currentPage = i;
            if (currentView === 'table') {
                renderTableView();
            } else {
                renderFormView();
            }
        });
        controls.appendChild(pageBtn);
    }
    
    const nextBtn = document.createElement('button');
    nextBtn.className = 'pagination-btn';
    nextBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
    nextBtn.disabled = currentPage === totalPages;
    nextBtn.addEventListener('click', () => {
        if (currentPage < totalPages) {
            currentPage++;
            if (currentView === 'table') {
                renderTableView();
            } else {
                renderFormView();
            }
        }
    });
    controls.appendChild(nextBtn);
}

// Switch between table and form views
function switchView(view) {
    currentView = view;
    currentPage = 1;
    
    const tableViewBtn = document.getElementById('tableViewBtn');
    const formViewBtn = document.getElementById('formViewBtn');
    const tableDisplay = document.getElementById('tableDisplay');
    const formViewContainer = document.getElementById('formViewContainer');
    
    if (view === 'table') {
        tableViewBtn.classList.add('active');
        formViewBtn.classList.remove('active');
        tableDisplay.style.display = 'block';
        formViewContainer.style.display = 'none';
        renderTableView();
    } else {
        tableViewBtn.classList.remove('active');
        formViewBtn.classList.add('active');
        tableDisplay.style.display = 'none';
        formViewContainer.style.display = 'block';
        renderFormView();
    }
}

// Ticket action functions
function editTicket(requestId) {
    alert(`Editing ticket ${requestId} - This would open an edit form in a real application.`);
}

function assignRateCard(requestId) {
    const ticket = sampleData.find(t => t['Request ID'] === requestId);
    if (ticket) {
        const rate = prompt(`Assign rate card for Ticket ${requestId}\nCurrent rate: ${ticket['Revenue rate'] || 'Not set'}\nEnter new rate:`, ticket['Revenue rate'] || '');
        if (rate !== null) {
            alert(`Rate card assigned: ${rate} for ticket ${requestId}`);
        }
    }
}

// Initialize application
document.addEventListener('DOMContentLoaded', () => {
    updateSummary();
    renderColumnConfig();
    renderTableView();
    
    // Toggle configuration window
    document.getElementById('toggleConfig').addEventListener('click', () => {
        document.getElementById('configOverlay').style.display = 'block';
        document.getElementById('configWindow').style.display = 'block';
    });
    
    document.getElementById('closeConfigWindow').addEventListener('click', () => {
        document.getElementById('configOverlay').style.display = 'none';
        document.getElementById('configWindow').style.display = 'none';
    });
    
    document.getElementById('configOverlay').addEventListener('click', () => {
        document.getElementById('configOverlay').style.display = 'none';
        document.getElementById('configWindow').style.display = 'none';
    });
    
    // Close view window
    document.getElementById('closeViewWindow').addEventListener('click', () => {
        document.getElementById('viewOverlay').style.display = 'none';
        document.getElementById('viewWindow').style.display = 'none';
    });
    
    document.getElementById('viewOverlay').addEventListener('click', () => {
        document.getElementById('viewOverlay').style.display = 'none';
        document.getElementById('viewWindow').style.display = 'none';
    });
    
    // Apply configuration
    document.getElementById('applyConfig').addEventListener('click', () => {
        // Ensure Action column is always included
        if (!visibleColumns.includes('Action')) {
            visibleColumns.push('Action');
        }
        if (currentView === 'table') {
            renderTableView();
        } else {
            renderFormView();
        }
        document.getElementById('configOverlay').style.display = 'none';
        document.getElementById('configWindow').style.display = 'none';
    });
    
    // Select/Deselect all columns
    document.getElementById('selectAllCols').addEventListener('click', () => {
        visibleColumns = [...allColumns.filter(col => col !== 'Action')];
        renderColumnConfig();
    });
    
    document.getElementById('deselectAllCols').addEventListener('click', () => {
        visibleColumns = [];
        renderColumnConfig();
    });
    
    // Export button
    document.getElementById('exportBtn').addEventListener('click', () => {
        alert('Export functionality would download data as CSV/Excel in a real application.');
    });
    
    // Search input
    document.getElementById('searchInput').addEventListener('input', () => {
        currentPage = 1;
        if (currentView === 'table') {
            renderTableView();
        } else {
            renderFormView();
        }
    });
    
    // Rows per page selector
    document.getElementById('rowsPerPage').addEventListener('change', (e) => {
        if (e.target.value === 'all') {
            rowsPerPage = filteredData.length;
        } else {
            rowsPerPage = parseInt(e.target.value);
        }
        currentPage = 1;
        if (currentView === 'table') {
            renderTableView();
        } else {
            renderFormView();
        }
    });
    
    // Filter by Priority button
    document.getElementById('filterBtn').addEventListener('click', () => {
        const priorities = ['P3', 'P4', 'NBD'];
        const selectedPriority = prompt(`Filter by Priority:\nAvailable: ${priorities.join(', ')}\nEnter priority or leave empty to clear:`, activeFilters.Priority || '');
        
        if (selectedPriority !== null) {
            if (selectedPriority === '') {
                delete activeFilters.Priority;
            } else {
                activeFilters.Priority = selectedPriority;
            }
            applyFilters();
        }
    });
    
    // View toggle buttons
    document.getElementById('tableViewBtn').addEventListener('click', () => {
        switchView('table');
    });
    
    document.getElementById('formViewBtn').addEventListener('click', () => {
        switchView('form');
    });
});
</script>
</body>
</html>
                </div>
            </div>
       
   
            
            
            <!-- Analytics Tab -->
            <div class="tab-content" id="analyticsTab">
                <div class="analytics-header">
                    <h3><i class="fas fa-chart-bar"></i> Ticket Analytics</h3>
                    <div class="date-filter">
                        <select id="timePeriod">
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month" selected>This Month</option>
                            <option value="quarter">This Quarter</option>
                        </select>
                    </div>
                </div>
                
                <div class="analytics-grid">
                    <div class="chart-container">
                        <div class="chart-header">
                            <h4>Regional Distribution</h4>
                            <button class="btn-icon-xs" id="refreshChart">
                                <i class="fas fa-redo"></i>
                            </button>
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="regionChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <div class="chart-header">
                            <h4>Ticket Types</h4>
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="typeChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="stats-container">
                        <h4>Quick Stats</h4>
                        <div class="stats-list">
                            <div class="stat-item-large">
                                <div class="stat-icon">
                                    <i class="fas fa-ticket-alt"></i>
                                </div>
                                <div class="stat-content">
                                    <div class="stat-value" id="totalTicketsStat">0</div>
                                    <div class="stat-label">Total Tickets</div>
                                </div>
                            </div>
                            <div class="stat-item-large">
                                <div class="stat-icon success">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <div class="stat-content">
                                    <div class="stat-value" id="validTicketsStat">0</div>
                                    <div class="stat-label">Validated</div>
                                </div>
                            </div>
                            <div class="stat-item-large">
                                <div class="stat-icon pending">
                                    <i class="fas fa-clock"></i>
                                </div>
                                <div class="stat-content">
                                    <div class="stat-value" id="pendingTicketsStat">0</div>
                                    <div class="stat-label">Pending</div>
                                </div>
                            </div>
                            <div class="stat-item-large">
                                <div class="stat-icon warning">
                                    <i class="fas fa-exclamation-triangle"></i>
                                </div>
                                <div class="stat-content">
                                    <div class="stat-value" id="warningTicketsStat">0</div>
                                    <div class="stat-label">With Warnings</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Distribution Tab -->
            <div class="tab-content" id="distributionTab">
                <div class="distribution-header">

  
    <title>Ticket Distribution System - Enhanced Matching Matrix</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #7c3aed;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --light: #f8fafc;
            --dark: #1e293b;
            --gray: #64748b;
            --gray-light: #e2e8f0;
            --border-radius: 10px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e3e8f0 100%);
            color: var(--dark);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            background: white;
            border-radius: var(--border-radius);
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: var(--shadow);
            border-left: 5px solid var(--primary);
        }

        .header h1 {
            color: var(--dark);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header h1 i {
            color: var(--primary);
        }

        .subtitle {
            color: var(--gray);
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        /* Controls Panel */
        .controls-panel {
            background: white;
            border-radius: var(--border-radius);
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: var(--shadow);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .control-label {
            font-weight: 600;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-input {
            padding: 10px 15px;
            border: 2px solid var(--gray-light);
            border-radius: 6px;
            font-size: 0.95rem;
            transition: var(--transition);
        }

        .control-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        select.control-input {
            background: white;
            cursor: pointer;
        }

        /* Mode Toggle */
        .mode-toggle-container {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: var(--light);
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .toggle-label {
            font-weight: 500;
            color: var(--dark);
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--success);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(30px);
        }

        /* Matrix Container */
        .matrix-container {
            border: 1px solid var(--gray-light);
            border-radius: 8px;
            overflow: auto;
            max-height: 700px;
            background: white;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .matrix-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 2000px;
        }

        .matrix-table th {
            background: var(--dark);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            min-width: 180px;
            border-right: 1px solid var(--gray);
        }

        .matrix-table th:first-child {
            position: sticky;
            left: 0;
            background: var(--dark);
            z-index: 20;
            min-width: 250px;
        }

        .matrix-table td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--gray-light);
            border-right: 1px solid var(--gray-light);
            background: white;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            transition: var(--transition);
        }

        .matrix-table td:first-child {
            position: sticky;
            left: 0;
            background: var(--light);
            font-weight: 500;
            z-index: 5;
            min-width: 250px;
        }

        .matrix-table tr:hover td {
            background: #f8fafc;
        }

        .matrix-table tr:hover td:first-child {
            background: #e2e8f0;
        }

        /* Cell Styles - ALL EDITABLE */
        .cell-input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid var(--gray-light);
            border-radius: 4px;
            font-size: 0.9rem;
            transition: var(--transition);
            background: white;
        }

        .cell-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
            background: #f8fafc;
        }

        .cell-input.non-existent {
            background: #fef2f2;
            border-color: #fecaca;
            color: #dc2626;
            opacity: 0.7;
        }

        .cell-input.non-existent:focus {
            background: #fef2f2;
            border-color: #f87171;
        }

        .cell-check {
            color: var(--success);
            font-weight: bold;
            text-align: center;
        }

        .cell-cross {
            color: var(--danger);
            font-weight: bold;
            text-align: center;
        }

        .cell-data-input {
            width: 100%;
            border: 1px solid var(--gray-light);
            border-radius: 4px;
            background: white;
            color: var(--dark);
            font-size: 0.9rem;
            padding: 6px 8px;
            transition: var(--transition);
        }

        .cell-data-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
            background: #f8fafc;
        }

        .cell-data {
            color: var(--dark);
            font-size: 0.9rem;
        }

        /* Highlighting */
        .highlight-column {
            background: #d1fae5 !important;
        }

        .highlight-duplicate {
            background: #fef3c7 !important;
            border: 1px solid #f59e0b !important;
        }

        .highlight-match {
            background: #e0f2fe !important;
            border: 1px solid var(--info) !important;
        }

        .highlight-smart-add {
            animation: pulse 0.5s ease;
            background: #f0f9ff !important;
        }

        .highlight-required {
            background: linear-gradient(45deg, #fef3c7, #fde68a) !important;
            border-left: 3px solid var(--warning) !important;
        }

        .highlight-final-table {
            background: linear-gradient(45deg, #d1fae5, #a7f3d0) !important;
            border-left: 3px solid var(--success) !important;
        }

        @keyframes pulse {
            0% { background: white; }
            50% { background: #dbeafe; }
            100% { background: #f0f9ff; }
        }

        /* RAG Status Colors */
        .rag-green {
            color: var(--success);
        }

        .rag-amber {
            color: var(--warning);
        }

        .rag-red {
            color: var(--danger);
        }

        /* Matrix Stats */
        .matrix-stats {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            padding: 15px;
            background: var(--light);
            border-radius: 8px;
            font-size: 0.9rem;
            flex-wrap: wrap;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 20px;
            background: white;
            border-radius: 6px;
            min-width: 100px;
            box-shadow: var(--shadow);
        }

        .stat-value {
            font-weight: 700;
            font-size: 1.2rem;
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--gray);
            text-align: center;
        }

        /* Matrix Legend */
        .matrix-legend {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border: 1px solid var(--gray-light);
            font-size: 0.85rem;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 3px;
        }

        .legend-check {
            background: var(--success);
        }

        .legend-cross {
            background: var(--danger);
        }

        .legend-highlight {
            background: #d1fae5;
        }

        .legend-duplicate {
            background: #fef3c7;
        }

        .legend-match {
            background: #e0f2fe;
        }

        .legend-smart-add {
            background: #f0f9ff;
        }

        .legend-required {
            background: linear-gradient(45deg, #fef3c7, #fde68a);
        }

        /* Search Bar */
        .search-container {
            position: relative;
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 15px 20px 15px 50px;
            border: 2px solid var(--gray-light);
            border-radius: 8px;
            font-size: 1rem;
            transition: var(--transition);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
        }

        /* Smart Add Indicator */
        .smart-add-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--success);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: var(--shadow-lg);
            z-index: 100;
            display: none;
        }

        /* Final Table Preview */
        .final-table-preview {
            background: white;
            border-radius: var(--border-radius);
            padding: 25px;
            margin-top: 30px;
            box-shadow: var(--shadow);
        }

        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--gray-light);
        }

        .preview-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
        }

        .preview-item {
            background: var(--light);
            padding: 12px 15px;
            border-radius: 6px;
            border: 1px solid var(--gray-light);
        }

        .preview-field {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .preview-value {
            color: var(--gray);
            font-size: 0.85rem;
            word-break: break-word;
        }

        /* Export Buttons */
        .export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .export-btn {
            padding: 8px 16px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            transition: var(--transition);
        }

        .export-btn:hover {
            background: var(--primary-dark);
        }

        .export-btn.excel {
            background: var(--success);
        }

        .export-btn.pdf {
            background: var(--danger);
        }

        /* Validation Styles */
        .validation-error {
            border-color: var(--danger) !important;
            background: #fee2e2 !important;
        }

        .validation-success {
            border-color: var(--success) !important;
            background: #d1fae5 !important;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .controls-panel {
                grid-template-columns: 1fr;
            }
           
            .matrix-stats {
                justify-content: center;
            }
           
            .matrix-legend {
                justify-content: center;
            }
           
            .preview-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Advanced Filter Panel */
        .advanced-filters {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            display: none;
        }

        .advanced-filters.active {
            display: block;
        }

        .advanced-toggle {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        /* Bulk Input Modal */
        .bulk-input-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .bulk-input-modal.active {
            display: flex;
        }

        .bulk-input-content {
            background: white;
            padding: 30px;
            border-radius: var(--border-radius);
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .bulk-textarea {
            width: 100%;
            height: 300px;
            padding: 15px;
            border: 2px solid var(--gray-light);
            border-radius: 6px;
            font-family: monospace;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        /* Sample Data Input Section */
        .sample-data-panel {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-top: 20px;
            box-shadow: var(--shadow);
        }

        .sample-data-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--gray-light);
        }

        .sample-data-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .input-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .input-field {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--gray-light);
            border-radius: 4px;
        }

        .btn-add {
            background: var(--success);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .action-btn {
            padding: 8px 15px;
            background: var(--info);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.85rem;
        }

        /* Editable Cell Indicator */
        .editable-indicator {
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 0.7rem;
            color: var(--gray);
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1><i class="fas fa-table"></i> Enhanced Matching Matrix - Ticket Distribution System</h1>
            <p class="subtitle">7-Table Real-Time Auto-Population with Advanced Filtering & Input Modes</p>
            <p style="color: var(--gray); font-size: 0.95rem;">
                ALL cells are editable - Even fields not in the table can have data added
            </p>
        </div>

        <!-- Search Bar -->
        <div class="search-container">
            <i class="fas fa-search search-icon"></i>
            <input type="text" class="search-input" id="searchInput"
                   placeholder="Search columns, tables, or values... (Press Enter to highlight matches)">
        </div>

        <!-- Advanced Filters Toggle -->
        <button class="advanced-toggle" onclick="toggleAdvancedFilters()">
            <i class="fas fa-sliders-h"></i> Advanced Filters & Settings
        </button>

        <!-- Advanced Filters Panel -->
        <div class="advanced-filters" id="advancedFilters">
            <div class="filter-row">
                <div class="control-group">
                    <label class="control-label"><i class="fas fa-palette"></i> Highlight Mode</label>
                    <select class="control-input" id="highlightMode" onchange="applyHighlighting()">
                        <option value="NONE">No Highlighting</option>
                        <option value="SOURCE_TABLE">Highlight by Source Table</option>
                        <option value="DATA_TYPE">Highlight by Data Type</option>
                        <option value="REQUIRED_STATUS">Required/Optional</option>
                        <option value="RAG_STATUS">RAG Status</option>
                        <option value="AUTO_POP">Auto-populated Fields</option>
                        <option value="VALIDATION">Validation Status</option>
                        <option value="EMPTY">Empty Fields</option>
                        <option value="NON_EXISTENT">Non-existent Fields</option>
                    </select>
                </div>

                <div class="control-group">
                    <label class="control-label"><i class="fas fa-eye"></i> Display Options</label>
                    <select class="control-input" id="displayOptions" onchange="applyDisplayOptions()">
                        <option value="SHOW_DATA">Show Data Values</option>
                        <option value="SHOW_TYPE">Show Data Types</option>
                        <option value="SHOW_SOURCE">Show Source Table</option>
                        <option value="SHOW_TRANSFORMATION">Show Transformation Logic</option>
                        <option value="SHOW_VALIDATION">Show Validation Rules</option>
                    </select>
                </div>

                <div class="control-group">
                    <label class="control-label"><i class="fas fa-layer-group"></i> Display Mode</label>
                    <select class="control-input" id="displayMode" onchange="applyDisplayMode()">
                        <option value="FLAT">Flat List</option>
                        <option value="GROUPED">Grouped by Category</option>
                        <option value="TABLE_WISE">Grouped by Table</option>
                        <option value="COMPACT">Compact View</option>
                        <option value="EXPANDED">Expanded View</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- ENHANCED CONTROLS PANEL -->
        <div class="controls-panel">
            <div class="control-group">
                <label class="control-label"><i class="fas fa-table"></i> Table Filter</label>
                <select class="control-input" id="tableFilter" onchange="applyFilters()">
                    <option value="SHOW_ALL">Show All Tables</option>
                    <option value="TICKET_DATA">Ticket Data Only</option>
                    <option value="RATE_CARD">Service Rate Card Only</option>
                    <option value="DISPATCH">Dispatch Only</option>
                    <option value="STANDBY">Standby Only</option>
                    <option value="DEDICATED">Dedicated Only</option>
                    <option value="SV_VISIT">SV Visit Only</option>
                    <option value="PROJECT">Project Only</option>
                    <option value="FINAL_TABLE">Final Table Only</option>
                    <option value="CUSTOM_COMBO">Custom Combination</option>
                </select>
            </div>

            <div class="control-group">
                <label class="control-label"><i class="fas fa-tags"></i> Field Group</label>
                <select class="control-input" id="fieldGroupFilter" onchange="applyFilters()">
                    <option value="ALL">All Groups</option>
                    <option value="BASIC_INFO">Basic Information</option>
                    <option value="GEOGRAPHIC">Geographic Details</option>
                    <option value="SERVICE">Service Details</option>
                    <option value="TECHNICIAN">Technician & Time</option>
                    <option value="FINANCIAL">Financial Summary</option>
                    <option value="QUALITY">Quality & SLA</option>
                    <option value="RATES">Rate Card Fields</option>
                    <option value="PROJECT">Project Specific</option>
                    <option value="STAND_BY">Stand-by Specific</option>
                </select>
            </div>

            <div class="control-group">
                <label class="control-label"><i class="fas fa-sort"></i> Sort Order</label>
                <select class="control-input" id="sortOrder" onchange="applyFilters()">
                    <option value="ALPHABETICAL_ASC">A → Z</option>
                    <option value="ALPHABETICAL_DESC">Z → A</option>
                    <option value="TABLE_ORDER">Original Table Order</option>
                    <option value="REQUIRED_FIRST">Required Fields First</option>
                    <option value="MANDATORY_FIRST">Mandatory for Final First</option>
                    <option value="FREQUENCY">Most Common First</option>
                    <option value="DATA_TYPE">Group by Data Type</option>
                    <option value="FIELD_GROUP">Group by Field Category</option>
                    <option value="LAST_MODIFIED">Recently Modified First</option>
                </select>
            </div>

            <div class="control-group">
                <label class="control-label"><i class="fas fa-mode"></i> Input Mode</label>
                <select class="control-input" id="inputMode" onchange="handleInputMode()">
                    <option value="NORMAL">Normal Mode</option>
                    <option value="FINAL_TABLE">Final Table Centric</option>
                    <option value="TABLE_SPECIFIC">Table-Specific</option>
                    <option value="SITE_CATEGORY">Site Category Based</option>
                    <option value="BULK">Smart Bulk Input</option>
                    <option value="VALIDATION_FIRST">Validation-First Input</option>
                </select>
            </div>

            <div class="control-group">
                <label class="control-label"><i class="fas fa-flag"></i> RAG Status</label>
                <select class="control-input" id="ragFilter" onchange="applyFilters()">
                    <option value="ALL">All Fields</option>
                    <option value="REQUIRED">Mandatory Only</option>
                    <option value="OPTIONAL">Optional Only</option>
                    <option value="GREEN">Green (Standard)</option>
                    <option value="AMBER">Amber (Special)</option>
                    <option value="RED">Red (Critical)</option>
                </select>
            </div>

            <div class="control-group">
                <label class="control-label"><i class="fas fa-filter"></i> Data Type</label>
                <select class="control-input" id="dataTypeFilter" onchange="applyFilters()">
                    <option value="ALL">All Types</option>
                    <option value="TEXT">Text</option>
                    <option value="NUMBER">Number</option>
                    <option value="CURRENCY">Currency</option>
                    <option value="DATE">Date</option>
                    <option value="TIME">Time</option>
                    <option value="BOOLEAN">Yes/No</option>
                    <option value="DROPDOWN">Dropdown</option>
                    <option value="PERCENTAGE">Percentage</option>
                </select>
            </div>

            <div class="control-group">
                <label class="control-label"><i class="fas fa-eye"></i> Options</label>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <label><input type="checkbox" id="showRequiredOnly" onchange="applyFilters()"> Required Only</label>
                    <label><input type="checkbox" id="showEmptyOnly" onchange="applyFilters()"> Empty Fields</label>
                    <label><input type="checkbox" id="showTransformation" onchange="applyFilters()"> Show Transformation</label>
                </div>
            </div>

            <div class="control-group">
                <button class="control-input" style="background:var(--primary);color:white;cursor:pointer;" onclick="resetFilters()">
                    <i class="fas fa-sync"></i> Reset All Filters
                </button>
                <button class="control-input" style="background:var(--success);color:white;cursor:pointer;margin-top:10px;" onclick="showBulkInputModal()">
                    <i class="fas fa-paste"></i> Bulk Input
                </button>
            </div>
        </div>

        <!-- Site Category Filter (Hidden by default) -->
        <div class="control-group" id="siteCategoryGroup" style="display: none; margin-bottom: 20px;">
            <label class="control-label"><i class="fas fa-sitemap"></i> Site Category</label>
            <select class="control-input" id="siteCategory" onchange="filterBySiteCategory()">
                <option value="">All Categories</option>
                <option value="dispatch">Dispatch</option>
                <option value="dedicated">Dedicated</option>
                <option value="project">Project</option>
                <option value="sv">SV Visit</option>
                <option value="standby">Standby</option>
            </select>
        </div>

        <!-- Mode Toggle -->
        <div class="mode-toggle-container">
            <span class="toggle-label">Structural View (Column Existence)</span>
            <label class="toggle-switch">
                <input type="checkbox" id="matrixModeToggle" onchange="toggleMatrixMode()">
                <span class="toggle-slider"></span>
            </label>
            <span class="toggle-label">Data Preview Mode</span>
            <span style="margin-left: auto; font-size: 0.9rem; color: var(--gray);">
                <i class="fas fa-info-circle"></i> Smart Add Mode: <span id="smartAddStatus">ACTIVE</span>
            </span>
        </div>

        <!-- Matrix Container -->
        <div class="matrix-container">
            <table class="matrix-table" id="matrixTable">
                <thead>
                    <tr id="matrixHeader">
                        <!-- Header will be populated by JavaScript -->
                    </tr>
                </thead>
                <tbody id="matrixBody">
                    <!-- Matrix rows will be populated by JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- Matrix Legend -->
        <div class="matrix-legend">
            <div class="legend-item">
                <div class="legend-color legend-check"></div>
                <span>Field exists in table</span>
            </div>
            <div class="legend-item">
                <div class="legend-color legend-cross"></div>
                <span>Field not in table (but editable)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color legend-highlight"></div>
                <span>Search match</span>
            </div>
            <div class="legend-item">
                <div class="legend-color legend-match"></div>
                <span>Matching field</span>
            </div>
            <div class="legend-item">
                <div class="legend-color legend-required"></div>
                <span>Required field</span>
            </div>
            <div class="legend-item">
                <div class="legend-color legend-smart-add"></div>
                <span>Smart Add triggered</span>
            </div>
            <div class="legend-item">
                <span class="rag-green">●</span>
                <span>Green (Standard)</span>
            </div>
            <div class="legend-item">
                <span class="rag-amber">●</span>
                <span>Amber (Special)</span>
            </div>
            <div class="legend-item">
                <span class="rag-red">●</span>
                <span>Red (Critical)</span>
            </div>
        </div>

        <!-- Matrix Statistics -->
        <div class="matrix-stats">
            <div class="stat-item">
                <div class="stat-value" id="totalColumns">0</div>
                <div class="stat-label">Total Columns</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="commonColumns">0</div>
                <div class="stat-label">Common to All</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="uniqueColumns">0</div>
                <div class="stat-label">Unique Columns</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="requiredCount">0</div>
                <div class="stat-label">Required Fields</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="smartAddCount">0</div>
                <div class="stat-label">Smart Adds</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="autoPopulated">0</div>
                <div class="stat-label">Auto-Populated</div>
            </div>
        </div>

        <!-- Smart Add Indicator -->
        <div class="smart-add-indicator" id="smartAddIndicator">
            <i class="fas fa-bolt"></i>
            <span id="smartAddText">Smart Add: Updating tables...</span>
        </div>

        <!-- Sample Data Input Section -->
        <div class="sample-data-panel">
            <div class="sample-data-header">
                <h3><i class="fas fa-database"></i> Sample Data Input & Testing</h3>
                <div class="quick-actions">
                    <button class="action-btn" onclick="loadSampleData('hcl')">
                        <i class="fas fa-building"></i> Load HCL Data
                    </button>
                    <button class="action-btn" onclick="loadSampleData('fresenius')">
                        <i class="fas fa-hospital"></i> Load Fresenius Data
                    </button>
                    <button class="action-btn" onclick="clearAllData()">
                        <i class="fas fa-trash"></i> Clear All Data
                    </button>
                    <button class="action-btn" onclick="generateRandomData()">
                        <i class="fas fa-random"></i> Generate Random Data
                    </button>
                </div>
            </div>
           
            <div class="sample-data-controls">
                <div class="control-group">
                    <label class="control-label"><i class="fas fa-users"></i> Customer</label>
                    <select class="control-input" id="customerSelect" onchange="updateMatrixData()">
                        <option value="hcl">HCL Technologies</option>
                        <option value="fresenius">Fresenius Medical</option>
                        <option value="acme">Acme Corporation</option>
                        <option value="custom">Custom Customer</option>
                    </select>
                </div>
               
                <div class="control-group">
                    <label class="control-label"><i class="fas fa-building"></i> Account</label>
                    <select class="control-input" id="accountSelect" onchange="updateMatrixData()">
                        <option value="rev">Revenue Account</option>
                        <option value="prod">Production Account</option>
                        <option value="test">Test Account</option>
                        <option value="custom">Custom Account</option>
                    </select>
                </div>
               
                <div class="control-group">
                    <label class="control-label"><i class="fas fa-bolt"></i> Smart Add Mode</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="smartAddToggle" checked onchange="toggleSmartAdd()">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
           
            <!-- Quick Data Input -->
            <div style="margin-top: 20px; padding: 15px; background: var(--light); border-radius: 8px;">
                <h4 style="margin-bottom: 10px; color: var(--dark);">
                    <i class="fas fa-edit"></i> Quick Data Input
                </h4>
                <div class="input-row">
                    <input type="text" id="quickField" class="input-field" placeholder="Field Name (e.g., Customer Name)">
                    <input type="text" id="quickValue" class="input-field" placeholder="Value (e.g., HCL Technologies)">
                    <select id="quickTable" class="input-field">
                        <option value="all">All Tables</option>
                        <option value="ticket">Ticket Data</option>
                        <option value="rate">Rate Card</option>
                        <option value="dispatch">Dispatch</option>
                        <option value="standby">Standby</option>
                        <option value="dedicated">Dedicated</option>
                        <option value="sv">SV Visit</option>
                        <option value="project">Project</option>
                    </select>
                    <button class="btn-add" onclick="addQuickData()">
                        <i class="fas fa-plus"></i> Add Data
                    </button>
                </div>
                <p style="font-size: 0.8rem; color: var(--gray); margin-top: 10px;">
                    <i class="fas fa-info-circle"></i> Enter field name and value to test auto-population across tables
                </p>
            </div>
        </div>

        <!-- Final Table Preview -->
        <div class="final-table-preview">
            <div class="preview-header">
                <div class="preview-title">
                    <i class="fas fa-ticket-alt"></i>
                    Final Ticket Data Table Preview
                    <span style="font-size: 0.8rem; color: var(--gray); margin-left: 10px;">
                        (Auto-generated from all tables)
                    </span>
                </div>
                <div class="export-buttons">
                    <button class="export-btn" onclick="validateAllFields()">
                        <i class="fas fa-check-circle"></i> Validate All Fields
                    </button>
                    <button class="export-btn excel" onclick="exportToExcel()">
                        <i class="fas fa-file-excel"></i> Export Excel
                    </button>
                    <button class="export-btn pdf" onclick="exportToPDF()">
                        <i class="fas fa-file-pdf"></i> Export PDF
                    </button>
                    <button class="export-btn" onclick="exportValidationReport()">
                        <i class="fas fa-clipboard-check"></i> Validation Report
                    </button>
                </div>
            </div>
            <div class="preview-grid" id="finalTablePreview">
                <!-- Final table data will be populated here -->
            </div>
        </div>
    </div>

    <!-- Bulk Input Modal -->
    <div class="bulk-input-modal" id="bulkInputModal">
        <div class="bulk-input-content">
            <h3><i class="fas fa-paste"></i> Bulk Input Mode</h3>
            <p style="color: var(--gray); margin-bottom: 15px;">
                Paste data from Excel (CSV format) or enter multiple values separated by commas or tabs.
            </p>
            <textarea class="bulk-textarea" id="bulkTextarea" placeholder="Paste your data here...
Format: Field Name, Value, Table
Example:
Customer Name, HCL Technologies, all
Country, India, all
PO Number, INDOPO-6502, ticket"></textarea>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="export-btn" onclick="processBulkInput()">
                    <i class="fas fa-play"></i> Process Bulk Input
                </button>
                <button class="export-btn" style="background: var(--gray);" onclick="closeBulkInputModal()">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button class="export-btn" onclick="downloadTemplate()">
                    <i class="fas fa-download"></i> Download Template
                </button>
            </div>
        </div>
    </div>

    <script>
        // Complete System Data for 8 Tables (including Final Table) - UPDATED TO YOUR SPECS
        const systemData = {
            tables: [
                {
                    id: 1,
                    name: "Ticket Data Built-up",
                    key: "ticket",
                    description: "Primary service ticket entry point with RAG status indicators",
                    color: "#2563eb",
                    icon: "fa-clipboard-list",
                    columns: [
                        // YOUR ACTUAL FIELDS FROM THE TABLE
                        { name: "Site Category", type: "dropdown", required: true, group: "basic", rag: "green", requiredForFinal: true },
                        { name: "Customer Name", type: "text", required: true, group: "basic", rag: "green", requiredForFinal: true },
                        { name: "Partner Name", type: "text", required: true, group: "basic", rag: "green", requiredForFinal: false },
                        { name: "Customer Ticket Number", type: "text", required: true, group: "basic", rag: "green", requiredForFinal: true },
                        { name: "Customer Ticket Created Date", type: "date", required: true, group: "basic", rag: "green", requiredForFinal: false },
                        { name: "Partner Ticket Number", type: "text", required: true, group: "basic", rag: "green", requiredForFinal: false },
                        { name: "Source of Request", type: "text", required: true, group: "basic", rag: "green", requiredForFinal: false },
                        { name: "PO number", type: "text", required: false, group: "basic", rag: "amber", requiredForFinal: true },
                        { name: "Country", type: "text", required: true, group: "geographic", rag: "green", requiredForFinal: true },
                        { name: "State", type: "text", required: false, group: "geographic", rag: "amber", requiredForFinal: false },
                        { name: "City", type: "text", required: true, group: "geographic", rag: "green", requiredForFinal: true },
                        { name: "Site Address", type: "text", required: false, group: "geographic", rag: "amber", requiredForFinal: true },
                        { name: "Zip code", type: "text", required: false, group: "geographic", rag: "amber", requiredForFinal: false },
                        { name: "Activity Details", type: "text", required: true, group: "service", rag: "green", requiredForFinal: true },
                        { name: "Dispatch Category", type: "dropdown", required: false, group: "service", rag: "green", requiredForFinal: false },
                        { name: "Ticket Priority", type: "dropdown", required: true, group: "service", rag: "green", requiredForFinal: true },
                        { name: "ETA Date", type: "date", required: true, group: "service", rag: "green", requiredForFinal: true },
                        { name: "ETA Time", type: "time", required: true, group: "service", rag: "green", requiredForFinal: true },
                        { name: "Technician Name", type: "text", required: true, group: "technician", rag: "green", requiredForFinal: true },
                        { name: "Technician IN Date", type: "date", required: true, group: "technician", rag: "green", requiredForFinal: false },
                        { name: "Technician IN Time", type: "time", required: true, group: "technician", rag: "green", requiredForFinal: false },
                        { name: "Technician OUT Date", type: "date", required: true, group: "technician", rag: "green", requiredForFinal: false },
                        { name: "Technician OUT Time", type: "time", required: true, group: "technician", rag: "green", requiredForFinal: false },
                        { name: "Total Hours", type: "number", required: true, group: "technician", rag: "green", requiredForFinal: true },
                        // Cost calculation fields (24-48)
                        { name: "Currency", type: "dropdown", required: true, group: "financial", rag: "green", requiredForFinal: true },
                        { name: "Regular Rate", type: "currency", required: false, group: "financial", rag: "amber", requiredForFinal: false },
                        { name: "Overtime Rate", type: "currency", required: false, group: "financial", rag: "amber", requiredForFinal: false },
                        { name: "Weekend Rate", type: "currency", required: false, group: "financial", rag: "amber", requiredForFinal: false },
                        { name: "Travel Rate", type: "currency", required: false, group: "financial", rag: "amber", requiredForFinal: false },
                        { name: "Total Cost", type: "currency", required: true, group: "financial", rag: "amber", requiredForFinal: true },
                        { name: "Remarks", type: "text", required: false, group: "quality", rag: "green", requiredForFinal: false }
                    ]
                },
                {
                    id: 2,
                    name: "Service Rate Card",
                    key: "rate",
                    description: "Master rate reference for all services",
                    color: "#7c3aed",
                    icon: "fa-credit-card",
                    columns: [
                        { name: "Customer", type: "text", required: true, group: "basic", rag: "green", requiredForFinal: true },
                        { name: "Region", type: "text", required: true, group: "geographic", rag: "green", requiredForFinal: false },
                        { name: "Country", type: "text", required: true, group: "geographic", rag: "green", requiredForFinal: true },
                        { name: "Supplier", type: "text", required: true, group: "basic", rag: "green", requiredForFinal: false },
                        { name: "Currency", type: "dropdown", required: true, group: "financial", rag: "green", requiredForFinal: true },
                        { name: "Category", type: "dropdown", required: true, group: "basic", rag: "amber", requiredForFinal: true },
                        { name: "SR Region", type: "text", required: true, group: "geographic", rag: "green", requiredForFinal: false },
                        { name: "Rate Type", type: "dropdown", required: true, group: "financial", rag: "amber", requiredForFinal: true },
                        { name: "Rate Value", type: "currency", required: true, group: "financial", rag: "red", requiredForFinal: true },
                        { name: "After Hours", type: "currency", required: true, group: "financial", rag: "amber", requiredForFinal: false },
                        { name: "Weekend", type: "currency", required: true, group: "financial", rag: "amber", requiredForFinal: false },
                        { name: "Travel", type: "currency", required: true, group: "financial", rag: "amber", requiredForFinal: false },
                        { name: "Includes Travel", type: "boolean", required: true, group: "financial", rag: "green", requiredForFinal: false }
                    ]
                },
                {
                    id: 3,
                    name: "Dispatch Table",
                    key: "dispatch",
                    description: "For on-demand service dispatches",
                    color: "#10b981",
                    icon: "fa-truck-fast",
                    columns: [
                        { name: "Site Category", type: "dropdown", required: true, group: "basic", rag: "green", requiredForFinal: true },
                        { name: "Customer Name", type: "text", required: true, group: "basic", rag: "green", requiredForFinal: true },
                        { name: "Partner Name", type: "text", required: true, group: "basic", rag: "green", requiredForFinal: false },
                        { name: "Customer Ticket Number", type: "text", required: true, group: "basic", rag: "green", requiredForFinal: true },
                        { name: "Customer Ticket Created Date", type: "date", required: true, group: "basic", rag: "green", requiredForFinal: false },
                        { name: "Partner Ticket Number", type: "text", required: true, group: "basic", rag: "green", requiredForFinal: false },
                        { name: "Source of Request", type: "text", required: true, group: "basic", rag: "green", requiredForFinal: false },
                        { name: "PO number", type: "text", required: false, group: "basic", rag: "amber", requiredForFinal: true },
                        { name: "Country", type: "text", required: true, group: "geographic", rag: "green", requiredForFinal: true },
                        { name: "State", type: "text", required: false, group: "geographic", rag: "amber", requiredForFinal: false },
                        { name: "City", type: "text", required: true, group: "geographic", rag: "green", requiredForFinal: true },
                        { name: "Site Address", type: "text", required: false, group: "geographic", rag: "amber", requiredForFinal: true },
                        { name: "Zip code", type: "text", required: false, group: "geographic", rag: "amber", requiredForFinal: false },
                        { name: "Activity Details", type: "text", required: true, group: "service", rag: "green", requiredForFinal: true },
                        { name: "Dispatch Category", type: "dropdown", required: true, group: "service", rag: "green", requiredForFinal: false },
                        { name: "Ticket Priority", type: "dropdown", required: true, group: "service", rag: "green", requiredForFinal: true },
                        { name: "ETA Date", type: "date", required: true, group: "service", rag: "green", requiredForFinal: true },
                        { name: "ETA Time", type: "time", required: true, group: "service", rag: "green", requiredForFinal: true },
                        { name: "Technician Name", type: "text", required: true, group: "technician", rag: "green", requiredForFinal: true },
                        { name: "Technician IN Date", type: "date", required: true, group: "technician", rag: "green", requiredForFinal: false },
                        { name: "Technician IN Time", type: "time", required: true, group: "technician", rag: "green", requiredForFinal: false },
                        { name: "Technician OUT Date", type: "date", required: true, group: "technician", rag: "green", requiredForFinal: false },
                        { name: "Technician OUT Time", type: "time", required: true, group: "technician", rag: "green", requiredForFinal: false },
                        { name: "Total Hours", type: "number", required: true, group: "technician", rag: "green", requiredForFinal: true },
                        { name: "Currency", type: "dropdown", required: true, group: "financial", rag: "green", requiredForFinal: true },
                        { name: "Regular Rate", type: "currency", required: false, group: "financial", rag: "amber", requiredForFinal: false },
                        { name: "Total Cost", type: "currency", required: true, group: "financial", rag: "amber", requiredForFinal: true }
                    ]
                },
                {
                    id: 4,
                    name: "Dispatch Stand By Charges",
                    key: "standby",
                    description: "For standby time billing",
                    color: "#f59e0b",
                    icon: "fa-clock",
                    columns: [
                        { name: "Site Category", type: "dropdown", required: true, group: "basic", rag: "green", requiredForFinal: true },
                        { name: "Customer Name", type: "text", required: true, group: "basic", rag: "green", requiredForFinal: true },
                        { name: "Partner Name", type: "text", required: true, group: "basic", rag: "green", requiredForFinal: false },
                        { name: "Country", type: "text", required: true, group: "geographic", rag: "green", requiredForFinal: true },
                        { name: "State", type: "text", required: false, group: "geographic", rag: "amber", requiredForFinal: false },
                        { name: "City", type: "text", required: true, group: "geographic", rag: "green", requiredForFinal: true },
                        { name: "Site Address", type: "text", required: false, group: "geographic", rag: "amber", requiredForFinal: true },
                        { name: "Standby Start Time", type: "datetime", required: true, group: "technician", rag: "amber", requiredForFinal: true },
                        { name: "Standby End Time", type: "datetime", required: true, group: "technician", rag: "amber", requiredForFinal: true },
                        { name: "Standby Hours", type: "number", required: true, group: "technician", rag: "amber", requiredForFinal: true },
                        { name: "Standby Rate", type: "currency", required: true, group: "financial", rag: "red", requiredForFinal: true },
                        { name: "Total Standby Cost", type: "currency", required: true, group: "financial", rag: "red", requiredForFinal: true },
                        { name: "Currency", type: "dropdown", required: true, group: "financial", rag: "green", requiredForFinal: true }
                    ]
                },
                {
                    id: 5,
                    name: "Dedicated Table",
                    key: "dedicated",
                    description: "For monthly dedicated resources",
                    color: "#ef4444",
                    icon: "fa-user-tie",
                    columns: [
                        { name: "Site Category", type: "dropdown", required: true, group: "basic", rag: "green", requiredForFinal: true },
                        { name: "Customer Name", type: "text", required: true, group: "basic", rag: "green", requiredForFinal: true },
                        { name: "Partner Name", type: "text", required: true, group: "basic", rag: "green", requiredForFinal: false },
                        { name: "Country", type: "text", required: true, group: "geographic", rag: "green", requiredForFinal: true },
                        { name: "State", type: "text", required: false, group: "geographic", rag: "amber", requiredForFinal: false },
                        { name: "City", type: "text", required: true, group: "geographic", rag: "green", requiredForFinal: true },
                        { name: "Site Address", type: "text", required: false, group: "geographic", rag: "amber", requiredForFinal: true },
                        { name: "Zip code", type: "text", required: false, group: "geographic", rag: "amber", requiredForFinal: false },
                        { name: "PO number", type: "text", required: false, group: "basic", rag: "amber", requiredForFinal: true },
                        { name: "Technician Name", type: "text", required: true, group: "technician", rag: "green", requiredForFinal: true },
                        { name: "Band", type: "dropdown", required: true, group: "service", rag: "amber", requiredForFinal: true },
                        { name: "Variant", type: "dropdown", required: true, group: "service", rag: "amber", requiredForFinal: true },
                        { name: "Monthly rate", type: "currency", required: true, group: "financial", rag: "red", requiredForFinal: true },
                        { name: "SLA %", type: "percentage", required: true, group: "quality", rag: "red", requiredForFinal: true },
                        { name: "Currency", type: "dropdown", required: true, group: "financial", rag: "green", requiredForFinal: true }
                    ]
                },
                {
                    id: 6,
                    name: "SV, Full & Half Day Visit",
                    key: "sv",
                    description: "For scheduled visits with flat rates",
                    color: "#3b82f6",
                    icon: "fa-calendar-check",
                    columns: [
                        { name: "Site Category", type: "dropdown", required: true, group: "basic", rag: "green", requiredForFinal: true },
                        { name: "Customer Name", type: "text", required: true, group: "basic", rag: "green", requiredForFinal: true },
                        { name: "Partner Name", type: "text", required: true, group: "basic", rag: "green", requiredForFinal: false },
                        { name: "Customer Ticket Number", type: "text", required: true, group: "basic", rag: "green", requiredForFinal: true },
                        { name: "Customer Ticket Created Date", type: "date", required: true, group: "basic", rag: "green", requiredForFinal: false },
                        { name: "Partner Ticket Number", type: "text", required: true, group: "basic", rag: "green", requiredForFinal: false },
                        { name: "Source of Request", type: "text", required: true, group: "basic", rag: "green", requiredForFinal: false },
                        { name: "PO number", type: "text", required: false, group: "basic", rag: "amber", requiredForFinal: true },
                        { name: "Country", type: "text", required: true, group: "geographic", rag: "green", requiredForFinal: true },
                        { name: "State", type: "text", required: false, group: "geographic", rag: "amber", requiredForFinal: false },
                        { name: "City", type: "text", required: true, group: "geographic", rag: "green", requiredForFinal: true },
                        { name: "Site Address", type: "text", required: false, group: "geographic", rag: "amber", requiredForFinal: true },
                        { name: "Zip code", type: "text", required: false, group: "geographic", rag: "amber", requiredForFinal: false },
                        { name: "Activity Details", type: "text", required: true, group: "service", rag: "green", requiredForFinal: true },
                        { name: "Ticket Priority", type: "dropdown", required: true, group: "service", rag: "green", requiredForFinal: true },
                        { name: "ETA Date", type: "date", required: true, group: "service", rag: "green", requiredForFinal: true },
                        { name: "ETA Time", type: "time", required: true, group: "service", rag: "green", requiredForFinal: true },
                        { name: "Technician Name", type: "text", required: true, group: "technician", rag: "green", requiredForFinal: true },
                        { name: "Technician IN Date", type: "date", required: true, group: "technician", rag: "green", requiredForFinal: false },
                        { name: "Technician IN Time", type: "time", required: true, group: "technician", rag: "green", requiredForFinal: false },
                        { name: "Technician OUT Date", type: "date", required: true, group: "technician", rag: "green", requiredForFinal: false },
                        { name: "Technician OUT Time", type: "time", required: true, group: "technician", rag: "green", requiredForFinal: false },
                        { name: "Total Hours", type: "number", required: true, group: "technician", rag: "green", requiredForFinal: true },
                        { name: "Category", type: "dropdown", required: true, group: "service", rag: "green", requiredForFinal: false },
                        { name: "Half Day Rate", type: "currency", required: false, group: "financial", rag: "amber", requiredForFinal: false },
                        { name: "Full Day Rate", type: "currency", required: false, group: "financial", rag: "amber", requiredForFinal: false },
                        { name: "Per Hour Rate", type: "currency", required: false, group: "financial", rag: "amber", requiredForFinal: false },
                        { name: "Total Cost", type: "currency", required: true, group: "financial", rag: "amber", requiredForFinal: true },
                        { name: "Currency", type: "dropdown", required: true, group: "financial", rag: "green", requiredForFinal: true }
                    ]
                },
                {
                    id: 7,
                    name: "Project Work Table",
                    key: "project",
                    description: "For project-based engagements",
                    color: "#8b5cf6",
                    icon: "fa-project-diagram",
                    columns: [
                        { name: "Site Category", type: "dropdown", required: true, group: "basic", rag: "green", requiredForFinal: true },
                        { name: "Customer Name", type: "text", required: true, group: "basic", rag: "green", requiredForFinal: true },
                        { name: "Partner Name", type: "text", required: true, group: "basic", rag: "green", requiredForFinal: false },
                        { name: "Country", type: "text", required: true, group: "geographic", rag: "green", requiredForFinal: true },
                        { name: "State", type: "text", required: false, group: "geographic", rag: "amber", requiredForFinal: false },
                        { name: "City", type: "text", required: true, group: "geographic", rag: "green", requiredForFinal: true },
                        { name: "Site Address", type: "text", required: false, group: "geographic", rag: "amber", requiredForFinal: true },
                        { name: "Zip code", type: "text", required: false, group: "geographic", rag: "amber", requiredForFinal: false },
                        { name: "PO number", type: "text", required: false, group: "basic", rag: "amber", requiredForFinal: true },
                        { name: "Project Start Date", type: "date", required: true, group: "service", rag: "amber", requiredForFinal: true },
                        { name: "Project End Date", type: "date", required: true, group: "service", rag: "amber", requiredForFinal: true },
                        { name: "Estimated Hours", type: "number", required: true, group: "technician", rag: "amber", requiredForFinal: true },
                        { name: "Actual Hours", type: "number", required: true, group: "technician", rag: "amber", requiredForFinal: true },
                        { name: "Project Rate", type: "currency", required: true, group: "financial", rag: "red", requiredForFinal: true },
                        { name: "Estimated Cost", type: "currency", required: true, group: "financial", rag: "red", requiredForFinal: true },
                        { name: "Actual Cost", type: "currency", required: true, group: "financial", rag: "red", requiredForFinal: true },
                        { name: "Currency", type: "dropdown", required: true, group: "financial", rag: "green", requiredForFinal: true }
                    ]
                },
                {
                    id: 8,
                    name: "Final Ticket Data Table",
                    key: "final",
                    description: "Consolidated output - Auto-generated from all tables",
                    color: "#1e293b",
                    icon: "fa-ticket-alt",
                    columns: [
                        { name: "Request ID", type: "text", required: true, group: "system", rag: "green", requiredForFinal: true },
                        { name: "CUSTOMER REFERENCE", type: "text", required: true, group: "basic", rag: "green", requiredForFinal: true },
                        { name: "Requester", type: "text", required: true, group: "basic", rag: "green", requiredForFinal: true },
                        { name: "Subject", type: "text", required: true, group: "service", rag: "amber", requiredForFinal: true },
                        { name: "Site", type: "text", required: true, group: "geographic", rag: "green", requiredForFinal: true },
                        { name: "Priority", type: "dropdown", required: true, group: "service", rag: "amber", requiredForFinal: true },
                        { name: "Assigned Technician", type: "text", required: true, group: "technician", rag: "green", requiredForFinal: true },
                        { name: "Created Date", type: "date", required: true, group: "system", rag: "green", requiredForFinal: true },
                        { name: "Start Date/Time", type: "datetime", required: true, group: "system", rag: "green", requiredForFinal: true },
                        { name: "End Date/Time", type: "datetime", required: true, group: "system", rag: "green", requiredForFinal: true },
                        { name: "Account", type: "text", required: true, group: "basic", rag: "green", requiredForFinal: true },
                        { name: "Region", type: "text", required: true, group: "geographic", rag: "green", requiredForFinal: true },
                        { name: "Country", type: "text", required: true, group: "geographic", rag: "green", requiredForFinal: true },
                        { name: "City", type: "text", required: true, group: "geographic", rag: "green", requiredForFinal: true },
                        { name: "Engineer details", type: "text", required: false, group: "technician", rag: "green", requiredForFinal: false },
                        { name: "PO NUMBER", type: "text", required: true, group: "financial", rag: "amber", requiredForFinal: true },
                        { name: "Revenue", type: "currency", required: true, group: "financial", rag: "red", requiredForFinal: true },
                        { name: "Cost", type: "currency", required: true, group: "financial", rag: "red", requiredForFinal: true },
                        { name: "Profit", type: "currency", required: true, group: "financial", rag: "red", requiredForFinal: true },
                        { name: "Margin %", type: "percentage", required: true, group: "financial", rag: "red", requiredForFinal: true },
                        { name: "Vendor PO", type: "text", required: true, group: "financial", rag: "amber", requiredForFinal: true },
                        { name: "PRE Visit", type: "boolean", required: false, group: "service", rag: "green", requiredForFinal: false },
                        { name: "POST Visit", type: "boolean", required: false, group: "service", rag: "green", requiredForFinal: false }
                    ]
                }
            ],

            // Enhanced field mapping for auto-population
            fieldMapping: {
                "Site Category": { 
                    tables: ["ticket", "dispatch", "standby", "dedicated", "sv", "project"], 
                    transformation: "Direct mapping", 
                    autoPopulates: "Determines which tables get populated" 
                },
                "Customer Name": { 
                    tables: ["all"], 
                    transformation: "Direct mapping", 
                    autoPopulates: "ALL tables" 
                },
                "Customer": { 
                    tables: ["rate", "final"], 
                    transformation: "Same as Customer Name", 
                    dependencies: ["Customer Name"] 
                },
                "Account": { 
                    tables: ["final"], 
                    transformation: "Same as Customer Name", 
                    dependencies: ["Customer Name"] 
                },
                "Partner Name": { 
                    tables: ["ticket", "dispatch", "standby", "dedicated", "sv", "project"], 
                    transformation: "Direct mapping", 
                    autoPopulates: "ALL tables" 
                },
                "Supplier": { 
                    tables: ["rate"], 
                    transformation: "Same as Partner Name", 
                    dependencies: ["Partner Name"] 
                },
                "Country": { 
                    tables: ["all"], 
                    transformation: "Direct mapping", 
                    autoPopulates: "ALL tables" 
                },
                "City": { 
                    tables: ["all"], 
                    transformation: "Direct mapping", 
                    autoPopulates: "ALL tables" 
                },
                "Site Address": { 
                    tables: ["ticket", "dispatch", "standby", "dedicated", "sv", "project"], 
                    transformation: "Direct mapping", 
                    autoPopulates: "ALL tables" 
                },
                "Site": { 
                    tables: ["final"], 
                    transformation: "Same as Site Address", 
                    dependencies: ["Site Address"] 
                },
                "PO number": { 
                    tables: ["ticket", "dispatch", "dedicated", "sv", "project"], 
                    transformation: "Direct mapping", 
                    autoPopulates: "ALL tables" 
                },
                "PO NUMBER": { 
                    tables: ["final"], 
                    transformation: "Same as PO number", 
                    dependencies: ["PO number"] 
                },
                "Currency": { 
                    tables: ["all"], 
                    transformation: "From Rate Card or manual entry", 
                    autoPopulates: "ALL tables" 
                },
                "Technician Name": { 
                    tables: ["ticket", "dispatch", "dedicated", "sv"], 
                    transformation: "Direct mapping", 
                    autoPopulates: "ALL tables" 
                },
                "Assigned Technician": { 
                    tables: ["final"], 
                    transformation: "Same as Technician Name", 
                    dependencies: ["Technician Name"] 
                },
                "Ticket Priority": { 
                    tables: ["ticket", "dispatch", "sv"], 
                    transformation: "Direct mapping", 
                    autoPopulates: "Dispatch, SV tables" 
                },
                "Priority": { 
                    tables: ["final"], 
                    transformation: "Same as Ticket Priority", 
                    dependencies: ["Ticket Priority"] 
                },
                "Activity Details": { 
                    tables: ["ticket", "dispatch", "sv"], 
                    transformation: "Direct mapping", 
                    autoPopulates: "Dispatch, SV tables" 
                },
                "Customer Ticket Number": { 
                    tables: ["ticket", "dispatch", "sv"], 
                    transformation: "Direct mapping", 
                    autoPopulates: "Dispatch, SV tables" 
                },
                "CUSTOMER REFERENCE": { 
                    tables: ["final"], 
                    transformation: "Same as Customer Ticket Number", 
                    dependencies: ["Customer Ticket Number"] 
                }
            },

            // Sample data for preview
            sampleData: {
                hcl: {
                    rev: {
                        ticket: {
                            "Site Category": "Dispatch",
                            "Customer Name": "HCL Technologies",
                            "Partner Name": "Tech Services Ltd",
                            "Customer Ticket Number": "HCL-2024-00123",
                            "Customer Ticket Created Date": "2024-03-15",
                            "Partner Ticket Number": "TSL-2024-0456",
                            "Source of Request": "Email",
                            "PO number": "INDOPO-6502",
                            "Country": "India",
                            "State": "Karnataka",
                            "City": "Bangalore",
                            "Site Address": "Electronics City, Phase 1",
                            "Zip code": "560100",
                            "Activity Details": "Server Maintenance",
                            "Dispatch Category": "4H",
                            "Ticket Priority": "P1",
                            "ETA Date": "2024-03-16",
                            "ETA Time": "10:00",
                            "Technician Name": "Rajesh Kumar",
                            "Technician IN Date": "2024-03-16",
                            "Technician IN Time": "09:45",
                            "Technician OUT Date": "2024-03-16",
                            "Technician OUT Time": "17:45",
                            "Total Hours": "8",
                            "Currency": "INR",
                            "Regular Rate": "1200",
                            "Total Cost": "9600",
                            "Remarks": "Completed successfully"
                        },
                        rate: {
                            "Customer": "HCL Technologies",
                            "Region": "South Asia",
                            "Country": "India",
                            "Supplier": "Tech Services Ltd",
                            "Currency": "INR",
                            "Category": "Dispatch",
                            "SR Region": "Bangalore",
                            "Rate Type": "Hourly",
                            "Rate Value": "1200",
                            "After Hours": "1800",
                            "Weekend": "2400",
                            "Travel": "500",
                            "Includes Travel": "Yes"
                        },
                        dispatch: {
                            "Site Category": "Dispatch",
                            "Customer Name": "HCL Technologies",
                            "Partner Name": "Tech Services Ltd",
                            "Customer Ticket Number": "HCL-2024-00123",
                            "Customer Ticket Created Date": "2024-03-15",
                            "Partner Ticket Number": "TSL-2024-0456",
                            "Source of Request": "Email",
                            "PO number": "INDOPO-6502",
                            "Country": "India",
                            "State": "Karnataka",
                            "City": "Bangalore",
                            "Site Address": "Electronics City, Phase 1",
                            "Zip code": "560100",
                            "Activity Details": "Server Maintenance",
                            "Dispatch Category": "4H",
                            "Ticket Priority": "P1",
                            "ETA Date": "2024-03-16",
                            "ETA Time": "10:00",
                            "Technician Name": "Rajesh Kumar",
                            "Technician IN Date": "2024-03-16",
                            "Technician IN Time": "09:45",
                            "Technician OUT Date": "2024-03-16",
                            "Technician OUT Time": "17:45",
                            "Total Hours": "8",
                            "Currency": "INR",
                            "Regular Rate": "1200",
                            "Total Cost": "9600"
                        },
                        standby: {
                            "Site Category": "Standby",
                            "Customer Name": "HCL Technologies",
                            "Partner Name": "Tech Services Ltd",
                            "Country": "India",
                            "State": "Karnataka",
                            "City": "Bangalore",
                            "Site Address": "Electronics City",
                            "Standby Start Time": "2024-03-20 18:00",
                            "Standby End Time": "2024-03-21 06:00",
                            "Standby Hours": "12",
                            "Standby Rate": "2000",
                            "Total Standby Cost": "24000",
                            "Currency": "INR"
                        },
                        dedicated: {
                            "Site Category": "Dedicated",
                            "Customer Name": "HCL Technologies",
                            "Partner Name": "Tech Services Ltd",
                            "Country": "India",
                            "State": "Karnataka",
                            "City": "Bangalore",
                            "Site Address": "Electronics City, Phase 1",
                            "Zip code": "560100",
                            "PO number": "INDOPO-6502",
                            "Technician Name": "Amit Sharma",
                            "Band": "B2",
                            "Variant": "Senior",
                            "Monthly rate": "80000",
                            "SLA %": "95",
                            "Currency": "INR"
                        },
                        sv: {
                            "Site Category": "SV Visit",
                            "Customer Name": "HCL Technologies",
                            "Partner Name": "Tech Services Ltd",
                            "Customer Ticket Number": "HCL-2024-00234",
                            "Customer Ticket Created Date": "2024-03-10",
                            "Partner Ticket Number": "TSL-2024-0457",
                            "Source of Request": "Portal",
                            "PO number": "INDOPO-6503",
                            "Country": "India",
                            "State": "Karnataka",
                            "City": "Bangalore",
                            "Site Address": "Whitefield",
                            "Zip code": "560066",
                            "Activity Details": "Quarterly Maintenance",
                            "Ticket Priority": "P2",
                            "ETA Date": "2024-03-12",
                            "ETA Time": "09:00",
                            "Technician Name": "Priya Singh",
                            "Technician IN Date": "2024-03-12",
                            "Technician IN Time": "08:45",
                            "Technician OUT Date": "2024-03-12",
                            "Technician OUT Time": "17:15",
                            "Total Hours": "8.5",
                            "Category": "Full Day",
                            "Half Day Rate": "6000",
                            "Full Day Rate": "10000",
                            "Per Hour Rate": "1500",
                            "Total Cost": "10000",
                            "Currency": "INR"
                        },
                        project: {
                            "Site Category": "Project",
                            "Customer Name": "HCL Technologies",
                            "Partner Name": "Tech Services Ltd",
                            "Country": "India",
                            "State": "Karnataka",
                            "City": "Bangalore",
                            "Site Address": "Multiple locations",
                            "Zip code": "560100",
                            "PO number": "INDOPO-7001",
                            "Project Start Date": "2024-01-15",
                            "Project End Date": "2024-06-30",
                            "Estimated Hours": "1000",
                            "Actual Hours": "850",
                            "Project Rate": "1500",
                            "Estimated Cost": "1500000",
                            "Actual Cost": "1275000",
                            "Currency": "INR"
                        },
                        final: {
                            "Request ID": "REQ-1001",
                            "CUSTOMER REFERENCE": "HCL-2024-00123",
                            "Requester": "System Admin",
                            "Subject": "Server Maintenance | Bangalore | India | HCL Technologies",
                            "Site": "Electronics City, Phase 1",
                            "Priority": "P1",
                            "Assigned Technician": "Rajesh Kumar",
                            "Created Date": "2024-03-15",
                            "Start Date/Time": "2024-03-16 09:45",
                            "End Date/Time": "2024-03-16 17:45",
                            "Account": "HCL Technologies",
                            "Region": "South Asia",
                            "Country": "India",
                            "City": "Bangalore",
                            "Engineer details": "Rajesh Kumar - Tech Services Ltd",
                            "PO NUMBER": "INDOPO-6502",
                            "Revenue": "12000",
                            "Cost": "9600",
                            "Profit": "2400",
                            "Margin %": "20",
                            "Vendor PO": "INDO-PO-6502",
                            "PRE Visit": "Yes",
                            "POST Visit": "Yes"
                        }
                    }
                }
            },

            // Final Table Transformation Logic
            finalTable: [
                { field: "Request ID", source: "System", transformation: "Auto-generated sequential number", required: true },
                { field: "CUSTOMER REFERENCE", source: "Ticket Data", transformation: "Customer Ticket Number", required: true },
                { field: "Requester", source: "System", transformation: "Auto-set to 'System Admin' or manual", required: true },
                { field: "Subject", source: "Multiple", transformation: "Activity Details | City | Country | Customer Name", required: true },
                { field: "Site", source: "Ticket Data", transformation: "Site Address", required: true },
                { field: "Priority", source: "Ticket Data", transformation: "Ticket Priority", required: true },
                { field: "Assigned Technician", source: "Ticket Data", transformation: "Technician Name", required: true },
                { field: "Created Date", source: "Ticket Data", transformation: "Customer Ticket Created Date", required: true },
                { field: "Start Date/Time", source: "Ticket Data", transformation: "Technician IN Date + Technician IN Time", required: true },
                { field: "End Date/Time", source: "Ticket Data", transformation: "Technician OUT Date + Technician OUT Time", required: true },
                { field: "Account", source: "Ticket Data", transformation: "Customer Name", required: true },
                { field: "Region", source: "Rate Card", transformation: "Region", required: true },
                { field: "Country", source: "Ticket Data", transformation: "Country", required: true },
                { field: "City", source: "Ticket Data", transformation: "City", required: true },
                { field: "Engineer details", source: "Multiple", transformation: "Technician Name + Partner Name", required: false },
                { field: "PO NUMBER", source: "Ticket Data", transformation: "PO number", required: true },
                { field: "Revenue", source: "Calculated", transformation: "SUM of all service costs", required: true },
                { field: "Cost", source: "Calculated", transformation: "SUM of all service costs", required: true },
                { field: "Profit", source: "Calculated", transformation: "Revenue - Cost", required: true },
                { field: "Margin %", source: "Calculated", transformation: "(Profit / Revenue) * 100", required: true },
                { field: "Vendor PO", source: "Ticket Data", transformation: "[Country Code]-PO-[PO Number]", required: true },
                { field: "PRE Visit", source: "System", transformation: "Auto-set based on ETA date", required: false },
                { field: "POST Visit", source: "System", transformation: "Auto-set based on completion", required: false }
            ]
        };

        // Application State
        let currentState = {
            smartAddActive: true,
            isDataView: false,
            currentCustomer: "hcl",
            currentAccount: "rev",
            currentSiteCategory: "",
            lastModifiedField: null,
            lastModifiedValue: null,
            smartAddCount: 0,
            autoPopulatedCount: 0,
            validationErrors: [],
            modifiedFields: new Set(),
            currentRequestId: 1001,
            // Store all data including non-existent field data
            allData: {}
        };

        // Enhanced Filter State
        let filterState = {
            tableFilter: "SHOW_ALL",
            fieldGroup: "ALL",
            sortBy: "ALPHABETICAL_ASC",
            inputMode: "NORMAL",
            ragStatus: "ALL",
            dataType: "ALL",
            showRequiredOnly: false,
            showEmptyOnly: false,
            showTransformation: false,
            highlightMode: "NONE",
            displayOptions: "SHOW_DATA",
            displayMode: "FLAT"
        };

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeMatrix();
            setupEventListeners();
            updateFinalTablePreview();
            loadSampleData('hcl'); // Load default sample data
        });

        // Setup event listeners
        function setupEventListeners() {
            // Search input
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchMatrix(this.value);
                }
            });

            // Smart add toggle
            document.getElementById('smartAddToggle').addEventListener('change', function() {
                currentState.smartAddActive = this.checked;
                document.getElementById('smartAddStatus').textContent = this.checked ? 'ACTIVE' : 'INACTIVE';
                if (this.checked) {
                    showNotification('Smart Add Mode activated - Changes will auto-populate across tables', 'success');
                } else {
                    showNotification('Smart Add Mode deactivated', 'warning');
                }
            });

            // Debounce for smart add
            let debounceTimer;
            window.addEventListener('input', function(e) {
                if (e.target.classList.contains('cell-input')) {
                    const fieldName = e.target.getAttribute('data-field');
                    const tableId = e.target.getAttribute('data-table');
                    if (fieldName && tableId) {
                        currentState.modifiedFields.add(fieldName);
                        clearTimeout(debounceTimer);
                        debounceTimer = setTimeout(() => {
                            handleCellInput(e.target);
                        }, 300);
                    }
                }
            });
        }

        // Initialize the matrix
        function initializeMatrix() {
            renderMatrixHeader();
            applyFilters();
            renderMatrixBody();
            updateMatrixStats();
        }

        // Render matrix header
        function renderMatrixHeader() {
            const header = document.getElementById('matrixHeader');
            header.innerHTML = `
                <th style="min-width: 250px;">
                    <i class="fas fa-columns"></i> Field Name
                    <br><span style="font-size: 0.7rem; font-weight: normal;">(ALL cells are editable - even non-existent fields)</span>
                </th>
            `;
           
            systemData.tables.forEach(table => {
                header.innerHTML += `
                    <th style="background: ${table.color};">
                        <i class="fas ${table.icon}"></i> ${table.name}
                        <br><span style="font-size: 0.7rem; font-weight: normal;">${table.columns.length} fields</span>
                    </th>
                `;
            });
        }

        // Enhanced renderMatrixBody function with ALL cells editable
        function renderMatrixBody() {
            const body = document.getElementById('matrixBody');
            body.innerHTML = '';

            // Collect all fields from all tables
            let allFields = new Set();
            systemData.tables.forEach(table => {
                table.columns.forEach(col => {
                    allFields.add(col.name);
                });
            });

            // Also include fields from sample data that might not be in table definitions
            Object.values(systemData.sampleData).forEach(customerData => {
                Object.values(customerData).forEach(accountData => {
                    Object.values(accountData).forEach(tableData => {
                        Object.keys(tableData).forEach(fieldName => {
                            allFields.add(fieldName);
                        });
                    });
                });
            });

            let fieldList = Array.from(allFields).map(fieldName => {
                const fieldData = {
                    name: fieldName,
                    tables: [],
                    type: 'text',
                    required: false,
                    group: 'basic',
                    rag: 'green',
                    requiredForFinal: false
                };

                // Get field properties from tables that have it
                systemData.tables.forEach(table => {
                    const col = table.columns.find(c => c.name === fieldName);
                    if (col) {
                        fieldData.type = col.type;
                        fieldData.required = col.required;
                        fieldData.group = col.group;
                        fieldData.rag = col.rag;
                        fieldData.requiredForFinal = col.requiredForFinal || false;
                        fieldData.tables.push(table.id);
                    }
                });

                return fieldData;
            });

            // Apply filters
            let filteredFields = fieldList.filter(field => {
                // Table filter
                if (filterState.tableFilter !== "SHOW_ALL" && filterState.tableFilter !== "FINAL_TABLE") {
                    const tableMap = {
                        TICKET_DATA: 1,
                        RATE_CARD: 2,
                        DISPATCH: 3,
                        STANDBY: 4,
                        DEDICATED: 5,
                        SV_VISIT: 6,
                        PROJECT: 7,
                        FINAL_TABLE: 8
                    };
                    const targetId = tableMap[filterState.tableFilter];
                    if (!field.tables.includes(targetId)) return false;
                }

                // Field group filter
                if (filterState.fieldGroup !== "ALL") {
                    const groupMap = {
                        BASIC_INFO: "basic",
                        GEOGRAPHIC: "geographic",
                        SERVICE: "service",
                        TECHNICIAN: "technician",
                        FINANCIAL: "financial",
                        QUALITY: "quality",
                        RATES: "rates",
                        PROJECT: "project",
                        STAND_BY: "stand_by",
                        SYSTEM: "system"
                    };
                    const targetGroup = groupMap[filterState.fieldGroup] || filterState.fieldGroup.toLowerCase();
                    if (field.group !== targetGroup) return false;
                }

                // RAG filter
                if (filterState.ragStatus === "REQUIRED" && !field.required) return false;
                if (filterState.ragStatus === "OPTIONAL" && field.required) return false;
                if (filterState.ragStatus === "GREEN" && field.rag !== "green") return false;
                if (filterState.ragStatus === "AMBER" && field.rag !== "amber") return false;
                if (filterState.ragStatus === "RED" && field.rag !== "red") return false;

                // Data type filter
                if (filterState.dataType !== "ALL" && field.type.toUpperCase() !== filterState.dataType) return false;

                // Required only filter
                if (filterState.showRequiredOnly && !field.required) return false;

                // Empty fields filter
                if (filterState.showEmptyOnly) {
                    const hasData = field.tables.some(tableId => {
                        const data = getFieldData(field.name, tableId);
                        return data && data !== "—" && data !== "";
                    });
                    if (hasData) return false;
                }

                return true;
            });

            // Enhanced sorting
            filteredFields.sort((a, b) => {
                switch (filterState.sortBy) {
                    case "ALPHABETICAL_ASC": return a.name.localeCompare(b.name);
                    case "ALPHABETICAL_DESC": return b.name.localeCompare(a.name);
                    case "REQUIRED_FIRST":
                        return (b.required - a.required) || (b.requiredForFinal - a.requiredForFinal) || a.name.localeCompare(b.name);
                    case "MANDATORY_FIRST":
                        return (b.requiredForFinal - a.requiredForFinal) || (b.required - a.required) || a.name.localeCompare(b.name);
                    case "FREQUENCY": return b.tables.length - a.tables.length || a.name.localeCompare(b.name);
                    case "DATA_TYPE": return a.type.localeCompare(b.type) || a.name.localeCompare(b.name);
                    case "FIELD_GROUP": return a.group.localeCompare(b.group) || a.name.localeCompare(b.name);
                    case "LAST_MODIFIED":
                        return (b.lastModified || 0) - (a.lastModified || 0) || a.name.localeCompare(b.name);
                    default: return 0;
                }
            });

            // Render rows based on display mode
            if (filterState.displayMode === "GROUPED") {
                renderGroupedView(filteredFields);
            } else if (filterState.displayMode === "TABLE_WISE") {
                renderTableWiseView(filteredFields);
            } else {
                renderFlatView(filteredFields);
            }

            applyHighlighting();
            updateMatrixStats();
           
            // Add event listeners for editable cells
            addCellEditListeners();
        }

        // Flat view rendering with ALL cells editable
        function renderFlatView(filteredFields) {
            const body = document.getElementById('matrixBody');
           
            filteredFields.forEach(field => {
                const row = document.createElement('tr');
                row.setAttribute('data-field', field.name);
                row.setAttribute('data-group', field.group);
                row.setAttribute('data-type', field.type);
                row.setAttribute('data-rag', field.rag);
                row.setAttribute('data-required', field.required);

                // Field name cell with enhanced info
                const nameCell = document.createElement('td');
                let ragClass = `rag-${field.rag}`;
                nameCell.innerHTML = `
                    <div style="display:flex; align-items:center; gap:10px;">
                        <strong>${field.name}</strong>
                        <span style="font-size:0.7rem; color:var(--${field.rag === 'red' ? 'danger' : field.rag === 'amber' ? 'warning' : 'success'});">
                            ● ${field.rag.toUpperCase()}
                        </span>
                        <span style="font-size:0.7rem; color:var(--gray);">${field.group}</span>
                        ${field.required ? '<span style="font-size:0.7rem; color:var(--danger);">REQUIRED</span>' : ''}
                        ${field.requiredForFinal ? '<span style="font-size:0.7rem; color:var(--primary);">FINAL</span>' : ''}
                    </div>
                    ${filterState.showTransformation ? `<div style="font-size:0.7rem; color:var(--gray); margin-top:5px;">
                        <i class="fas fa-exchange-alt"></i> ${getTransformationLogic(field.name)}
                    </div>` : ''}
                `;
               
                // Add highlighting based on input mode
                if (filterState.inputMode === "FINAL_TABLE" && field.requiredForFinal) {
                    nameCell.classList.add('highlight-final-table');
                } else if (field.required) {
                    nameCell.classList.add('highlight-required');
                }
               
                row.appendChild(nameCell);

                // Table cells - ALL EDITABLE
                systemData.tables.forEach(table => {
                    const cell = document.createElement('td');
                    const hasField = field.tables.includes(table.id);
                    
                    // Get current data
                    const data = getFieldData(field.name, table.id);
                    
                    // Create input for ALL cells
                    if (currentState.isDataView) {
                        if (filterState.displayOptions === "SHOW_TYPE") {
                            cell.innerHTML = `<div class="cell-data"><small>${field.type}</small></div>`;
                        } else if (filterState.displayOptions === "SHOW_SOURCE") {
                            cell.innerHTML = `<div class="cell-data"><small>Source: ${table.name}</small></div>`;
                        } else if (filterState.displayOptions === "SHOW_TRANSFORMATION") {
                            cell.innerHTML = `<div class="cell-data"><small>${getTransformationLogic(field.name)}</small></div>`;
                        } else {
                            // Make ALL cells editable
                            const inputClass = hasField ? 'cell-input' : 'cell-input non-existent';
                            cell.innerHTML = `
                                <input type="text"
                                       class="${inputClass}"
                                       value="${data || ''}"
                                       data-field="${field.name}"
                                       data-table="${table.id}"
                                       placeholder="${hasField ? 'Enter value...' : 'Field not in table (but editable)'}">
                                ${!hasField ? '<div class="editable-indicator"><i class="fas fa-edit"></i></div>' : ''}
                            `;
                            cell.style.cursor = 'pointer';
                            cell.style.position = 'relative';
                        }
                    } else {
                        // Structural view - still show if field exists or not
                        if (hasField) {
                            cell.innerHTML = '<div class="cell-check">✔</div>';
                            cell.className = 'cell-check';
                        } else {
                            cell.innerHTML = '<div class="cell-cross">✖</div>';
                            cell.className = 'cell-cross';
                        }
                    }
                   
                    // Add data attributes for highlighting
                    cell.setAttribute('data-table', table.id);
                    cell.setAttribute('data-has-field', hasField);
                   
                    row.appendChild(cell);
                });

                body.appendChild(row);
            });
        }

        // Add cell edit listeners
        function addCellEditListeners() {
            const cells = document.querySelectorAll('.cell-input');
            cells.forEach(cell => {
                cell.addEventListener('dblclick', function(e) {
                    e.target.select();
                });
               
                cell.addEventListener('focus', function(e) {
                    e.target.style.background = '#f8fafc';
                });
               
                cell.addEventListener('blur', function(e) {
                    const hasField = e.target.classList.contains('non-existent') ? false : true;
                    if (!hasField) {
                        e.target.style.background = '#fef2f2';
                    }
                });
            });
        }

        // Handle cell input
        function handleCellInput(inputElement) {
            const fieldName = inputElement.getAttribute('data-field');
            const tableId = parseInt(inputElement.getAttribute('data-table'));
            const value = inputElement.value;
           
            // Update data
            updateFieldData(fieldName, tableId, value);
           
            // Handle smart add if active
            if (currentState.smartAddActive) {
                handleSmartAdd(fieldName, value, tableId);
            }
           
            // Update final table preview
            updateFinalTablePreview();
           
            // Update stats
            currentState.autoPopulatedCount++;
            updateMatrixStats();
        }

        // Get field data
        function getFieldData(fieldName, tableId) {
            // First check sample data
            const customer = currentState.currentCustomer;
            const account = currentState.currentAccount;
           
            // Map table ID to data key
            const tableMap = {
                1: 'ticket',
                2: 'rate',
                3: 'dispatch',
                4: 'standby',
                5: 'dedicated',
                6: 'sv',
                7: 'project',
                8: 'final'
            };
           
            const dataKey = tableMap[tableId];
            const data = systemData.sampleData[customer]?.[account]?.[dataKey];
           
            if (data && data[fieldName] !== undefined) {
                return data[fieldName];
            }
           
            // Check if we have stored data for non-existent fields
            const storageKey = `${dataKey}_${fieldName}`;
            if (currentState.allData[storageKey]) {
                return currentState.allData[storageKey];
            }
           
            // Check if field exists in table
            const table = systemData.tables.find(t => t.id === tableId);
            if (table) {
                const hasField = table.columns.some(col => col.name === fieldName);
                if (!hasField) {
                    return ""; // Return empty for non-existent fields
                }
            }
           
            // Generate sample data if not available
            return generateSampleData(fieldName, tableId);
        }

        // Update field data
        function updateFieldData(fieldName, tableId, value) {
            const customer = currentState.currentCustomer;
            const account = currentState.currentAccount;
           
            // Map table ID to data key
            const tableMap = {
                1: 'ticket',
                2: 'rate',
                3: 'dispatch',
                4: 'standby',
                5: 'dedicated',
                6: 'sv',
                7: 'project',
                8: 'final'
            };
           
            const dataKey = tableMap[tableId];
            if (!systemData.sampleData[customer]) {
                systemData.sampleData[customer] = {};
            }
            if (!systemData.sampleData[customer][account]) {
                systemData.sampleData[customer][account] = {};
            }
            if (!systemData.sampleData[customer][account][dataKey]) {
                systemData.sampleData[customer][account][dataKey] = {};
            }
           
            systemData.sampleData[customer][account][dataKey][fieldName] = value;
           
            // Also store in allData for non-existent fields
            const storageKey = `${dataKey}_${fieldName}`;
            currentState.allData[storageKey] = value;
           
            // Show notification
            const table = systemData.tables.find(t => t.id === tableId);
            const hasField = table.columns.some(col => col.name === fieldName);
            if (!hasField) {
                showNotification(`Added "${fieldName}" to ${table.name} (custom field)`, 'info');
            } else {
                showNotification(`Updated ${fieldName} in ${table.name}`, 'success');
            }
        }

        // Generate sample data
        function generateSampleData(fieldName, tableId) {
            const customer = currentState.currentCustomer;
            const account = currentState.currentAccount;
           
            // Check if we have existing data
            const tableMap = {
                1: 'ticket',
                2: 'rate',
                3: 'dispatch',
                4: 'standby',
                5: 'dedicated',
                6: 'sv',
                7: 'project',
                8: 'final'
            };
           
            const dataKey = tableMap[tableId];
            const existingData = systemData.sampleData[customer]?.[account]?.[dataKey];
           
            if (existingData && existingData[fieldName]) {
                return existingData[fieldName];
            }
           
            // Generate based on field type
            const table = systemData.tables.find(t => t.id === tableId);
            let fieldType = 'text';
            if (table) {
                const col = table.columns.find(c => c.name === fieldName);
                if (col) {
                    fieldType = col.type;
                }
            }
           
            const samples = {
                "Customer Name": ["HCL Technologies", "Fresenius Medical", "Acme Corp", "Global Enterprises"],
                "Customer": ["HCL Technologies", "Fresenius Medical", "Acme Corp", "Global Enterprises"],
                "Partner Name": ["Tech Services Ltd", "MediCare Solutions", "Global Partners", "Support Solutions Inc"],
                "Supplier": ["Tech Services Ltd", "MediCare Solutions", "Global Partners", "Support Solutions Inc"],
                "Country": ["India", "Germany", "USA", "UK", "Singapore", "Australia"],
                "City": ["Bangalore", "Berlin", "New York", "London", "Singapore", "Sydney"],
                "PO number": ["INDOPO-6502", "GERPO-4501", "USAPO-7890", "UKPO-1234", "SGPO-5678"],
                "Currency": ["INR", "EUR", "USD", "GBP", "SGD", "AUD"],
                "Technician Name": ["Rajesh Kumar", "Hans Müller", "John Smith", "Sarah Chen", "David Wilson", "Maria Garcia"],
                "Total Hours": ["8", "12", "6", "10", "24", "4", "16"],
                "Rate Value": ["1200", "1500", "2000", "850", "3000"],
                "Monthly rate": ["80000", "6500", "5000", "12000", "100000"],
                "Site Category": ["Dispatch", "Dedicated", "Project", "SV Visit", "Standby"],
                "Ticket Priority": ["P1", "P2", "P3", "P4"],
                "Dispatch Category": ["4H", "SBD", "NBD", "2BD"],
                "Activity Details": ["Server Maintenance", "Equipment Calibration", "System Implementation", "Network Setup", "Software Update"],
                "Site Address": ["Electronics City, Phase 1", "Alexanderplatz 1", "Market Street 123", "Oxford Street 456", "Raffles Place 789"],
                "ETA Time": ["10:00", "14:00", "09:00", "13:30", "15:45"],
                "Remarks": ["Completed successfully", "In progress", "Pending review", "Escalated to Level 2", "Resolved"]
            };
           
            for (const [key, values] of Object.entries(samples)) {
                if (fieldName.includes(key) || key.includes(fieldName)) {
                    return values[Math.floor(Math.random() * values.length)];
                }
            }
           
            // Default values based on type
            switch(fieldType) {
                case 'text': return "Sample Data";
                case 'number': return Math.floor(Math.random() * 100).toString();
                case 'currency': return (Math.random() * 1000).toFixed(2);
                case 'date': return new Date().toISOString().split('T')[0];
                case 'time': return "09:00";
                case 'datetime': return new Date().toISOString().replace('T', ' ');
                case 'boolean': return "Yes";
                case 'percentage': return "15";
                case 'dropdown': return "Option 1";
                default: return "Sample Value";
            }
        }

        // Handle smart add functionality
        function handleSmartAdd(fieldName, value, sourceTableId) {
            if (!currentState.smartAddActive) return;
           
            // Store last modified field
            currentState.lastModifiedField = fieldName;
            currentState.lastModifiedValue = value;
           
            // Find which tables should have this field
            const mapping = systemData.fieldMapping[fieldName];
            if (!mapping) return;
           
            let tablesToUpdate = [];
            if (mapping.tables[0] === 'all') {
                tablesToUpdate = systemData.tables.filter(t => t.id !== sourceTableId);
            } else {
                // Map table names to IDs
                const tableMap = {
                    'ticket': 1,
                    'rate': 2,
                    'dispatch': 3,
                    'standby': 4,
                    'dedicated': 5,
                    'sv': 6,
                    'project': 7,
                    'final': 8
                };
               
                tablesToUpdate = mapping.tables
                    .map(name => systemData.tables.find(t => t.id === tableMap[name]))
                    .filter(Boolean)
                    .filter(t => t.id !== sourceTableId);
            }
           
            // Update data in all relevant tables
            tablesToUpdate.forEach(table => {
                const hasField = table.columns.some(col => col.name === fieldName);
                if (hasField || mapping.tables[0] === 'all') {
                    updateFieldData(fieldName, table.id, value);
                }
            });
           
            // Update UI with smart add animation
            const rows = document.querySelectorAll(`tr[data-field="${fieldName}"]`);
            rows.forEach(row => {
                const cells = row.querySelectorAll('td:not(:first-child)');
                cells.forEach(cell => {
                    if (parseInt(cell.getAttribute('data-table')) !== sourceTableId) {
                        cell.classList.add('highlight-smart-add');
                        setTimeout(() => {
                            cell.classList.remove('highlight-smart-add');
                        }, 1000);
                    }
                });
            });
           
            // Show indicator
            showSmartAddIndicator(tablesToUpdate.length);
           
            // Update stats
            currentState.smartAddCount++;
            updateMatrixStats();
        }

        // Show smart add indicator
        function showSmartAddIndicator(tableCount) {
            const indicator = document.getElementById('smartAddIndicator');
            const text = document.getElementById('smartAddText');
           
            text.textContent = `Smart Add: Updated ${tableCount} tables with "${currentState.lastModifiedField}"`;
            indicator.style.display = 'flex';
           
            setTimeout(() => {
                indicator.style.display = 'none';
            }, 3000);
        }

        // Toggle matrix mode
        function toggleMatrixMode() {
            currentState.isDataView = document.getElementById('matrixModeToggle').checked;
            renderMatrixBody();
            updateMatrixStats();
           
            if (currentState.isDataView) {
                showNotification('Data Preview Mode: Showing actual data from selected customer/account', 'info');
            } else {
                showNotification('Structural View Mode: Showing column existence across tables', 'info');
            }
        }

        // Update matrix data based on selections
        function updateMatrixData() {
            currentState.currentCustomer = document.getElementById('customerSelect').value;
            currentState.currentAccount = document.getElementById('accountSelect').value;
           
            if (currentState.isDataView && currentState.currentCustomer && currentState.currentAccount) {
                renderMatrixBody();
                updateMatrixStats();
                updateFinalTablePreview();
                showNotification(`Showing data for ${currentState.currentCustomer.toUpperCase()} - ${currentState.currentAccount.toUpperCase()}`, 'success');
            }
        }

        // Search matrix
        function searchMatrix(searchTerm) {
            if (!searchTerm) {
                // Clear highlights
                document.querySelectorAll('.highlight-column').forEach(el => {
                    el.classList.remove('highlight-column');
                });
                return;
            }
           
            searchTerm = searchTerm.toLowerCase();
            const rows = document.querySelectorAll('#matrixBody tr[data-field]');
            let matchCount = 0;
           
            rows.forEach(row => {
                const fieldName = row.getAttribute('data-field').toLowerCase();
                const cells = row.querySelectorAll('td');
                let rowMatches = false;
               
                // Check field name
                if (fieldName.includes(searchTerm)) {
                    rowMatches = true;
                }
               
                // Check cell contents in data view
                if (currentState.isDataView) {
                    cells.forEach(cell => {
                        const input = cell.querySelector('input');
                        if (input) {
                            const cellText = input.value.toLowerCase();
                            if (cellText.includes(searchTerm) && cellText !== '') {
                                rowMatches = true;
                            }
                        }
                    });
                }
               
                // Highlight row if matches
                if (rowMatches) {
                    cells.forEach(cell => {
                        cell.classList.add('highlight-column');
                    });
                    matchCount++;
                    row.style.display = '';
                } else {
                    cells.forEach(cell => {
                        cell.classList.remove('highlight-column');
                    });
                    if (currentState.currentSiteCategory) {
                        row.style.display = 'none';
                    }
                }
            });
           
            showNotification(`Found ${matchCount} matches for "${searchTerm}"`, 'info');
        }

        // Update matrix statistics
        function updateMatrixStats() {
            const allFields = new Set();
            const requiredFields = new Set();
           
            systemData.tables.forEach(table => {
                table.columns.forEach(col => {
                    allFields.add(col.name);
                    if (col.required) {
                        requiredFields.add(col.name);
                    }
                });
            });
           
            // Also count custom fields from data
            Object.values(systemData.sampleData).forEach(customerData => {
                Object.values(customerData).forEach(accountData => {
                    Object.values(accountData).forEach(tableData => {
                        Object.keys(tableData).forEach(fieldName => {
                            allFields.add(fieldName);
                        });
                    });
                });
            });
           
            const totalFields = Array.from(allFields).length;
            const commonFields = Array.from(allFields).filter(field =>
                systemData.tables.every(table =>
                    table.columns.some(col => col.name === field)
                )
            ).length;
           
            const uniqueFields = Array.from(allFields).filter(field =>
                systemData.tables.filter(table =>
                    table.columns.some(col => col.name === field)
                ).length === 1
            ).length;
           
            document.getElementById('totalColumns').textContent = totalFields;
            document.getElementById('commonColumns').textContent = commonFields;
            document.getElementById('uniqueColumns').textContent = uniqueFields;
            document.getElementById('requiredCount').textContent = requiredFields.size;
            document.getElementById('smartAddCount').textContent = currentState.smartAddCount;
            document.getElementById('autoPopulated').textContent = currentState.autoPopulatedCount;
        }

        // Update final table preview
        function updateFinalTablePreview() {
            const preview = document.getElementById('finalTablePreview');
            preview.innerHTML = '';
           
            systemData.finalTable.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.className = 'preview-item';
               
                // Generate value based on transformation
                let value = generateFinalTableValue(item);
               
                itemElement.innerHTML = `
                    <div class="preview-field">${item.field}</div>
                    <div class="preview-value">${value}</div>
                    <div style="font-size: 0.7rem; color: var(--gray); margin-top: 5px;">
                        <i class="fas fa-database"></i> Source: ${item.source}
                        ${item.required ? '<span style="color: var(--danger); margin-left: 10px;">REQUIRED</span>' : ''}
                    </div>
                `;
                preview.appendChild(itemElement);
            });
        }

        // Generate final table value
        function generateFinalTableValue(item) {
            const customer = currentState.currentCustomer;
            const account = currentState.currentAccount;
            const ticketData = systemData.sampleData[customer]?.[account]?.ticket || {};
            const rateData = systemData.sampleData[customer]?.[account]?.rate || {};
            const finalData = systemData.sampleData[customer]?.[account]?.final || {};
           
            // Check if we have a direct value in final table data
            if (finalData[item.field]) {
                return finalData[item.field];
            }
           
            switch(item.field) {
                case "Request ID":
                    currentState.currentRequestId++;
                    return `REQ-${currentState.currentRequestId}`;
                case "Subject":
                    return `${ticketData["Activity Details"] || "Service"} | ${ticketData.City || "City"} | ${ticketData.Country || "Country"} | ${ticketData["Customer Name"] || "Customer"}`;
                case "CUSTOMER REFERENCE":
                    return ticketData["Customer Ticket Number"] || "—";
                case "Site":
                    return ticketData["Site Address"] || "—";
                case "Account":
                    return ticketData["Customer Name"] || "—";
                case "Country":
                    return ticketData["Country"] || "—";
                case "City":
                    return ticketData["City"] || "—";
                case "Assigned Technician":
                    return ticketData["Technician Name"] || "—";
                case "PO NUMBER":
                    return ticketData["PO number"] || "—";
                case "Vendor PO":
                    if (ticketData["PO number"] && ticketData["Country"]) {
                        const countryCode = getCountryCode(ticketData["Country"]);
                        return `${countryCode}-PO-${ticketData["PO number"].split('-').pop()}`;
                    }
                    return "—";
                case "Region":
                    return rateData["Region"] || "—";
                case "Priority":
                    return ticketData["Ticket Priority"] || "—";
                case "Requester":
                    return "System Admin";
                case "Created Date":
                    return ticketData["Customer Ticket Created Date"] || "—";
                case "Start Date/Time":
                    return `${ticketData["Technician IN Date"] || ""} ${ticketData["Technician IN Time"] || ""}`.trim() || "—";
                case "End Date/Time":
                    return `${ticketData["Technician OUT Date"] || ""} ${ticketData["Technician OUT Time"] || ""}`.trim() || "—";
                case "Engineer details":
                    if (ticketData["Technician Name"] && ticketData["Partner Name"]) {
                        return `${ticketData["Technician Name"]} - ${ticketData["Partner Name"]}`;
                    }
                    return "—";
                case "PRE Visit":
                    return "Yes";
                case "POST Visit":
                    return "Yes";
                case "Revenue":
                    return calculateRevenue();
                case "Cost":
                    return calculateCost();
                case "Profit":
                    return calculateProfit();
                case "Margin %":
                    return calculateMargin();
                default:
                    return "Auto-generated";
            }
        }

        // Helper functions
        function getCountryCode(country) {
            const codes = {
                "India": "INDO",
                "Germany": "GER",
                "USA": "USA",
                "UK": "UK",
                "Singapore": "SG",
                "Australia": "AUS"
            };
            return codes[country] || country.substring(0, 4).toUpperCase();
        }

        function calculateRevenue() {
            // Simplified calculation
            const customer = currentState.currentCustomer;
            const account = currentState.currentAccount;
            const ticketData = systemData.sampleData[customer]?.[account]?.ticket || {};
            const totalCost = parseFloat(ticketData["Total Cost"]) || 0;
            return (totalCost * 1.2).toFixed(2); // Add 20% margin
        }

        function calculateCost() {
            const customer = currentState.currentCustomer;
            const account = currentState.currentAccount;
            const ticketData = systemData.sampleData[customer]?.[account]?.ticket || {};
            return parseFloat(ticketData["Total Cost"]) || "0.00";
        }

        function calculateProfit() {
            const revenue = parseFloat(calculateRevenue()) || 0;
            const cost = parseFloat(calculateCost()) || 0;
            return (revenue - cost).toFixed(2);
        }

        function calculateMargin() {
            const revenue = parseFloat(calculateRevenue()) || 0;
            const profit = parseFloat(calculateProfit()) || 0;
            if (revenue === 0) return "0.00";
            return ((profit / revenue) * 100).toFixed(2);
        }

        function getTransformationLogic(fieldName) {
            const mapping = systemData.fieldMapping[fieldName];
            if (mapping && mapping.transformation) {
                return mapping.transformation;
            }
           
            const finalField = systemData.finalTable.find(f => f.transformation.includes(fieldName) || f.field === fieldName);
            if (finalField) {
                return finalField.transformation;
            }
           
            return "Direct mapping";
        }

        // Load sample data
        function loadSampleData(customer) {
            currentState.currentCustomer = customer;
            currentState.currentAccount = customer === 'hcl' ? 'rev' : 'prod';
           
            // Update dropdowns
            document.getElementById('customerSelect').value = customer;
            document.getElementById('accountSelect').value = currentState.currentAccount;
           
            // Render matrix with new data
            if (currentState.isDataView) {
                renderMatrixBody();
                updateFinalTablePreview();
                showNotification(`Loaded ${customer.toUpperCase()} sample data`, 'success');
            }
        }

        // Clear all data
        function clearAllData() {
            const customer = currentState.currentCustomer;
            const account = currentState.currentAccount;
           
            // Clear all data for current customer/account
            ['ticket', 'rate', 'dispatch', 'standby', 'dedicated', 'sv', 'project', 'final'].forEach(tableKey => {
                if (systemData.sampleData[customer] && systemData.sampleData[customer][account]) {
                    systemData.sampleData[customer][account][tableKey] = {};
                }
            });
           
            // Reset counters
            currentState.smartAddCount = 0;
            currentState.autoPopulatedCount = 0;
            currentState.allData = {};
           
            // Update display
            renderMatrixBody();
            updateMatrixStats();
            updateFinalTablePreview();
           
            showNotification('All data cleared for current customer/account', 'warning');
        }

        // Generate random data
        function generateRandomData() {
            const customer = currentState.currentCustomer;
            const account = currentState.currentAccount;
           
            // Generate data for all tables
            systemData.tables.forEach(table => {
                if (!systemData.sampleData[customer]) {
                    systemData.sampleData[customer] = {};
                }
                if (!systemData.sampleData[customer][account]) {
                    systemData.sampleData[customer][account] = {};
                }
               
                const tableKey = table.key;
                if (!systemData.sampleData[customer][account][tableKey]) {
                    systemData.sampleData[customer][account][tableKey] = {};
                }
               
                // Generate random data for each column
                table.columns.forEach(col => {
                    const value = generateSampleData(col.name, table.id);
                    systemData.sampleData[customer][account][tableKey][col.name] = value;
                });
            });
           
            // Update display
            renderMatrixBody();
            updateMatrixStats();
            updateFinalTablePreview();
           
            showNotification('Random data generated for all tables', 'success');
        }

        // Add quick data input
        function addQuickData() {
            const fieldName = document.getElementById('quickField').value.trim();
            const value = document.getElementById('quickValue').value.trim();
            const table = document.getElementById('quickTable').value;
           
            if (!fieldName || !value) {
                showNotification('Please enter both field name and value', 'warning');
                return;
            }
           
            // Map table names to IDs
            const tableMap = {
                'all': 'all',
                'ticket': 1,
                'rate': 2,
                'dispatch': 3,
                'standby': 4,
                'dedicated': 5,
                'sv': 6,
                'project': 7,
                'final': 8
            };
           
            if (table === 'all') {
                // Update all tables
                systemData.tables.forEach(t => {
                    updateFieldData(fieldName, t.id, value);
                });
            } else {
                updateFieldData(fieldName, tableMap[table], value);
            }
           
            // Clear inputs
            document.getElementById('quickField').value = '';
            document.getElementById('quickValue').value = '';
           
            // Update display
            renderMatrixBody();
            updateFinalTablePreview();
           
            showNotification(`Added ${fieldName} = ${value} to ${table}`, 'success');
        }

        // Toggle smart add
        function toggleSmartAdd() {
            currentState.smartAddActive = document.getElementById('smartAddToggle').checked;
            document.getElementById('smartAddStatus').textContent = currentState.smartAddActive ? 'ACTIVE' : 'INACTIVE';
        }

        // Apply filters
        function applyFilters() {
            // Update filter state from UI
            filterState.tableFilter = document.getElementById('tableFilter').value;
            filterState.fieldGroup = document.getElementById('fieldGroupFilter').value;
            filterState.sortBy = document.getElementById('sortOrder').value;
            filterState.inputMode = document.getElementById('inputMode').value;
            filterState.ragStatus = document.getElementById('ragFilter').value;
            filterState.dataType = document.getElementById('dataTypeFilter').value;
            filterState.showRequiredOnly = document.getElementById('showRequiredOnly').checked;
            filterState.showEmptyOnly = document.getElementById('showEmptyOnly').checked;
            filterState.showTransformation = document.getElementById('showTransformation').checked;

            renderMatrixBody();
            updateFinalTablePreview();
        }

        // Reset filters
        function resetFilters() {
            document.getElementById('tableFilter').value = "SHOW_ALL";
            document.getElementById('fieldGroupFilter').value = "ALL";
            document.getElementById('sortOrder').value = "ALPHABETICAL_ASC";
            document.getElementById('inputMode').value = "NORMAL";
            document.getElementById('ragFilter').value = "ALL";
            document.getElementById('dataTypeFilter').value = "ALL";
            document.getElementById('showRequiredOnly').checked = false;
            document.getElementById('showEmptyOnly').checked = false;
            document.getElementById('showTransformation').checked = false;
            document.getElementById('highlightMode').value = "NONE";
            document.getElementById('displayOptions').value = "SHOW_DATA";
            document.getElementById('displayMode').value = "FLAT";

            Object.assign(filterState, {
                tableFilter: "SHOW_ALL",
                fieldGroup: "ALL",
                sortBy: "ALPHABETICAL_ASC",
                inputMode: "NORMAL",
                ragStatus: "ALL",
                dataType: "ALL",
                showRequiredOnly: false,
                showEmptyOnly: false,
                showTransformation: false,
                highlightMode: "NONE",
                displayOptions: "SHOW_DATA",
                displayMode: "FLAT"
            });

            renderMatrixBody();
            showNotification("All filters reset", "success");
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : type === 'warning' ? '#f59e0b' : '#3b82f6'};
                color: white;
                border-radius: var(--border-radius);
                box-shadow: var(--shadow-lg);
                z-index: 2000;
                display: flex;
                align-items: center;
                gap: 10px;
                animation: slideIn 0.3s ease;
                max-width: 400px;
            `;
           
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                ${message}
            `;
           
            document.body.appendChild(notification);
           
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
           
            // Add animation styles if not present
            if (!document.querySelector('#notification-animations')) {
                const style = document.createElement('style');
                style.id = 'notification-animations';
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes slideOut {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100%); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
        }

        // The following functions are from the previous enhanced version
        // They are kept as placeholders since they were in the previous code

        function applyHighlighting() {
            filterState.highlightMode = document.getElementById('highlightMode').value;
            const rows = document.querySelectorAll('#matrixBody tr');
           
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const fieldName = row.getAttribute('data-field');
               
                cells.forEach(cell => {
                    // Remove all highlighting classes
                    cell.classList.remove('highlight-column', 'highlight-duplicate', 'highlight-match', 
                                         'highlight-smart-add', 'highlight-required', 'highlight-final-table',
                                         'validation-error', 'validation-success');
                   
                    const hasField = cell.getAttribute('data-has-field') === 'true';
                    const tableId = cell.getAttribute('data-table');
                   
                    switch(filterState.highlightMode) {
                        case 'SOURCE_TABLE':
                            if (tableId === '1') cell.classList.add('highlight-column');
                            break;
                        case 'REQUIRED_STATUS':
                            if (row.getAttribute('data-required') === 'true') {
                                cell.classList.add('highlight-required');
                            }
                            break;
                        case 'RAG_STATUS':
                            const rag = row.getAttribute('data-rag');
                            if (rag === 'red') cell.style.borderLeft = '3px solid var(--danger)';
                            else if (rag === 'amber') cell.style.borderLeft = '3px solid var(--warning)';
                            else if (rag === 'green') cell.style.borderLeft = '3px solid var(--success)';
                            break;
                        case 'NON_EXISTENT':
                            if (!hasField) {
                                cell.classList.add('validation-error');
                            }
                            break;
                        case 'EMPTY':
                            const input = cell.querySelector('input');
                            if (input && (!input.value || input.value.trim() === '')) {
                                cell.classList.add('validation-error');
                            }
                            break;
                    }
                });
            });
        }

        function applyDisplayOptions() {
            filterState.displayOptions = document.getElementById('displayOptions').value;
            applyFilters();
        }

        function applyDisplayMode() {
            filterState.displayMode = document.getElementById('displayMode').value;
            applyFilters();
        }

        function handleInputMode() {
            const inputMode = document.getElementById('inputMode').value;
            filterState.inputMode = inputMode;
           
            // Show/hide site category filter
            const siteCategoryGroup = document.getElementById('siteCategoryGroup');
            if (inputMode === "SITE_CATEGORY") {
                siteCategoryGroup.style.display = 'block';
            } else {
                siteCategoryGroup.style.display = 'none';
            }
           
            applyFilters();
           
            const modeNames = {
                'NORMAL': 'Normal Mode',
                'FINAL_TABLE': 'Final Table Centric Mode',
                'TABLE_SPECIFIC': 'Table-Specific Mode',
                'SITE_CATEGORY': 'Site Category Based Mode',
                'BULK': 'Smart Bulk Input Mode',
                'VALIDATION_FIRST': 'Validation-First Mode'
            };
           
            showNotification(`${modeNames[inputMode]} activated`, 'info');
        }

        function filterBySiteCategory() {
            currentState.currentSiteCategory = document.getElementById('siteCategory').value;
            applyFilters();
            showNotification(`Filtering by Site Category: ${currentState.currentSiteCategory}`, 'info');
        }

        function showBulkInputModal() {
            document.getElementById('bulkInputModal').classList.add('active');
        }

        function closeBulkInputModal() {
            document.getElementById('bulkInputModal').classList.remove('active');
        }

        function processBulkInput() {
            const textarea = document.getElementById('bulkTextarea');
            const lines = textarea.value.split('\n').filter(line => line.trim());
           
            let processedCount = 0;
            lines.forEach(line => {
                const parts = line.split(',').map(part => part.trim());
                if (parts.length >= 2) {
                    const fieldName = parts[0];
                    const value = parts[1];
                    const tables = parts[2] || 'all';
                   
                    updateFieldWithBulkInput(fieldName, value, tables);
                    processedCount++;
                }
            });
           
            showNotification(`Processed ${processedCount} records from bulk input`, 'success');
            closeBulkInputModal();
            renderMatrixBody();
            updateFinalTablePreview();
        }

        function updateFieldWithBulkInput(fieldName, value, tables) {
            let tableList = [];
            if (tables === 'all') {
                tableList = systemData.tables.map(t => t.id);
            } else {
                const tableMap = {
                    'ticket': 1, 'rate': 2, 'dispatch': 3,
                    'standby': 4, 'dedicated': 5, 'sv': 6, 
                    'project': 7, 'final': 8
                };
                tableList = tables.split(';').map(name => tableMap[name.trim()]).filter(Boolean);
            }
           
            tableList.forEach(tableId => {
                updateFieldData(fieldName, tableId, value);
            });
        }

        function exportToExcel() {
            const data = collectExportData();
            const csv = convertToCSV(data);
            downloadCSV(csv, 'ticket_system_export.csv');
            showNotification('Excel export generated successfully', 'success');
        }

        function exportToPDF() {
            showNotification('PDF export feature would be implemented with jsPDF library', 'info');
        }

        function exportValidationReport() {
            const report = generateValidationReport();
            const csv = convertToCSV(report);
            downloadCSV(csv, 'validation_report.csv');
            showNotification('Validation report exported', 'success');
        }

        function collectExportData() {
            const data = [];
            const rows = document.querySelectorAll('#matrixBody tr[data-field]');
           
            rows.forEach(row => {
                const fieldName = row.getAttribute('data-field');
                const rowData = { 'Field Name': fieldName };
               
                systemData.tables.forEach((table, index) => {
                    const cell = row.querySelector(`td:nth-child(${index + 2})`);
                    const input = cell?.querySelector('input');
                    if (input) {
                        rowData[table.name] = input.value || '';
                    } else {
                        rowData[table.name] = cell?.textContent.trim() || '';
                    }
                });
               
                data.push(rowData);
            });
           
            return data;
        }

        function convertToCSV(data) {
            if (data.length === 0) return '';
           
            const headers = Object.keys(data[0]);
            const csvRows = [headers.join(',')];
           
            data.forEach(row => {
                const values = headers.map(header => {
                    const value = row[header];
                    return `"${value ? value.toString().replace(/"/g, '""') : ''}"`;
                });
                csvRows.push(values.join(','));
            });
           
            return csvRows.join('\n');
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function validateAllFields() {
            currentState.validationErrors = [];
            const requiredFields = [];
           
            systemData.tables.forEach(table => {
                table.columns.forEach(col => {
                    if (col.required) {
                        requiredFields.push({
                            name: col.name,
                            table: table.name,
                            tableId: table.id
                        });
                    }
                });
            });
           
            requiredFields.forEach(field => {
                const data = getFieldData(field.name, field.tableId);
                if (!data || data === "" || data === "—") {
                    currentState.validationErrors.push({
                        field: field.name,
                        table: field.table,
                        message: `Required field "${field.name}" is empty in ${field.table}`
                    });
                }
            });
           
            updateValidationDisplay();
           
            if (currentState.validationErrors.length === 0) {
                showNotification('All required fields are valid!', 'success');
            } else {
                showNotification(`Found ${currentState.validationErrors.length} validation errors`, 'danger');
            }
        }

        function updateValidationDisplay() {
            const rows = document.querySelectorAll('#matrixBody tr[data-field]');
           
            rows.forEach(row => {
                const fieldName = row.getAttribute('data-field');
                const isError = currentState.validationErrors.some(error => error.field === fieldName);
               
                if (isError) {
                    row.classList.add('validation-error');
                    row.classList.remove('validation-success');
                } else {
                    row.classList.add('validation-success');
                    row.classList.remove('validation-error');
                }
            });
        }

        function generateValidationReport() {
            return currentState.validationErrors.map(error => ({
                'Field Name': error.field,
                'Table': error.table,
                'Status': 'ERROR',
                'Message': error.message,
                'Timestamp': new Date().toISOString()
            }));
        }

        function toggleAdvancedFilters() {
            const panel = document.getElementById('advancedFilters');
            panel.classList.toggle('active');
        }

        function downloadTemplate() {
            const template = `Field Name,Value,Tables
Site Category,Dispatch,ticket;dispatch;sv
Customer Name,HCL Technologies,all
Country,India,all
PO number,INDOPO-6502,ticket;dispatch;dedicated;sv
Technician Name,Rajesh Kumar,ticket;dispatch;sv;dedicated
Currency,INR,all
Ticket Priority,P1,ticket;dispatch;sv`;

            const blob = new Blob([template], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'bulk_input_template.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
           
            showNotification('Template downloaded successfully', 'success');
        }

        function renderGroupedView(filteredFields) {
            const body = document.getElementById('matrixBody');
            const groups = {};
           
            filteredFields.forEach(field => {
                if (!groups[field.group]) {
                    groups[field.group] = [];
                }
                groups[field.group].push(field);
            });
           
            Object.keys(groups).forEach(groupName => {
                const headerRow = document.createElement('tr');
                headerRow.className = 'group-header';
                const headerCell = document.createElement('td');
                headerCell.colSpan = systemData.tables.length + 1;
                headerCell.innerHTML = `
                    <div style="background: var(--light); padding: 10px; border-radius: 6px; font-weight: 600;">
                        <i class="fas fa-folder"></i> ${groupName.toUpperCase()}
                        <span style="font-size: 0.8rem; color: var(--gray); margin-left: 10px;">
                            ${groups[groupName].length} fields
                        </span>
                    </div>
                `;
                headerRow.appendChild(headerCell);
                body.appendChild(headerRow);
               
                groups[groupName].forEach(field => {
                    const row = document.createElement('tr');
                    row.setAttribute('data-field', field.name);
                   
                    const nameCell = document.createElement('td');
                    nameCell.innerHTML = `<strong>${field.name}</strong>`;
                    row.appendChild(nameCell);
                   
                    systemData.tables.forEach(table => {
                        const cell = document.createElement('td');
                        const hasField = field.tables.includes(table.id);
                        const data = getFieldData(field.name, table.id);
                        
                        if (currentState.isDataView) {
                            const inputClass = hasField ? 'cell-input' : 'cell-input non-existent';
                            cell.innerHTML = `
                                <input type="text"
                                       class="${inputClass}"
                                       value="${data || ''}"
                                       data-field="${field.name}"
                                       data-table="${table.id}"
                                       placeholder="${hasField ? 'Enter value...' : 'Field not in table'}">
                                ${!hasField ? '<div class="editable-indicator"><i class="fas fa-edit"></i></div>' : ''}
                            `;
                            cell.style.position = 'relative';
                        } else {
                            cell.innerHTML = hasField ? '<div class="cell-check">✔</div>' : '<div class="cell-cross">✖</div>';
                            cell.className = hasField ? 'cell-check' : 'cell-cross';
                        }
                       
                        cell.setAttribute('data-table', table.id);
                        cell.setAttribute('data-has-field', hasField);
                        row.appendChild(cell);
                    });
                   
                    body.appendChild(row);
                });
            });
        }

        function renderTableWiseView(filteredFields) {
            // Similar to grouped view but by table
            renderFlatView(filteredFields);
        }

        // Initialize with sample data
        setTimeout(() => {
            updateMatrixData();
            showNotification('Enhanced Matching Matrix loaded successfully! ALL cells are editable.', 'success');
        }, 500);
    </script>

                    
                </div>
            </div>

<!--------------------------------------------------------------- Matching matrix end of code  --------------------------------------------------->

































        </div>
    </div>
    
    <!-- Floating Window for Ticket Details (Hidden by default) -->
    <div class="floating-window" id="ticketDetailsWindow">
        <div class="floating-header">
            <h3><i class="fas fa-ticket-alt"></i> Ticket Details</h3>
            <button class="close-btn" id="closeDetailsWindow">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="floating-content" id="ticketDetailsContent">
            <!-- Ticket details will be loaded here -->
        </div>
    </div>
    
    <!-- Column Configuration Modal -->
    <div class="modal-overlay" id="columnConfigModal" style="display: none;">
        <div class="modal-container">
            <div class="modal-header">
                <h3><i class="fas fa-columns"></i> Configure Columns</h3>
                <button class="close-btn" id="closeColumnModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="column-categories">
                    <div class="category-section">
                        <h4><i class="fas fa-info-circle"></i> Basic Information</h4>
                        <div class="column-list" id="basicColumns"></div>
                    </div>
                    <div class="category-section">
                        <h4><i class="fas fa-calendar-alt"></i> Date & Time</h4>
                        <div class="column-list" id="dateColumns"></div>
                    </div>
                    <div class="category-section">
                        <h4><i class="fas fa-dollar-sign"></i> Cost & Billing</h4>
                        <div class="column-list" id="costColumns"></div>
                    </div>
                    <div class="category-section">
                        <h4><i class="fas fa-cogs"></i> Service Details</h4>
                        <div class="column-list" id="serviceColumns"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" id="resetColumns">Reset to Default</button>
                <button class="btn-primary" id="applyColumns">Apply Changes</button>
            </div>
        </div>
    </div>
    
    <style>
        /* STEP 1 - Ticket Upload & Validation */
        .ticket-upload-validation {
            background: #ffffff;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
            border: 1px solid #eaeaea;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f2f5;
        }
        
        .header-main h2 {
            color: #1a365d;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .header-main h2 i {
            color: #4299e1;
        }
        
        .header-subtitle {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .step-badge {
            background: linear-gradient(135deg, #4299e1, #3182ce);
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }
        
        .header-subtitle p {
            color: #718096;
            font-size: 14px;
            margin: 0;
        }
        
        .header-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn-icon-outline {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            border: 1.5px solid #e2e8f0;
            background: white;
            color: #4a5568;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .btn-icon-outline:hover {
            border-color: #4299e1;
            color: #4299e1;
            transform: translateY(-2px);
        }
        
        /* Data Sources Card */
        .data-sources-card {
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid #e2e8f0;
        }
        
        .data-sources-card h3 {
            color: #2d3748;
            font-size: 18px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .sources-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .source-item {
            background: white;
            border-radius: 10px;
            padding: 20px;
            display: flex;
            gap: 15px;
            align-items: flex-start;
            border: 1px solid #e2e8f0;
            transition: all 0.3s;
        }
        
        .source-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
            border-color: #4299e1;
        }
        
        .source-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: linear-gradient(135deg, #4299e1, #3182ce);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        .source-content h4 {
            color: #2d3748;
            font-size: 16px;
            margin-bottom: 8px;
        }
        
        .source-content p {
            color: #718096;
            font-size: 13px;
            margin-bottom: 4px;
        }
        
        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 380px 1fr;
            gap: 30px;
        }
        
        /* Left Panel Styles */
        .upload-card, .validation-card, .distribution-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.04);
        }
        
        .upload-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .upload-header h3 {
            color: #2d3748;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .upload-info {
            background: #e6f7ff;
            color: #1890ff;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .upload-area {
            border: 2px dashed #cbd5e0;
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            background: #fafbfc;
            margin-bottom: 20px;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .upload-area:hover, .upload-area.drag-over {
            border-color: #4299e1;
            background: #f0f9ff;
        }
        
        .upload-icon {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: linear-gradient(135deg, #e6fffa, #b2f5ea);
            color: #234e52;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 28px;
        }
        
        .upload-area h4 {
            color: #2d3748;
            margin-bottom: 8px;
            font-size: 18px;
        }
        
        .upload-area p {
            color: #718096;
            margin-bottom: 20px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #4299e1, #3182ce);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(66, 153, 225, 0.3);
        }
        
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .file-types {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }
        
        .file-types span {
            background: #edf2f7;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            color: #4a5568;
        }
        
        .upload-progress {
            margin: 20px 0;
        }
        
        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
            color: #4a5568;
        }
        
        .progress-bar {
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #48bb78, #38a169);
            transition: width 0.3s;
        }
        
        .uploaded-files {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: #f7fafc;
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid #e2e8f0;
        }
        
        .file-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .file-icon {
            color: #4299e1;
            font-size: 16px;
        }
        
        .file-name {
            font-weight: 500;
            color: #2d3748;
        }
        
        .file-size {
            font-size: 12px;
            color: #718096;
        }
        
        .file-status {
            font-size: 12px;
            padding: 3px 10px;
            border-radius: 12px;
            font-weight: 500;
        }
        
        .status-uploaded {
            background: #c6f6d5;
            color: #22543d;
        }
        
        .status-error {
            background: #fed7d7;
            color: #742a2a;
        }
        
        /* Validation Options */
        .validation-options {
            margin: 20px 0;
        }
        
        .option-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .option-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #4299e1;
        }
        
        .option-item label {
            color: #4a5568;
            font-size: 14px;
            cursor: pointer;
        }
        
        .validation-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .btn-secondary {
            background: #718096;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            width: 100%;
            justify-content: center;
        }
        
        .btn-secondary:hover:not(:disabled) {
            background: #4a5568;
            transform: translateY(-2px);
        }
        
        .btn-secondary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-tertiary {
            background: #edf2f7;
            color: #4a5568;
            border: 1px solid #cbd5e0;
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            width: 100%;
            justify-content: center;
        }
        
        .btn-tertiary:hover {
            background: #e2e8f0;
            border-color: #a0aec0;
            transform: translateY(-2px);
        }
        
        .full-width {
            width: 100%;
        }
        
        .validation-stats {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e2e8f0;
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .stat-value {
            font-weight: 600;
            color: #2d3748;
        }
        
        /* Distribution Options */
        .distribution-options {
            margin: 20px 0;
        }
        
        .dist-option {
            margin-bottom: 15px;
        }
        
        .dist-option label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #4a5568;
            font-size: 14px;
        }
        
        select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #cbd5e0;
            border-radius: 8px;
            background: white;
            color: #2d3748;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        select:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .btn-success:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(72, 187, 120, 0.3);
        }
        
        /* Right Panel Styles */
        .results-tabs {
            display: flex;
            gap: 2px;
            background: #edf2f7;
            padding: 4px;
            border-radius: 10px;
            margin-bottom: 25px;
        }
        
        .tab-btn {
            flex: 1;
            padding: 12px 16px;
            border: none;
            background: transparent;
            color: #718096;
            font-weight: 600;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
        }
        
        .tab-btn.active {
            background: white;
            color: #4299e1;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .results-header h3 {
            color: #2d3748;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .results-actions {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .view-toggle {
            display: flex;
            background: #edf2f7;
            padding: 4px;
            border-radius: 8px;
        }
        
        .view-btn {
            padding: 8px 16px;
            border: none;
            background: transparent;
            color: #718096;
            font-weight: 500;
            cursor: pointer;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }
        
        .view-btn.active {
            background: white;
            color: #4299e1;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
        }
        
        .table-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .search-box {
            position: relative;
            width: 200px;
        }
        
        .search-box i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #a0aec0;
        }
        
        .search-box input {
            width: 100%;
            padding: 10px 12px 10px 36px;
            border: 1px solid #cbd5e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .search-box input:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }
        
        .btn-icon-sm {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            background: white;
            color: #718096;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .btn-icon-sm:hover {
            border-color: #4299e1;
            color: #4299e1;
        }
        
        .validation-summary {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .summary-item {
            background: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }
        
        .summary-item.success {
            border-top: 4px solid #48bb78;
        }
        
        .summary-item.warning {
            border-top: 4px solid #ed8936;
        }
        
        .summary-item.error {
            border-top: 4px solid #f56565;
        }
        
        .summary-item.total {
            border-top: 4px solid #4299e1;
        }
        
        .summary-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .summary-item.success .summary-value {
            color: #48bb78;
        }
        
        .summary-item.warning .summary-value {
            color: #ed8936;
        }
        
        .summary-item.error .summary-value {
            color: #f56565;
        }
        
        .summary-item.total .summary-value {
            color: #4299e1;
        }
        
        .summary-label {
            color: #718096;
            font-size: 13px;
            font-weight: 500;
        }
        
        /* Data Views */
        .data-view {
            display: none;
        }
        
        .data-view.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        /* Table View */
        .table-container-wrapper {
            overflow-x: auto;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
            background: white;
            margin-bottom: 20px;
            max-height: 500px;
            overflow-y: auto;
        }
        
        .validation-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            min-width: 1200px;
        }
        
        .validation-table thead {
            background: #f7fafc;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .validation-table th {
            padding: 14px 12px;
            text-align: left;
            font-weight: 600;
            color: #4a5568;
            border-bottom: 2px solid #e2e8f0;
            white-space: nowrap;
            position: relative;
        }
        
        .validation-table th.sortable {
            cursor: pointer;
        }
        
        .validation-table th.sortable:hover {
            background: #edf2f7;
        }
        
        .validation-table th .sort-icon {
            margin-left: 4px;
            opacity: 0.5;
        }
        
        .validation-table th.sort-asc .sort-icon,
        .validation-table th.sort-desc .sort-icon {
            opacity: 1;
            color: #4299e1;
        }
        
        .validation-table td {
            padding: 12px;
            border-bottom: 1px solid #edf2f7;
            vertical-align: top;
        }
        
        .validation-table tbody tr:hover {
            background: #f7fafc;
        }
        
        .status-cell {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
        }
        
        .status-valid {
            background: #c6f6d5;
            color: #22543d;
        }
        
        .status-warning {
            background: #feebc8;
            color: #744210;
        }
        
        .status-error {
            background: #fed7d7;
            color: #742a2a;
        }
        
        /* Pagination */
        .pagination-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: white;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .pagination-info {
            color: #718096;
            font-size: 14px;
        }
        
        .pagination-buttons {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .pagination-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            background: white;
            color: #4a5568;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .pagination-btn:hover:not(:disabled) {
            border-color: #4299e1;
            color: #4299e1;
        }
        
        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .page-numbers {
            display: flex;
            gap: 2px;
        }
        
        .page-number {
            min-width: 36px;
            height: 36px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            background: white;
            color: #4a5568;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .page-number:hover {
            border-color: #4299e1;
            color: #4299e1;
        }
        
        .page-number.active {
            background: #4299e1;
            color: white;
            border-color: #4299e1;
        }
        
        .rows-per-page select {
            width: auto;
            padding: 8px 12px;
        }
        
        /* Form View */
        .form-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px 20px;
            background: white;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
        }
        
        .form-nav-btn {
            padding: 10px 20px;
            border: 1px solid #cbd5e0;
            background: white;
            color: #4a5568;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }
        
        .form-nav-btn:hover:not(:disabled) {
            border-color: #4299e1;
            color: #4299e1;
        }
        
        .form-nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .form-counter {
            font-weight: 600;
            color: #2d3748;
        }
        
        .ticket-form {
            background: white;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
            padding: 25px;
        }
        
        .form-section {
            margin-bottom: 30px;
        }
        
        .form-section h4 {
            color: #2d3748;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f2f5;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .form-field {
            margin-bottom: 15px;
        }
        
        .form-field label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #4a5568;
            font-size: 14px;
        }
        
        .form-field .field-value {
            padding: 10px 12px;
            background: #f7fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            color: #2d3748;
            min-height: 40px;
            display: flex;
            align-items: center;
        }
        
        .form-field .field-value.empty {
            color: #a0aec0;
            font-style: italic;
        }
        
        /* Modal Overlay */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }
        
        .modal-container {
            background: white;
            border-radius: 16px;
            width: 800px;
            max-width: 90%;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 25px;
            background: linear-gradient(135deg, #1a365d, #2d3748);
            color: white;
        }
        
        .modal-header h3 {
            margin: 0;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .modal-body {
            padding: 25px;
            overflow-y: auto;
            flex: 1;
        }
        
        .modal-footer {
            padding: 20px 25px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
        
        .column-categories {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }
        
        .category-section h4 {
            color: #2d3748;
            margin-bottom: 15px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .column-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 12px;
        }
        
        .column-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            background: #f7fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            transition: all 0.2s;
        }
        
        .column-item:hover {
            background: #edf2f7;
        }
        
        .column-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: #4299e1;
        }
        
        .column-item label {
            flex: 1;
            color: #4a5568;
            font-size: 14px;
            cursor: pointer;
            user-select: none;
        }
        
        /* Analytics Tab */
        .analytics-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .analytics-header h3 {
            color: #2d3748;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .analytics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }
        
        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.04);
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .chart-header h4 {
            color: #2d3748;
            font-size: 16px;
            font-weight: 600;
        }
        
        .btn-icon-xs {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            background: white;
            color: #718096;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .btn-icon-xs:hover {
            border-color: #4299e1;
            color: #4299e1;
        }
        
        .chart-wrapper {
            height: 250px;
            position: relative;
        }
        
        .stats-container {
            grid-column: span 2;
            background: white;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.04);
        }
        
        .stats-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .stat-item-large {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 20px;
            background: #f7fafc;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
        }
        
        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: linear-gradient(135deg, #4299e1, #3182ce);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        .stat-icon.success {
            background: linear-gradient(135deg, #48bb78, #38a169);
        }
        
        .stat-icon.pending {
            background: linear-gradient(135deg, #ed8936, #dd6b20);
        }
        
        .stat-icon.warning {
            background: linear-gradient(135deg, #ecc94b, #d69e2e);
        }
        
        .stat-content .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 4px;
        }
        
        .stat-content .stat-label {
            color: #718096;
            font-size: 14px;
        }
        
        /* Distribution Progress */
        .distribution-progress {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.04);
        }
        
        .progress-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .progress-title span:first-child {
            color: #2d3748;
            font-weight: 600;
        }
        
        .progress-percent-large {
            font-size: 24px;
            font-weight: 700;
            color: #4299e1;
        }
        
        .progress-bar-large {
            height: 10px;
            background: #e2e8f0;
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 15px;
        }
        
        .progress-fill-large {
            height: 100%;
            background: linear-gradient(90deg, #4299e1, #3182ce);
            transition: width 0.5s ease;
        }
        
        .progress-details {
            display: flex;
            justify-content: space-between;
            color: #718096;
            font-size: 14px;
        }
        
        .progress-details strong {
            color: #2d3748;
        }
        
        /* Floating Window */
        .floating-window {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 700px;
            max-width: 90%;
            max-height: 80vh;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            z-index: 1001;
            display: none;
            flex-direction: column;
            overflow: hidden;
            animation: windowAppear 0.3s ease;
        }
        
        @keyframes windowAppear {
            from {
                opacity: 0;
                transform: translate(-50%, -40%);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
        }
        
        .floating-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 25px;
            background: linear-gradient(135deg, #1a365d, #2d3748);
            color: white;
        }
        
        .floating-header h3 {
            margin: 0;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .close-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .floating-content {
            padding: 25px;
            overflow-y: auto;
            flex: 1;
        }
        
        /* Responsive Design */
        @media (max-width: 1200px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .analytics-grid {
                grid-template-columns: 1fr;
            }
            
            .validation-summary {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .results-actions {
                width: 100%;
                justify-content: space-between;
            }
            
            .table-controls {
                flex: 1;
                justify-content: flex-end;
            }
        }
        
        @media (max-width: 768px) {
            .section-header {
                flex-direction: column;
                gap: 15px;
            }
            
            .header-subtitle {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .sources-grid {
                grid-template-columns: 1fr;
            }
            
            .validation-summary {
                grid-template-columns: 1fr;
            }
            
            .stats-list {
                grid-template-columns: 1fr;
            }
            
            .results-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .results-actions {
                flex-direction: column;
                gap: 10px;
            }
            
            .table-controls {
                width: 100%;
                justify-content: space-between;
            }
            
            .search-box {
                flex: 1;
                min-width: 150px;
            }
            
            .pagination-controls {
                flex-direction: column;
                gap: 15px;
            }
            
            .pagination-buttons {
                order: 1;
            }
            
            .pagination-info {
                order: 2;
            }
            
            .rows-per-page {
                order: 3;
            }
            
            .form-navigation {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
    
    <script>
        // Wait for DOM to be fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize state
            let uploadedFiles = [];
            let validationResults = [];
            let distributionStatus = [];
            let sampleData = [];
            let currentView = 'table';
            let currentPage = 1;
            let rowsPerPage = 25;
            let totalPages = 1;
            let sortColumn = null;
            let sortDirection = 'asc';
            let currentFormIndex = 0;
            let columnVisibility = {};
            let columnDefinitions = [];
            
            // DOM Elements
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            const browseBtn = document.getElementById('browseBtn');
            const uploadProgress = document.getElementById('uploadProgress');
            const uploadedFilesDiv = document.getElementById('uploadedFiles');
            const validateFilesBtn = document.getElementById('validateFilesBtn');
            const startDistributionBtn = document.getElementById('startDistributionBtn');
            const fileCount = document.getElementById('fileCount');
            const ticketDetailsWindow = document.getElementById('ticketDetailsWindow');
            const closeDetailsWindow = document.getElementById('closeDetailsWindow');
            const ticketDetailsContent = document.getElementById('ticketDetailsContent');
            const loadSampleDataBtn = document.getElementById('loadSampleDataBtn');
            const columnConfigModal = document.getElementById('columnConfigModal');
            const closeColumnModal = document.getElementById('closeColumnModal');
            const resetColumnsBtn = document.getElementById('resetColumns');
            const applyColumnsBtn = document.getElementById('applyColumns');
            const columnToggleBtn = document.getElementById('columnToggleBtn');
            const tableSearch = document.getElementById('tableSearch');
            const rowsPerPageSelect = document.getElementById('rowsPerPage');
            const prevPageBtn = document.getElementById('prevPage');
            const nextPageBtn = document.getElementById('nextPage');
            const firstPageBtn = document.getElementById('firstPage');
            const lastPageBtn = document.getElementById('lastPage');
            const pageNumbersDiv = document.getElementById('pageNumbers');
            const viewBtns = document.querySelectorAll('.view-btn');
            const prevTicketBtn = document.getElementById('prevTicket');
            const nextTicketBtn = document.getElementById('nextTicket');
            
            // Initialize column definitions
            initializeColumnDefinitions();
            
            // Tab functionality
            const tabBtns = document.querySelectorAll('.tab-btn');
            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const tabId = btn.getAttribute('data-tab');
                    
                    // Update active tab
                    tabBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    // Show corresponding tab content
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(`${tabId}Tab`).classList.add('active');
                    
                    // If validation tab, update views
                    if (tabId === 'validation' && validationResults.length > 0) {
                        updateDataViews();
                    }
                });
            });
            
            // View toggle functionality
            viewBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const view = btn.getAttribute('data-view');
                    
                    // Update active view button
                    viewBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    // Show corresponding view
                    document.querySelectorAll('.data-view').forEach(viewElement => {
                        viewElement.classList.remove('active');
                    });
                    document.getElementById(`${view}View`).classList.add('active');
                    
                    currentView = view;
                    
                    // Update form view if needed
                    if (view === 'form' && validationResults.length > 0) {
                        currentFormIndex = 0;
                        updateFormView();
                    }
                });
            });
            
            // File upload functionality
            browseBtn.addEventListener('click', () => {
                fileInput.click();
            });
            
            uploadArea.addEventListener('click', () => {
                fileInput.click();
            });
            
            // Drag and drop functionality
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, unhighlight, false);
            });
            
            function highlight() {
                uploadArea.classList.add('drag-over');
            }
            
            function unhighlight() {
                uploadArea.classList.remove('drag-over');
            }
            
            uploadArea.addEventListener('drop', handleDrop, false);
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                handleFiles(files);
            }
            
            fileInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });
            
            function handleFiles(files) {
                [...files].forEach(file => {
                    uploadFile(file);
                });
            }
            
            function uploadFile(file) {
                const fileId = Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                const fileItem = {
                    id: fileId,
                    name: file.name,
                    size: formatFileSize(file.size),
                    status: 'uploading',
                    progress: 0
                };
                
                uploadedFiles.push(fileItem);
                renderUploadedFiles();
                updateValidationButton();
                
                // Simulate upload progress
                simulateUploadProgress(fileId);
            }
            
            function simulateUploadProgress(fileId) {
                let progress = 0;
                const interval = setInterval(() => {
                    progress += Math.random() * 20;
                    if (progress >= 100) {
                        progress = 100;
                        clearInterval(interval);
                        
                        // Update file status
                        const fileIndex = uploadedFiles.findIndex(f => f.id === fileId);
                        if (fileIndex !== -1) {
                            uploadedFiles[fileIndex].status = 'uploaded';
                            uploadedFiles[fileIndex].progress = 100;
                            renderUploadedFiles();
                        }
                        
                        // Check if all files uploaded
                        const allUploaded = uploadedFiles.every(f => f.status === 'uploaded');
                        if (allUploaded) {
                            showNotification('All files uploaded successfully!', 'success');
                        }
                    } else {
                        // Update progress
                        const fileIndex = uploadedFiles.findIndex(f => f.id === fileId);
                        if (fileIndex !== -1) {
                            uploadedFiles[fileIndex].progress = progress;
                            renderUploadedFiles();
                        }
                    }
                }, 200);
            }
            
            function renderUploadedFiles() {
                uploadedFilesDiv.innerHTML = '';
                fileCount.textContent = uploadedFiles.length;
                
                if (uploadedFiles.length === 0) {
                    uploadedFilesDiv.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>No files uploaded yet</p>
                        </div>
                    `;
                    return;
                }
                
                uploadedFiles.forEach(file => {
                    const fileDiv = document.createElement('div');
                    fileDiv.className = 'file-item';
                    fileDiv.innerHTML = `
                        <div class="file-info">
                            <i class="fas fa-file-excel file-icon"></i>
                            <div>
                                <div class="file-name">${file.name}</div>
                                <div class="file-size">${file.size}</div>
                            </div>
                        </div>
                        <div>
                            <span class="file-status ${file.status === 'uploaded' ? 'status-uploaded' : ''}">
                                ${file.status === 'uploaded' ? 'Ready' : 'Uploading...'}
                            </span>
                        </div>
                    `;
                    
                    if (file.status !== 'uploaded') {
                        const progressBar = document.createElement('div');
                        progressBar.className = 'progress-bar';
                        progressBar.style.marginTop = '8px';
                        progressBar.style.height = '4px';
                        const progressFill = document.createElement('div');
                        progressFill.className = 'progress-fill';
                        progressFill.style.width = `${file.progress}%`;
                        progressBar.appendChild(progressFill);
                        fileDiv.querySelector('.file-info').parentNode.insertBefore(
                            progressBar,
                            fileDiv.querySelector('.file-info').nextSibling
                        );
                    }
                    
                    uploadedFilesDiv.appendChild(fileDiv);
                });
            }
            
            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
            
            function updateValidationButton() {
                const hasUploadedFiles = uploadedFiles.some(f => f.status === 'uploaded');
                validateFilesBtn.disabled = !hasUploadedFiles;
                startDistributionBtn.disabled = true; // Reset until validation
            }
            
            // Sample data functionality
            loadSampleDataBtn.addEventListener('click', () => {
                loadSampleData();
            });
            
            function loadSampleData() {
                showNotification('Loading sample data...', 'info');
                
                // Generate sample data based on the provided structure
                sampleData = generateSampleData();
                
                // Process as validation results
                validationResults = processSampleData(sampleData);
                
                // Update UI
                updateValidationSummary();
                updateDataViews();
                updateAnalytics();
                
                // Enable distribution button
                startDistributionBtn.disabled = false;
                
                // Switch to validation tab
                document.querySelector('[data-tab="validation"]').click();
                
                showNotification('Sample data loaded successfully!', 'success');
            }
            
            function generateSampleData() {
                // Based on the provided sample data structure
                return [
                    {
                        "Site Category": "Dispatch",
                        "Customer Name": "Caterpillar",
                        "Partner Name": "Excis",
                        "Customer Ticket Number": "NA",
                        "Customer Ticket Created Date (MM/DD/YYYY)": "7/07/2025",
                        "Partner Ticket Number": "553418",
                        "Source of Request": "NA",
                        "PO number": "9200135149",
                        "Country": "Thailand",
                        "State": "Rayong",
                        "City": "Rayong",
                        "Site Address": "Common Site",
                        "Zip code": "NA",
                        "Activity Details": "Rayong || Thailand || HCL_CATERPILLAR || ETA: [07/07/2025], [08/07/2025], [09/07/2025] || P4 || Ban Khai UGM Need Backup tech",
                        "Dispatch Category": "NBD",
                        "Ticket Priority": "P4",
                        "ETA Date (MM/DD/YYYY)": "7/07/2025",
                        "ETA Time (HH:MM)": "NA",
                        "Technician Name": "NA",
                        "Technician IN Date (MM/DD/YYYY)": "7/07/2025",
                        "Technician IN Time": "7:30:00",
                        "Technician OUT Time": "17:00:00",
                        "Total Hours": "10",
                        "First Hour": "1714.56",
                        "First Hour rate": "1714.56",
                        "First Hour cost": "1714.56",
                        "Hours worked after First Hour": "1714.56",
                        "After First Hours rate": "NA",
                        "After First Hour cost": "NA",
                        "OT Hours": "NA",
                        "OT Hours rate": "NA",
                        "OT Hours Cost": "NA",
                        "Out of office Hours": "NA",
                        "Out of Office Hours Rate": "NA",
                        "Out of office Hours Cost": "NA",
                        "Weekened OT Hours": "NA",
                        "Weekend Rates": "NA",
                        "Weekend Cost": "NA",
                        "Travel/extra cost if applicable as per contract": "NA",
                        "Total Cost": "18002.88",
                        "Tax %": "NA",
                        "Tax cost": "NA",
                        "Total Cost including Tax": "NA",
                        "Currency": "THB",
                        "SLA Met": "Yes",
                        "Reason for SLA not met(if applicable)": "NA",
                        "CSR Report submitted": "Yes",
                        "Service Month (MM/YYYY)": "Nov-01",
                        "Remarks": ""
                    },
                    // Add more sample data rows as needed
                    {
                        "Site Category": "Dispatch",
                        "Customer Name": "Caterpillar",
                        "Partner Name": "Excis",
                        "Customer Ticket Number": "NA",
                        "Customer Ticket Created Date (MM/DD/YYYY)": "7/09/2025",
                        "Partner Ticket Number": "553418",
                        "Source of Request": "NA",
                        "PO number": "9200135149",
                        "Country": "Thailand",
                        "State": "Rayong",
                        "City": "Rayong",
                        "Site Address": "Common Site",
                        "Zip code": "NA",
                        "Activity Details": "Rayong || Thailand || HCL_CATERPILLAR || ETA: [07/07/2025], [08/07/2025], [09/07/2025] || P4 || Ban Khai UGM Need Backup tech",
                        "Dispatch Category": "NBD",
                        "Ticket Priority": "P4",
                        "ETA Date (MM/DD/YYYY)": "7/09/2025",
                        "ETA Time (HH:MM)": "NA",
                        "Technician Name": "NA",
                        "Technician IN Date (MM/DD/YYYY)": "7/09/2025",
                        "Technician IN Time": "8:00:00",
                        "Technician OUT Time": "16:30:00",
                        "Total Hours": "9",
                        "First Hour": "1714.56",
                        "First Hour rate": "1714.56",
                        "First Hour cost": "1714.56",
                        "Hours worked after First Hour": "1714.56",
                        "After First Hours rate": "NA",
                        "After First Hour cost": "NA",
                        "OT Hours": "NA",
                        "OT Hours rate": "NA",
                        "OT Hours Cost": "NA",
                        "Out of office Hours": "NA",
                        "Out of Office Hours Rate": "NA",
                        "Out of office Hours Cost": "NA",
                        "Weekened OT Hours": "NA",
                        "Weekend Rates": "NA",
                        "Weekend Cost": "NA",
                        "Travel/extra cost if applicable as per contract": "NA",
                        "Total Cost": "15431.04",
                        "Tax %": "NA",
                        "Tax cost": "NA",
                        "Total Cost including Tax": "NA",
                        "Currency": "THB",
                        "SLA Met": "Yes",
                        "Reason for SLA not met(if applicable)": "NA",
                        "CSR Report submitted": "Yes",
                        "Service Month (MM/YYYY)": "Nov-01",
                        "Remarks": ""
                    }
                ];
            }
            
            function processSampleData(data) {
                return data.map((item, index) => {
                    // Determine validation status based on data quality
                    let status = 'Valid';
                    let issues = 0;
                    
                    // Check for missing required fields
                    const requiredFields = ['Customer Name', 'Partner Name', 'Customer Ticket Created Date (MM/DD/YYYY)', 'Country', 'City'];
                    requiredFields.forEach(field => {
                        if (!item[field] || item[field] === 'NA' || item[field].trim() === '') {
                            issues++;
                            status = 'Warning';
                        }
                    });
                    
                    // Check for cost-related issues
                    if (item['Total Cost'] === 'NA' || parseFloat(item['Total Cost']) <= 0) {
                        issues++;
                        status = 'Error';
                    }
                    
                    return {
                        ...item,
                        id: `TICKET-${Date.now()}-${index}`,
                        status: status,
                        issues: issues,
                        region: getRegionFromCountry(item['Country'])
                    };
                });
            }
            
            function getRegionFromCountry(country) {
                const regionMap = {
                    'Thailand': 'APAC',
                    'Indonesia': 'APAC',
                    'USA': 'Americas',
                    'UK': 'Europe/Africa',
                    'Germany': 'Europe/Africa',
                    'UAE': 'Middle East'
                };
                return regionMap[country] || 'Other';
            }
            
            // Validation functionality
            validateFilesBtn.addEventListener('click', () => {
                if (uploadedFiles.some(f => f.status === 'uploaded')) {
                    runValidation();
                }
            });
            
            function runValidation() {
                showNotification('Starting validation process...', 'info');
                
                // Switch to validation tab
                document.querySelector('[data-tab="validation"]').click();
                
                // If no sample data loaded, use mock validation
                if (validationResults.length === 0) {
                    simulateValidation();
                } else {
                    // Use existing sample data
                    updateValidationSummary();
                    updateDataViews();
                    updateAnalytics();
                    
                    // Enable distribution button
                    startDistributionBtn.disabled = false;
                    
                    showNotification('Validation completed successfully!', 'success');
                }
            }
            
            function simulateValidation() {
                // Generate sample validation results
                validationResults = generateSampleValidationResults();
                
                // Update validation summary
                updateValidationSummary();
                
                // Update data views
                updateDataViews();
                
                // Update analytics
                updateAnalytics();
                
                // Enable distribution button
                startDistributionBtn.disabled = false;
                
                showNotification('Validation completed successfully!', 'success');
            }
            
            function generateSampleValidationResults() {
                const regions = ['Americas', 'Europe/Africa', 'APAC', 'Middle East'];
                const customers = ['HCL Corp', 'Tech Solutions', 'Global Systems', 'Enterprise IT'];
                const serviceTypes = ['Dispatch', 'Standby', 'Dedicated', 'Scheduled Visit'];
                
                const results = [];
                
                for (let i = 1; i <= 50; i++) {
                    const status = i <= 35 ? 'Valid' : (i <= 45 ? 'Warning' : 'Error');
                    const issueCount = status === 'Valid' ? 0 : (status === 'Warning' ? 1 : 2);
                    
                    results.push({
                        id: `TICKET-2024-${i.toString().padStart(3, '0')}`,
                        'Site Category': 'Dispatch',
                        'Customer Name': customers[i % customers.length],
                        'Partner Name': 'Partner ' + (i % 5 + 1),
                        'Customer Ticket Number': 'CT-' + (1000 + i),
                        'Customer Ticket Created Date (MM/DD/YYYY)': `01/${(i % 30 + 1).toString().padStart(2, '0')}/2024`,
                        'Country': ['USA', 'UK', 'Thailand', 'UAE'][i % 4],
                        'City': ['New York', 'London', 'Bangkok', 'Dubai'][i % 4],
                        'Total Cost': (500 + i * 100).toFixed(2),
                        'Currency': ['USD', 'GBP', 'THB', 'AED'][i % 4],
                        'SLA Met': i % 10 === 0 ? 'No' : 'Yes',
                        'CSR Report submitted': i % 20 === 0 ? 'No' : 'Yes',
                        region: regions[i % regions.length],
                        status: status,
                        issues: issueCount,
                        details: {
                            created: '2024-01-' + (15 + i % 15).toString().padStart(2, '0'),
                            priority: i % 3 === 0 ? 'P1' : (i % 3 === 1 ? 'P2' : 'P3'),
                            hours: (4 + i % 3) + ' hours'
                        }
                    });
                }
                
                return results;
            }
            
            function updateValidationSummary() {
                const validCount = validationResults.filter(r => r.status === 'Valid').length;
                const warningCount = validationResults.filter(r => r.status === 'Warning').length;
                const errorCount = validationResults.filter(r => r.status === 'Error').length;
                const totalCount = validationResults.length;
                
                document.getElementById('validCount').textContent = validCount;
                document.getElementById('warningCount').textContent = warningCount;
                document.getElementById('errorCount').textContent = errorCount;
                document.getElementById('totalCount').textContent = totalCount;
            }
            
            function updateDataViews() {
                updateTableView();
                if (currentView === 'form') {
                    updateFormView();
                }
            }
            
            function updateTableView() {
                const tableHeader = document.getElementById('tableHeader');
                const tableBody = document.getElementById('tableBody');
                
                // Clear existing content
                tableHeader.innerHTML = '';
                tableBody.innerHTML = '';
                
                if (validationResults.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="${columnDefinitions.length + 1}" style="text-align: center; padding: 40px;">
                                <div class="empty-state">
                                    <i class="fas fa-file-excel"></i>
                                    <p>Upload and validate files to see results</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                // Create table header
                const headerRow = document.createElement('tr');
                
                // Add ID column always visible
                const idHeader = document.createElement('th');
                idHeader.textContent = 'ID';
                idHeader.className = 'sortable';
                idHeader.setAttribute('data-column', 'id');
                idHeader.innerHTML = 'ID <span class="sort-icon">↕</span>';
                idHeader.addEventListener('click', () => sortTable('id'));
                headerRow.appendChild(idHeader);
                
                // Add other columns based on visibility
                columnDefinitions.forEach(column => {
                    if (columnVisibility[column.key] !== false) {
                        const th = document.createElement('th');
                        th.textContent = column.label;
                        th.className = 'sortable';
                        th.setAttribute('data-column', column.key);
                        th.innerHTML = `${column.label} <span class="sort-icon">↕</span>`;
                        th.addEventListener('click', () => sortTable(column.key));
                        headerRow.appendChild(th);
                    }
                });
                
                // Add status column always visible
                const statusHeader = document.createElement('th');
                statusHeader.textContent = 'Status';
                statusHeader.className = 'sortable';
                statusHeader.setAttribute('data-column', 'status');
                statusHeader.innerHTML = 'Status <span class="sort-icon">↕</span>';
                statusHeader.addEventListener('click', () => sortTable('status'));
                headerRow.appendChild(statusHeader);
                
                // Add actions column
                const actionsHeader = document.createElement('th');
                actionsHeader.textContent = 'Actions';
                headerRow.appendChild(actionsHeader);
                
                tableHeader.appendChild(headerRow);
                
                // Apply sorting
                let displayData = [...validationResults];
                if (sortColumn) {
                    displayData.sort((a, b) => {
                        let valA = a[sortColumn];
                        let valB = b[sortColumn];
                        
                        // Handle different data types
                        if (typeof valA === 'string') {
                            valA = valA.toLowerCase();
                            valB = valB.toLowerCase();
                        }
                        
                        if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
                        if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
                        return 0;
                    });
                }
                
                // Apply search filter
                const searchTerm = tableSearch.value.toLowerCase();
                if (searchTerm) {
                    displayData = displayData.filter(row => {
                        return Object.values(row).some(value => 
                            String(value).toLowerCase().includes(searchTerm)
                        );
                    });
                }
                
                // Calculate pagination
                const totalRows = displayData.length;
                totalPages = Math.ceil(totalRows / rowsPerPage);
                const startIndex = (currentPage - 1) * rowsPerPage;
                const endIndex = Math.min(startIndex + rowsPerPage, totalRows);
                const pageData = displayData.slice(startIndex, endIndex);
                
                // Create table rows
                pageData.forEach((row, rowIndex) => {
                    const tr = document.createElement('tr');
                    
                    // Add ID cell
                    const idCell = document.createElement('td');
                    idCell.innerHTML = `<strong>${row.id}</strong>`;
                    tr.appendChild(idCell);
                    
                    // Add other columns
                    columnDefinitions.forEach(column => {
                        if (columnVisibility[column.key] !== false) {
                            const td = document.createElement('td');
                            let value = row[column.key] || 'N/A';
                            
                            // Format based on column type
                            if (column.type === 'currency') {
                                value = formatCurrency(value, row['Currency']);
                            } else if (column.type === 'date') {
                                value = formatDate(value);
                            } else if (column.type === 'boolean') {
                                value = value === 'Yes' ? 
                                    '<span style="color: #48bb78;">✓ Yes</span>' : 
                                    '<span style="color: #f56565;">✗ No</span>';
                            }
                            
                            td.innerHTML = value;
                            tr.appendChild(td);
                        }
                    });
                    
                    // Add status cell
                    const statusCell = document.createElement('td');
                    let statusClass = '';
                    let statusText = row.status;
                    
                    if (row.status === 'Valid') {
                        statusClass = 'status-valid';
                        statusText = 'Valid';
                    } else if (row.status === 'Warning') {
                        statusClass = 'status-warning';
                        statusText = 'Warning';
                    } else {
                        statusClass = 'status-error';
                        statusText = 'Error';
                    }
                    
                    statusCell.innerHTML = `<span class="status-cell ${statusClass}">${statusText}</span>`;
                    tr.appendChild(statusCell);
                    
                    // Add actions cell
                    const actionsCell = document.createElement('td');
                    actionsCell.innerHTML = `
                        <button class="btn-icon-xs view-ticket-details" data-ticket-id="${row.id}" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                    `;
                    tr.appendChild(actionsCell);
                    
                    tableBody.appendChild(tr);
                });
                
                // Update pagination controls
                updatePagination(totalRows, startIndex, endIndex);
                
                // Add event listeners to view buttons
                document.querySelectorAll('.view-ticket-details').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const ticketId = e.currentTarget.getAttribute('data-ticket-id');
                        showTicketDetails(ticketId);
                    });
                });
                
                // Update sort indicators
                updateSortIndicators();
            }
            
            function updateSortIndicators() {
                // Remove existing sort classes
                document.querySelectorAll('.validation-table th').forEach(th => {
                    th.classList.remove('sort-asc', 'sort-desc');
                });
                
                // Add sort class to current sort column
                if (sortColumn) {
                    const header = document.querySelector(`.validation-table th[data-column="${sortColumn}"]`);
                    if (header) {
                        header.classList.add(sortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
                    }
                }
            }
            
            function sortTable(column) {
                if (sortColumn === column) {
                    // Toggle direction if same column
                    sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    // New column, default to ascending
                    sortColumn = column;
                    sortDirection = 'asc';
                }
                
                updateTableView();
            }
            
            function updatePagination(totalRows, startIndex, endIndex) {
                // Update pagination info
                document.getElementById('startRow').textContent = startIndex + 1;
                document.getElementById('endRow').textContent = endIndex;
                document.getElementById('totalRows').textContent = totalRows;
                
                // Update button states
                prevPageBtn.disabled = currentPage === 1;
                nextPageBtn.disabled = currentPage === totalPages;
                firstPageBtn.disabled = currentPage === 1;
                lastPageBtn.disabled = currentPage === totalPages;
                
                // Update page numbers
                pageNumbersDiv.innerHTML = '';
                
                // Always show first page
                addPageNumber(1);
                
                // Show ellipsis if needed
                if (currentPage > 3) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.style.padding = '0 8px';
                    pageNumbersDiv.appendChild(ellipsis);
                }
                
                // Show pages around current page
                const startPage = Math.max(2, currentPage - 1);
                const endPage = Math.min(totalPages - 1, currentPage + 1);
                
                for (let i = startPage; i <= endPage; i++) {
                    if (i > 1 && i < totalPages) {
                        addPageNumber(i);
                    }
                }
                
                // Show ellipsis if needed
                if (currentPage < totalPages - 2) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.style.padding = '0 8px';
                    pageNumbersDiv.appendChild(ellipsis);
                }
                
                // Always show last page if there is more than 1 page
                if (totalPages > 1) {
                    addPageNumber(totalPages);
                }
                
                function addPageNumber(page) {
                    const pageBtn = document.createElement('button');
                    pageBtn.className = 'page-number';
                    if (page === currentPage) {
                        pageBtn.classList.add('active');
                    }
                    pageBtn.textContent = page;
                    pageBtn.addEventListener('click', () => {
                        currentPage = page;
                        updateTableView();
                    });
                    pageNumbersDiv.appendChild(pageBtn);
                }
            }
            
            function updateFormView() {
                const ticketForm = document.getElementById('ticketForm');
                const currentTicketIndex = document.getElementById('currentTicketIndex');
                const totalTicketsForm = document.getElementById('totalTicketsForm');
                
                if (validationResults.length === 0) {
                    ticketForm.innerHTML = `
                        <div class="empty-state" style="text-align: center; padding: 40px;">
                            <i class="fas fa-file-excel"></i>
                            <p>Upload and validate files to see results</p>
                        </div>
                    `;
                    return;
                }
                
                // Update counters
                currentTicketIndex.textContent = currentFormIndex + 1;
                totalTicketsForm.textContent = validationResults.length;
                
                // Update navigation buttons
                prevTicketBtn.disabled = currentFormIndex === 0;
                nextTicketBtn.disabled = currentFormIndex === validationResults.length - 1;
                
                // Get current ticket
                const ticket = validationResults[currentFormIndex];
                
                // Build form HTML
                let formHTML = `
                    <div class="form-section">
                        <h4><i class="fas fa-info-circle"></i> Basic Information</h4>
                        <div class="form-grid">
                            <div class="form-field">
                                <label>Ticket ID</label>
                                <div class="field-value">${ticket.id}</div>
                            </div>
                            <div class="form-field">
                                <label>Status</label>
                                <div class="field-value">
                                    <span class="status-cell ${ticket.status === 'Valid' ? 'status-valid' : 
                                          ticket.status === 'Warning' ? 'status-warning' : 'status-error'}">
                                        ${ticket.status}
                                    </span>
                                </div>
                            </div>
                `;
                
                // Add basic info fields
                const basicFields = ['Customer Name', 'Partner Name', 'Country', 'City', 'Region'];
                basicFields.forEach(field => {
                    const value = ticket[field] || 'N/A';
                    formHTML += `
                        <div class="form-field">
                            <label>${field}</label>
                            <div class="field-value ${value === 'N/A' ? 'empty' : ''}">${value}</div>
                        </div>
                    `;
                });
                
                formHTML += `
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h4><i class="fas fa-calendar-alt"></i> Dates & Scheduling</h4>
                        <div class="form-grid">
                `;
                
                // Add date fields
                const dateFields = ['Customer Ticket Created Date (MM/DD/YYYY)', 'ETA Date (MM/DD/YYYY)', 'Technician IN Date (MM/DD/YYYY)'];
                dateFields.forEach(field => {
                    const value = ticket[field] || 'N/A';
                    formHTML += `
                        <div class="form-field">
                            <label>${field}</label>
                            <div class="field-value ${value === 'N/A' ? 'empty' : ''}">${formatDate(value)}</div>
                        </div>
                    `;
                });
                
                formHTML += `
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h4><i class="fas fa-dollar-sign"></i> Cost & Billing</h4>
                        <div class="form-grid">
                `;
                
                // Add cost fields
                const costFields = ['Total Cost', 'Currency', 'SLA Met', 'CSR Report submitted'];
                costFields.forEach(field => {
                    let value = ticket[field] || 'N/A';
                    
                    if (field === 'Total Cost') {
                        value = formatCurrency(value, ticket['Currency']);
                    } else if (field === 'SLA Met' || field === 'CSR Report submitted') {
                        value = value === 'Yes' ? 
                            '<span style="color: #48bb78;">✓ Yes</span>' : 
                            '<span style="color: #f56565;">✗ No</span>';
                    }
                    
                    formHTML += `
                        <div class="form-field">
                            <label>${field}</label>
                            <div class="field-value ${value === 'N/A' ? 'empty' : ''}">${value}</div>
                        </div>
                    `;
                });
                
                // Add remarks if available
                if (ticket['Remarks'] && ticket['Remarks'].trim() !== '') {
                    formHTML += `
                        <div class="form-section">
                            <h4><i class="fas fa-sticky-note"></i> Remarks</h4>
                            <div class="form-field">
                                <div class="field-value">${ticket['Remarks']}</div>
                            </div>
                        </div>
                    `;
                }
                
                // Add issues if any
                if (ticket.issues > 0) {
                    formHTML += `
                        <div class="form-section">
                            <h4><i class="fas fa-exclamation-triangle"></i> Validation Issues (${ticket.issues})</h4>
                            <div class="form-field">
                                <div class="field-value" style="background: #fff5f5; border-color: #fed7d7;">
                                    ${ticket.status === 'Warning' ? 
                                        'Missing supporting documentation' : 
                                        'Invalid PO number format, Missing mandatory fields'}
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                formHTML += `
                        </div>
                    </div>
                `;
                
                ticketForm.innerHTML = formHTML;
            }
            
            // Form navigation
            prevTicketBtn.addEventListener('click', () => {
                if (currentFormIndex > 0) {
                    currentFormIndex--;
                    updateFormView();
                }
            });
            
            nextTicketBtn.addEventListener('click', () => {
                if (currentFormIndex < validationResults.length - 1) {
                    currentFormIndex++;
                    updateFormView();
                }
            });
            
            // Pagination event listeners
            prevPageBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    updateTableView();
                }
            });
            
            nextPageBtn.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    updateTableView();
                }
            });
            
            firstPageBtn.addEventListener('click', () => {
                currentPage = 1;
                updateTableView();
            });
            
            lastPageBtn.addEventListener('click', () => {
                currentPage = totalPages;
                updateTableView();
            });
            
            rowsPerPageSelect.addEventListener('change', () => {
                rowsPerPage = parseInt(rowsPerPageSelect.value);
                currentPage = 1;
                updateTableView();
            });
            
            // Search functionality
            tableSearch.addEventListener('input', () => {
                currentPage = 1;
                updateTableView();
            });
            
            // Column configuration
            function initializeColumnDefinitions() {
                columnDefinitions = [
                    { key: 'Site Category', label: 'Site Category', category: 'basic', visible: true },
                    { key: 'Customer Name', label: 'Customer', category: 'basic', visible: true },
                    { key: 'Partner Name', label: 'Partner', category: 'basic', visible: true },
                    { key: 'Customer Ticket Number', label: 'Customer Ticket #', category: 'basic', visible: true },
                    { key: 'Country', label: 'Country', category: 'basic', visible: true },
                    { key: 'City', label: 'City', category: 'basic', visible: true },
                    { key: 'Customer Ticket Created Date (MM/DD/YYYY)', label: 'Created Date', category: 'date', type: 'date', visible: true },
                    { key: 'ETA Date (MM/DD/YYYY)', label: 'ETA Date', category: 'date', type: 'date', visible: false },
                    { key: 'Technician IN Date (MM/DD/YYYY)', label: 'Tech IN Date', category: 'date', type: 'date', visible: false },
                    { key: 'Total Hours', label: 'Total Hours', category: 'service', visible: false },
                    { key: 'Total Cost', label: 'Total Cost', category: 'cost', type: 'currency', visible: true },
                    { key: 'Currency', label: 'Currency', category: 'cost', visible: true },
                    { key: 'SLA Met', label: 'SLA Met', category: 'service', type: 'boolean', visible: true },
                    { key: 'CSR Report submitted', label: 'CSR Submitted', category: 'service', type: 'boolean', visible: true },
                    { key: 'Dispatch Category', label: 'Dispatch Type', category: 'service', visible: false },
                    { key: 'Ticket Priority', label: 'Priority', category: 'service', visible: false },
                    { key: 'PO number', label: 'PO Number', category: 'basic', visible: false },
                    { key: 'Activity Details', label: 'Activity Details', category: 'service', visible: false }
                ];
                
                // Initialize visibility settings
                columnDefinitions.forEach(column => {
                    columnVisibility[column.key] = column.visible;
                });
                
                // Render column configuration modal
                renderColumnConfig();
            }
            
            function renderColumnConfig() {
                const categories = {
                    basic: document.getElementById('basicColumns'),
                    date: document.getElementById('dateColumns'),
                    cost: document.getElementById('costColumns'),
                    service: document.getElementById('serviceColumns')
                };
                
                // Clear existing content
                Object.values(categories).forEach(container => {
                    container.innerHTML = '';
                });
                
                // Add columns to their categories
                columnDefinitions.forEach(column => {
                    const container = categories[column.category];
                    if (container) {
                        const item = document.createElement('div');
                        item.className = 'column-item';
                        item.innerHTML = `
                            <input type="checkbox" id="col-${column.key}" ${columnVisibility[column.key] ? 'checked' : ''}>
                            <label for="col-${column.key}">${column.label}</label>
                        `;
                        container.appendChild(item);
                        
                        // Add event listener
                        const checkbox = item.querySelector('input');
                        checkbox.addEventListener('change', () => {
                            columnVisibility[column.key] = checkbox.checked;
                        });
                    }
                });
            }
            
            columnToggleBtn.addEventListener('click', () => {
                columnConfigModal.style.display = 'flex';
            });
            
            closeColumnModal.addEventListener('click', () => {
                columnConfigModal.style.display = 'none';
            });
            
            resetColumnsBtn.addEventListener('click', () => {
                // Reset to default visibility
                columnDefinitions.forEach(column => {
                    columnVisibility[column.key] = column.visible;
                });
                renderColumnConfig();
            });
            
            applyColumnsBtn.addEventListener('click', () => {
                columnConfigModal.style.display = 'none';
                updateTableView();
            });
            
            // Close modal when clicking outside
            columnConfigModal.addEventListener('click', (e) => {
                if (e.target === columnConfigModal) {
                    columnConfigModal.style.display = 'none';
                }
            });
            
            // Helper functions
            function formatCurrency(value, currency) {
                if (!value || value === 'NA' || isNaN(parseFloat(value))) return 'N/A';
                
                const numValue = parseFloat(value);
                const currencySymbols = {
                    'USD': '$',
                    'EUR': '€',
                    'GBP': '£',
                    'THB': '฿',
                    'IDR': 'Rp',
                    'AED': 'AED '
                };
                
                const symbol = currencySymbols[currency] || '';
                return `${symbol}${numValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            }
            
            function formatDate(dateString) {
                if (!dateString || dateString === 'NA') return 'N/A';
                
                try {
                    const date = new Date(dateString);
                    if (isNaN(date.getTime())) return dateString;
                    
                    return date.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    });
                } catch (e) {
                    return dateString;
                }
            }
            
            // Rest of the existing functions (showTicketDetails, analytics, distribution, etc.)
            // ... (Keep all the existing functions from the original code)
            
            // Initialize empty state
            renderUploadedFiles();
            updateDataViews();
            
            // Load Chart.js if not already loaded
            if (typeof Chart === 'undefined') {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
                script.onload = initializeCharts;
                document.head.appendChild(script);
            }
            
            function initializeCharts() {
                // Chart initialization code from original
                // ... (Keep the chart initialization code)
            }
            
            function showNotification(message, type) {
                // Notification code from original
                // ... (Keep the notification code)
            }
        });
    </script>
</section>
<!-- END STEP 1 -->